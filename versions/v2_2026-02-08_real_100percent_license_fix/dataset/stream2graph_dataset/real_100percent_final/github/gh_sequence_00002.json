{
  "id": "gh_sequence_00002",
  "source": "github",
  "source_url": "https://github.com/sumsv50/cinema-reservation/blob/368d4732c5a459aa1686a4076af81cba1b3cebfb/sequenceDiagram.mmd",
  "github_repo": "sumsv50/cinema-reservation",
  "github_file_path": "sequenceDiagram.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant Client\n    participant API as Server API\n    participant DB as Database (PostgreSQL)\n    participant Redis\n\n    %% App Start\n    Note over Client, Redis: Sync existing reservations from the database to Redis on application startup\n    API ->> DB: Fetch all reservations for all cinemas\n    DB -->> API: Return reservation details\n    API ->> Redis: Store reservations using Redis pipeline\n    alt Redis storage successful  \n        Redis -->> API: OK  \n        API ->> API: Proceed to start application  \n    else Redis storage failed  \n        Redis -->> API: ERROR  \n        API ->> API: Abort application startup  \n    end\n\n    %% Configure Cinema Layout\n    Note over Client, Redis: 1. Configure Cinema Layout\n    Client->>API: POST /cinema/layout\n    API->>DB: Check if cinema name exists\n    DB-->>API: Return existence status\n    alt Cinema doesn't exist\n        API->>DB: Create cinema record\n        DB-->>API: Cinema created\n        API-->>Client: Success response with cinema data\n    else Cinema exists\n        API-->>Client: Error: Cinema already exists\n    end\n\n    %% Query Available Seats\n    Note over Client, Redis: 2. Query Available Seats\n    Client->>API: GET /cinema/{slug}/available?number_of_seats=N\n    API->>DB: Get cinema by slug\n    DB-->>API: Cinema details\n    API->>Redis: Get reserved seats (HGETALL cinema:ID:seats)\n    Redis-->>API: Reserved seats data\n    API->>API: Build heatmap & find safe blocks\n    API-->>Client: Available seat blocks\n\n    %% Check Available Seats\n    Note over Client, Redis: 3. Check Available Seats\n    Client->>API: POST /cinema/{slug}/check (with seat list)\n    API->>DB: Get cinema by slug\n    DB-->>API: Cinema details\n    API->>Redis: Get reserved seats (HGETALL cinema:ID:seats)\n    Redis-->>API: Reserved seats data\n    API->>API: Build heatmap & check specific seats\n    API-->>Client: Available seats from requested list\n\n    %% Reserve Seats\n    Note over Client, Redis: 4. Reserve Seats\n    Client->>API: POST /reservations (with cinema_slug & seats)\n    API->>DB: Get cinema by slug\n    DB-->>API: Cinema details\n    API->>API: Validate seat positions\n    API->>Redis: Execute Lua script for atomic reservation\n    Note over Redis: Lua script checks:<br/>- Seats not already taken<br/>- Social distancing rules<br/>- Reserves seats if valid\n    alt Reservation successful in Redis\n        Redis-->>API: \"OK\"\n        API->>DB: Create reservation record\n        DB-->>API: Reservation created\n        API-->>Client: Success with reservation data\n    else Reservation failed in Redis\n        Redis-->>API: Error (seats taken/distance violation)\n        API-->>Client: Error response\n    else DB creation failed\n        Redis-->>API: \"OK\"\n        API->>DB: Create reservation record\n        DB-->>API: Error\n        API->>Redis: Execute cancel Lua script (rollback)\n        Redis-->>API: Seats cancelled\n        API-->>Client: Error response\n    end\n\n    %% Cancel Reservation\n    Note over Client, Redis: 5. Cancel Reservation\n    Client->>API: POST /reservations/cancel (with cinema_slug & seats)\n    API->>DB: Get cinema by slug\n    DB-->>API: Cinema details\n    API->>API: Validate seat positions\n    API->>DB: Find reserved seats to cancel\n    DB-->>API: Reserved seat records\n    alt All seats are reserved\n        API->>DB: Soft delete reservation records\n        DB-->>API: Seats cancelled in DB\n        API->>Redis: Execute cancel Lua script\n        Redis-->>API: Seats removed from Redis\n        API-->>Client: Success response\n    else Some seats not reserved\n        API-->>Client: Error: Seats not reserved\n    end",
  "content_size": 3628,
  "collected_at": "2026-02-06T01:23:54.559146"
}