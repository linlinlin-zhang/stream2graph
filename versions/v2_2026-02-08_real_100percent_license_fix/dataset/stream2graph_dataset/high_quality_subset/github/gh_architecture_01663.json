{
  "id": "gh_architecture_01663",
  "source": "github",
  "source_url": "https://github.com/SamoraHunter/pat2vec/blob/498aba4e5cea9d85c1dae9379d573af7b2177b77/assets/main.mmd",
  "github_repo": "SamoraHunter/pat2vec",
  "github_file_path": "assets/main.mmd",
  "diagram_type": "architecture",
  "code": "graph TD\n    subgraph Title [pat2vec: Batch Data Fetching Logic]\n        style Title fill:#fff,stroke:#333,stroke-width:2px,font-size:20px,text-align:center\n        direction TB\n        T[\"File: pat2vec/patvec_get_batch_methods/main.py\"]\n    end\n\n    subgraph CoreLogic [\"Shared Logic for all get_pat_batch_* functions\"]\n        A[\"Start: Call get_pat_batch_... function\"] --> B[\"Get parameters from config_obj<br/>- Global date range<br/>- Paths<br/>- Caching flags (e.g., store_pat_batch_observations)\"];\n        B --> C[\"Construct target CSV path for patient's batch<br/>e.g., .../pre_bloods_batch_path/{patient_id}.csv\"];\n        C --> D{\"Batch CSV exists and not overwriting?\"};\n        D -- No --> F[\"Fetch data from Elasticsearch\"];\n        D -- Yes --> E[\"Read DataFrame from CSV\"];\n\n        F --> G{\"Store batch enabled?\"};\n        G -- Yes --> H[\"Save DataFrame to CSV\"];\n        G -- No --> I[\"Return DataFrame\"];\n        H --> I;\n        E --> I;\n    end\n\n    subgraph ElasticsearchQuery [\"Elasticsearch Query (Inside 'Fetch data' step)\"]\n        F --> F1[\"Call cohort_searcher_with_terms_and_search\"];\n        F1 --> F2[\"Provide:<br/>- index_name<br/>- fields_list<br/>- term_name (e.g., client_idcode.keyword)<br/>- patient_id<br/>- search_string\"];\n        F2 --> F3[\"search_string is built using specific filters and the global date range\"];\n    end\n\n    subgraph FunctionSpecifics [\"Function-Specific Elasticsearch Queries & Post-Processing\"]\n        direction LR\n\n        subgraph ObsGroup [\"Observations (obs, news, bmi)\"]\n            Obs_Index[\"<b>index:</b> observations\"]\n            Obs_Search[\"<b>search_string examples:</b><br/>- get_pat_batch_obs: 'obscatalogmasteritem_displayname:(&quot;{search_term}&quot;)'<br/>- get_pat_batch_news: '...:(&quot;NEWS&quot; OR &quot;NEWS2&quot;)'<br/>- get_pat_batch_bmi: '...:(&quot;OBS BMI&quot; OR &quot;OBS Weight&quot; OR &quot;OBS height&quot;)'\"]\n        end\n\n        subgraph BloodsGroup [\"get_pat_batch_bloods\"]\n            Bloods_Index[\"<b>index:</b> basic_observations\"]\n            Bloods_Search[\"<b>search_string:</b><br/>'basicobs_value_numeric:*'\"]\n            Bloods_Search --> Bloods_Filter[\"Apply fuzzy term &amp; data type filters\"]\n        end\n\n        subgraph OrdersGroup [\"Orders (drugs, diagnostics)\"]\n            Orders_Index[\"<b>index:</b> order\"]\n            Orders_Search[\"<b>search_string examples:</b><br/>- get_pat_batch_drugs: 'order_typecode:&quot;medication&quot;'<br/>- get_pat_batch_diagnostics: 'order_typecode:&quot;diagnostic&quot;'\"]\n        end\n\n        subgraph DocsGroup [\"Documents (epr, mct, textual_obs, reports)\"]\n            EPR_Index[\"<b>get_pat_batch_epr_docs</b><br/><b>index:</b> epr_documents<br/><b>post-processing:</b><br/>- Fuzzy/regex filters<br/>- Optional note splitting\"]\n            MCT_Index[\"<b>get_pat_batch_mct_docs</b><br/><b>index:</b> observations<br/><b>search:</b> 'AoMRC_ClinicalSummary_FT'<br/><b>post-processing:</b><br/>- Data type filters<br/>- Optional note splitting\"]\n            TextualObs_Index[\"<b>get_pat_batch_textual_obs_docs</b><br/><b>index:</b> basic_observations<br/><b>post-processing:</b><br/>- Drop empty textualObs<br/>- Create 'body_analysed'\"]\n            Reports_Index[\"<b>get_pat_batch_reports</b><br/><b>index:</b> basic_observations<br/><b>search:</b> 'basicobs_itemname_analysed:report'<br/><b>post-processing:</b><br/>- Create 'body_analysed'\"]\n        end\n\n        subgraph AnnotationsGroup [\"Annotation Logic (e.g., get_pat_batch_epr_docs_annotations)\"]\n            Annot_Start[\"Start\"] --> Annot_Check{\"Annotation batch exists?\"}\n            Annot_Check -- Yes --> Annot_Read[\"Read annotation CSV\"]\n            Annot_Check -- No --> Annot_Read_Doc[\"Read corresponding document batch CSV\"]\n            Annot_Read_Doc --> Annot_Process[\"Annotate with MedCAT<br/>(calls get_pat_document_annotation_batch_...)\"]\n            Annot_Process --> Annot_Save[\"Save annotation CSV\"]\n            Annot_Save --> Annot_Return[\"Return DataFrame\"]\n            Annot_Read --> Annot_Return\n        end\n\n        subgraph OtherGroup [\"Other Data Types\"]\n            Demo_Index[\"<b>get_pat_batch_demo</b><br/><b>index:</b> epr_documents\"]\n            Appt_Index[\"<b>get_pat_batch_appointments</b><br/><b>index:</b> pims_apps*\"]\n        end\n    end\n",
  "content_size": 4292,
  "collected_at": "2026-02-06T02:01:51.449893",
  "license": "none",
  "license_name": "No License",
  "compilation_status": "success",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license_url": "",
  "repo_stars": 2,
  "repo_forks": 0
}