{
  "id": "gh_flowchart_00186",
  "source": "github",
  "source_url": "https://github.com/edx/commerce-coordinator/blob/25bb739e9ccaba9407808c494cd3461172fd1fa3/docs/decisions/arch-diagrams/mobile-ecomm-architecture.mmd",
  "github_repo": "edx/commerce-coordinator",
  "github_file_path": "docs/decisions/arch-diagrams/mobile-ecomm-architecture.mmd",
  "diagram_type": "flowchart",
  "code": "flowchart TD\n    %% User and App\n    User[\"ðŸ‘¤ User\"] --> MobileApp[\"ðŸ“± Mobile App (iOS/Android)\"]\n    MobileApp --> CTBackend[\"CT Backend Server\"]\n\n    %% Customer Handling with Commercetools\n    CTBackend --> GetCustomer[\"Get CT customer by LMS user ID\"]\n    GetCustomer -->|Customer not found| CreateCustomer[\"Create customer with user info\"]\n    CreateCustomer --> CoCo\n    CoCo --> ReturnNewCustomer[\"Return newly created customer\"]\n    ReturnNewCustomer --> CTBackend\n\n    GetCustomer -->|Customer exists| UpdateCustomer[\"Update customer if needed\"]\n    UpdateCustomer --> CoCo\n    CoCo --> ReturnUpdatedCustomer[\"Return updated customer\"]\n    ReturnUpdatedCustomer --> CTBackend\n\n    %% Cart Flow\n    CTBackend --> CheckCart[\"Check if cart exists\"]\n    CheckCart -->|Exists| DeleteCart[\"Delete existing cart\"]\n    CheckCart -->|Not found| CreateCart[\"Create new cart with course & price\"]\n    CreateCart --> CoCo[\"Commercetools (CoCo)\"]\n\n    %% IAP Token Validation\n    CTBackend --> IAPValidator[\"Validate Token (IAPValidator)\"]\n    IAPValidator --> GooglePlay[\"Google Play\"]\n    IAPValidator --> AppleStore[\"Apple App Store\"]\n    IAPValidator --> CheckTokenReuse[\"Check if token already used\"]\n\n    CheckTokenReuse -->|Used| ErrorDuplicate[\"âŒ Duplicate token\"]\n    ErrorDuplicate --> DeleteCart --> MobileApp\n\n    CheckTokenReuse -->|Valid| ProceedPayment[\"Proceed with payment\"]\n\n    %% Payment Creation\n    ProceedPayment --> CreatePayment[\"Create Payment Object in CoCo\"]\n    CreatePayment --> UpdateCustomField[\"Add usdCentAmount (USD price)\"]\n    UpdateCustomField --> AttachPayment[\"Attach payment to cart\"]\n    AttachPayment -->|Fail| PaymentError[\"âŒ Payment attach failed\"]\n    PaymentError --> MobileApp\n\n    AttachPayment --> CreateOrder[\"Create Order from Cart\"]\n    CreateOrder -->|Fail| OrderFail[\"âŒ Order creation failed\"]\n    OrderFail --> MobileApp\n\n    CreateOrder --> UpdateItemStates[\"Mark items as ready for delivery\"]\n    UpdateItemStates -->|Fail| StateFail[\"âŒ State update failed\"]\n    StateFail --> MobileApp\n\n    UpdateItemStates --> FinalOrder[\"âœ… Order complete\"]\n    FinalOrder --> MobileApp\n\n    %% Events\n    CTBackend --> EventCheckout[\"Event: Checkout started\"]\n    CTBackend --> EventAddToCart[\"Event: Item added\"]\n    CTBackend --> EventPayment[\"Event: Payment used\"]\n    FinalOrder --> EventOrderComplete[\"Event: Order completed\"]\n\n    %% Refunds - Android (Manual via Admin or Mobile Trigger)\n    MobileApp --> AndroidRefund[\"Android Refund View\"]\n    Admin[\"ðŸ§‘â€ðŸ’¼ Admin\"] --> AndroidRefund\n    AndroidRefund --> GoogleVoided[\"Google Voided Purchases API\"]\n    AndroidRefund --> AndroidBridge[\"Send EventBridge Signal\"]\n    AndroidBridge --> CoCoordinator[\"Commerce Coordinator\"]\n    CoCoordinator --> RefundUpdateCT[\"Update refund status in CoCo\"]\n    RefundUpdateCT --> MobileApp\n\n    %% Refunds - iOS (Push from Apple)\n    AppleServer[\"ðŸŽ Apple Server\"] --> AppleNotification[\"Apple Refund Notification\"]\n    AppleNotification --> ParseNotif[\"Parse & verify notification\"]\n    ParseNotif --> CheckProcessed[\"Already processed?\"]\n    CheckProcessed -->|Yes| SkipNotif[\"Skip duplicate\"]\n    CheckProcessed -->|No| ExtractRefund[\"Extract refund info\"]\n    ExtractRefund --> AppleBridge[\"Send EventBridge Signal\"]\n    AppleBridge --> CoCoordinator\n    CoCoordinator --> RefundUpdateCTiOS[\"Update refund status in CoCo\"]\n    RefundUpdateCTiOS --> MobileApp\n\n    %% Styling\n    classDef logic fill:#fff8e1,stroke:#fdd835,stroke-width:1px;\n    classDef store fill:#e1f5fe,stroke:#4fc3f7,stroke-width:1px;\n    classDef error fill:#ffebee,stroke:#e57373,stroke-width:1px;\n    classDef event fill:#e8f5e9,stroke:#81c784,stroke-width:1px;\n\n    class CheckCart,DeleteCart,CreateCart,ProceedPayment,CreatePayment,UpdateCustomField,AttachPayment,CreateOrder,UpdateItemStates,FinalOrder,GetCustomer,CreateCustomer,UpdateCustomer logic;\n    class GooglePlay,AppleStore,GoogleVoided,AppleServer,CoCo store;\n    class ErrorDuplicate,PaymentError,OrderFail,StateFail,SkipNotif error;\n    class EventCheckout,EventAddToCart,EventPayment,EventOrderComplete,AndroidBridge,AppleBridge event;\n",
  "content_size": 4110,
  "collected_at": "2026-02-06T01:42:30.383608",
  "compilation_status": "success",
  "license": "agpl-3.0",
  "license_name": "GNU Affero General Public License v3.0",
  "license_url": "https://api.github.com/licenses/agpl-3.0",
  "repo_stars": 11,
  "repo_forks": 7,
  "repo_owner": "edx",
  "repo_name": "commerce-coordinator",
  "repo_description": "A controller to manage commerce workflows and services",
  "repo_language": "Python",
  "repo_topics": [],
  "repo_created_at": "2021-10-01T19:08:54Z",
  "repo_updated_at": "2026-01-14T15:27:30Z"
}