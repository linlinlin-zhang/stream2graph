{
  "id": "gh_sequence_00293",
  "source": "github",
  "source_url": "https://github.com/madkomdev/oauth2-demo/blob/75094e10240f7fb7e54896cd79ad25975deabb2d/flow.mmd",
  "github_repo": "madkomdev/oauth2-demo",
  "github_file_path": "flow.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant User as ðŸ‘¤ User/Browser\n    participant App as ðŸŒ Spring Boot App\n    participant Session as ðŸ—„ï¸ Session Store\n    participant Keycloak as ðŸ” Keycloak Server\n    participant API as ðŸ“¡ API Client\n\n    Note over User,API: WEB-BASED AUTHENTICATION FLOW (Session-Based)\n\n    User->>App: 1. GET /dashboard\n    App->>App: 2. Check Authentication\n    Note right of App: No session found\n    App->>User: 3. 302 Redirect to OAuth2 login\n\n    User->>App: 4. GET /oauth2/authorization/keycloak\n    App->>App: 5. Generate OAuth2 request + PKCE\n    App->>User: 6. 302 Redirect to Keycloak\n    Note right of App: Location: /realms/auth-demo-realm/protocol/<br/>openid-connect/auth?response_type=code<br/>&client_id=auth-demo-client&...\n\n    User->>Keycloak: 7. GET Authorization URL\n    Keycloak->>User: 8. Login Form\n\n    User->>Keycloak: 9. POST credentials (user/user123)\n    Keycloak->>Keycloak: 10. Validate Credentials\n    Keycloak->>Keycloak: 11. Generate Authorization Code\n    Keycloak->>User: 12. 302 Redirect with Auth Code\n    Note right of Keycloak: Location: /login/oauth2/code/keycloak<br/>?code=AUTH_CODE&state=STATE\n\n    User->>App: 13. GET /login/oauth2/code/keycloak?code=...\n    App->>Keycloak: 14. POST Token Exchange\n    Note right of App: grant_type=authorization_code<br/>code=AUTH_CODE<br/>client_secret=SECRET\n    Keycloak->>App: 15. Return Tokens (Access + Refresh + ID)\n\n    App->>App: 16. Create Spring Security Authentication\n    App->>Session: 17. Store OAuth2AuthorizedClient\n    Note right of Session: - SecurityContext<br/>- OAuth2AuthorizedClient<br/>- Access Token<br/>- Refresh Token\n    App->>App: 18. Create HTTP Session\n    App->>User: 19. Set-Cookie: JSESSIONID + 302 to /dashboard\n\n    User->>App: 20. GET /dashboard (with JSESSIONID)\n    App->>Session: 21. Load Session by JSESSIONID\n    Session->>App: 22. Return Authentication + Tokens\n    App->>App: 23. Populate SecurityContext\n    App->>User: 24. Return Dashboard HTML + Access Token\n\n    Note over User,API: API CALLS FROM WEB (Using Session-stored tokens)\n\n    User->>App: 25. XHR /api/user/profile (JSESSIONID cookie)\n    App->>Session: 26. Load OAuth2AuthorizedClient from Session\n    App->>App: 27. Check Token Expiration\n    alt Token Expired\n        App->>Keycloak: 28a. Refresh Token Request\n        Keycloak->>App: 28b. New Access Token\n        App->>Session: 28c. Update Session with New Token\n    end\n    App->>App: 29. Extract JWT + Validate + Create Authentication\n    App->>App: 30. Check @PreAuthorize(\"hasRole('USER')\")\n    App->>User: 31. Return JSON Response\n\n    Note over User,API: DIRECT API AUTHENTICATION FLOW (Stateless JWT)\n\n    API->>Keycloak: 32. POST /protocol/openid-connect/token\n    Note right of API: grant_type=password<br/>client_id=auth-demo-client<br/>username=user&password=user123\n    Keycloak->>Keycloak: 33. Validate Credentials\n    Keycloak->>API: 34. Return JWT Access Token\n\n    API->>App: 35. GET /api/user/profile\n    Note right of API: Authorization: Bearer eyJhbGciOiJSUzI1NiIs...\n\n    App->>App: 36. Extract JWT from Authorization Header\n    App->>Keycloak: 37. Validate JWT Signature (via JWK Set)\n    Keycloak->>App: 38. JWT Valid + Public Key\n    App->>App: 39. Extract Claims (sub, roles, exp, etc.)\n    App->>App: 40. Create JwtAuthenticationToken\n    App->>App: 41. Check @PreAuthorize(\"hasRole('USER')\")\n    App->>API: 42. Return JSON Response\n\n    Note over User,API: LOGOUT FLOWS\n\n    User->>App: 43. POST /logout (Web Session)\n    App->>Session: 44. Invalidate Session\n    App->>User: 45. Delete JSESSIONID Cookie + Redirect to /\n\n    API->>Keycloak: 46. POST /protocol/openid-connect/logout (API)\n    Note right of API: refresh_token=...\n    Keycloak->>API: 47. Token Revoked",
  "content_size": 3745,
  "collected_at": "2026-02-06T01:30:18.772297",
  "compilation_status": "success",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "madkomdev",
  "repo_name": "oauth2-demo",
  "repo_description": "A comprehensive Spring Boot application demonstrating OAuth2 authentication and authorization using Keycloak as the OpenID Connect provider. This project showcases production-ready patterns for JWT-ba",
  "repo_language": "HTML",
  "repo_topics": [],
  "repo_created_at": "2025-09-14T15:13:02Z",
  "repo_updated_at": "2025-09-14T15:26:47Z"
}