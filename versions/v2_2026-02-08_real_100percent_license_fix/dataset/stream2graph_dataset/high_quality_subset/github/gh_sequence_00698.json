{
  "id": "gh_sequence_00698",
  "source": "github",
  "source_url": "https://github.com/RajdeepSah/BlockBallot/blob/012f60aecadd761dba2aa60d8c8bd0585e6b0785/diagrams/auth-flow.mmd",
  "github_repo": "RajdeepSah/BlockBallot",
  "github_file_path": "diagrams/auth-flow.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant User\n    participant SignIn\n    participant AuthContext\n    participant LoginAPI\n    participant SupabaseAuth\n    participant KVStore\n    participant Verify2FA\n    participant VerifyOTP\n    participant MeAPI\n    \n    Note over User,MeAPI: Login Flow with 2FA\n    \n    User->>SignIn: Enter email/password\n    SignIn->>AuthContext: login(email, password)\n    AuthContext->>LoginAPI: POST /api/auth/login\n    LoginAPI->>SupabaseAuth: signInWithPassword()\n    SupabaseAuth-->>LoginAPI: Session + User\n    LoginAPI->>KVStore: Get user data (user:{userId})\n    KVStore-->>LoginAPI: User record\n    LoginAPI->>KVStore: Store OTP (otp:{userId})\n    Note over LoginAPI,KVStore: Plain-text OTP storage:<br/>{otp, userId, created_at, expires_at, verified}\n    LoginAPI-->>AuthContext: requires2FA: true, accessToken, refreshToken, devOTP\n    AuthContext->>AuthContext: Store tempToken in localStorage\n    AuthContext-->>SignIn: 2FA required\n    SignIn->>User: Show 2FA form\n    \n    User->>Verify2FA: Enter OTP\n    Verify2FA->>AuthContext: verify2FA(otp)\n    AuthContext->>VerifyOTP: POST /api/verify-otp {email, otp}\n    Note over VerifyOTP,KVStore: KNOWN ISSUE: verify-otp expects<br/>otp:{email} with hashed OTP,<br/>but login stored at otp:{userId}<br/>with plain-text OTP\n    VerifyOTP->>KVStore: Get OTP record (otp:{email})\n    alt OTP Found (send-otp flow)\n        VerifyOTP->>VerifyOTP: Verify OTP hash with timing-safe compare\n        VerifyOTP->>KVStore: Delete OTP record\n        VerifyOTP-->>Verify2FA: Success\n    else OTP Not Found (login flow mismatch)\n        VerifyOTP-->>Verify2FA: 404 - No active verification request\n    end\n    \n    Verify2FA->>AuthContext: Get tempToken from localStorage\n    Verify2FA->>MeAPI: GET /api/auth/me (with tempToken)\n    MeAPI->>KVStore: Get user data\n    KVStore-->>MeAPI: User record\n    MeAPI-->>Verify2FA: User data\n    Verify2FA->>AuthContext: Store token & user in localStorage\n    AuthContext-->>User: Authenticated\n",
  "content_size": 1996,
  "collected_at": "2026-02-06T01:35:49.843854",
  "compilation_status": "success",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "RajdeepSah",
  "repo_name": "BlockBallot",
  "repo_description": "BlockBallot is a modern, secure, and user-friendly digital voting platform designed to bring trust and simplicity to elections. Built with a focus on accessibility, transparency, and real-world reliab",
  "repo_language": "TypeScript",
  "repo_topics": [],
  "repo_created_at": "2025-10-16T20:51:31Z",
  "repo_updated_at": "2025-12-06T04:37:26Z"
}