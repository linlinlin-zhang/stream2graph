{
  "id": "gh_sequence_00470",
  "source": "github",
  "source_url": "https://github.com/panchorange/diet-linebot/blob/22d1310650c18a02f60e21e5426f73c24ff9863f/docs/sequence/weekly-report.mmd",
  "github_repo": "panchorange/diet-linebot",
  "github_file_path": "docs/sequence/weekly-report.mmd",
  "diagram_type": "sequence",
  "code": "%% 週次レポート配信フロー（体重・食事・運動 全観点） - SequenceDiagram\nsequenceDiagram\n    autonumber\n    participant CRON as Weekly Scheduler\n    participant WRS as WeeklyReportService\n    participant DB as PostgreSQL(DB)\n    participant LLM as LLM(Gemini)\n    participant LC as LINE Client\n    participant LINE as LINE Platform\n    actor User as ユーザー\n\n    Note over CRON: 毎週 日曜20:00（JST）に起動　または 週次レポートとユーザーが投稿\n\n    CRON->>DB: findMany users(id, lineUserId)\n    DB-->>CRON: users[]\n\n    loop 各ユーザーごと\n        Note over CRON: 週次レポート対象期間（start, end）を計算\n        CRON->>CRON: start = baseTime（日曜20:00の場合は前週の日曜20:00）\n        CRON->>CRON: end = baseTime（レポート送信日時）\n        CRON->>WRS: generateWeeklyReport(userId, baseTime)\n\n        %% データ取得（直近1週間）\n        WRS->>DB: weight_records.findMany(userId, start..end)\n        DB-->>WRS: weights[]\n        WRS->>DB: meal_records.findMany(userId, start..end)\n        DB-->>WRS: meals[]\n        WRS->>DB: exercise_records.findMany(userId, start..end)\n        DB-->>WRS: exercises[]\n\n        %% サマリ作成\n        WRS->>WRS: グラフ: 体重とBMIの推移\n        WRS->>WRS: 食事サマリ: 総摂取カロリー、平均摂取カロリー、平均PFC(それぞれ)\n        WRS->>WRS: 運動サマリ: 運動時間、消費カロリー、運動回数、最も多く行った運動\n        WRS->>WRS: 体重サマリ: 前週からの体重増減量、開始時からの体重増減、今週の記録日数\n\n        %% LLM解析（3観点）\n        WRS->>LLM: サマリから以下を分析(体重が順調に減っているか？運動に関する良いところ、悪いところ、食事に関する良いところ、悪いところ)\n        LLM-->>WRS: { message }\n\n        %% 送信\n        Note over WRS: レポートメッセージを作成(サマリ + LLMの分析結果)\n        WRS-->>CRON: message\n        CRON->>LC: pushMessage(lineUserId, message)\n        LC-->>LINE: push\n        LINE-->>User: 受信表示\n    end\n\n\n",
  "content_size": 1552,
  "collected_at": "2026-02-06T01:32:46.762335",
  "compilation_status": "success",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "panchorange",
  "repo_name": "diet-linebot",
  "repo_description": "ダイエット継続を目的としたLINEbot",
  "repo_language": "TypeScript",
  "repo_topics": [],
  "repo_created_at": "2025-07-21T12:15:18Z",
  "repo_updated_at": "2025-10-04T07:07:23Z"
}