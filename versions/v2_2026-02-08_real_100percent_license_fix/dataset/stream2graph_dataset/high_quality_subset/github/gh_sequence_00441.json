{
  "id": "gh_sequence_00441",
  "source": "github",
  "source_url": "https://github.com/FediMechergui/THEA/blob/4bcbb5c62114d1a0ccc9791b39daaca14d28fe85/documentation/sprint1/diagrams/THEA_API_Request_Processing_Sequence_Diagram.mmd",
  "github_repo": "FediMechergui/THEA",
  "github_file_path": "documentation/sprint1/diagrams/THEA_API_Request_Processing_Sequence_Diagram.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant Client\n    participant Express\n    participant RateLimiter\n    participant RequestLogger\n    participant CORSMiddleware\n    participant HelmetMiddleware\n    participant RouteHandler\n    participant AuthMiddleware\n    participant BusinessLogic\n    participant Database\n    participant ExternalServices\n    participant ErrorHandler\n    participant ResponseLogger\n\n    %% API Request Processing Flow\n    rect rgb(240, 255, 248)\n        Note over Client, ResponseLogger: Complete API Request Processing Flow\n\n        %% Initial Request Handling\n        Client->>Express: HTTP Request (GET/POST/PUT/DELETE)\n        Express->>RateLimiter: check rate limit\n        RateLimiter->>RateLimiter: validate request count\n        alt Rate limit exceeded\n            RateLimiter-->>Client: 429 Too Many Requests\n        else Within limits\n            RateLimiter->>Express: proceed\n        end\n\n        Express->>RequestLogger: log incoming request\n        RequestLogger->>RequestLogger: format and log request details\n        RequestLogger->>Express: proceed\n\n        Express->>CORSMiddleware: check CORS policy\n        CORSMiddleware->>CORSMiddleware: validate origin & headers\n        alt CORS violation\n            CORSMiddleware-->>Client: CORS error\n        else CORS allowed\n            CORSMiddleware->>Express: proceed\n        end\n\n        Express->>HelmetMiddleware: apply security headers\n        HelmetMiddleware->>HelmetMiddleware: set security headers\n        HelmetMiddleware->>Express: proceed\n\n        %% Route Matching\n        Express->>RouteHandler: match route pattern\n        alt Route not found\n            Express->>ErrorHandler: 404 Not Found\n            ErrorHandler-->>Client: 404 response\n        else Route found\n            RouteHandler->>Express: proceed to route\n        end\n\n        %% Authentication & Authorization\n        Express->>AuthMiddleware: check authentication\n        alt Requires auth\n            AuthMiddleware->>AuthMiddleware: extract JWT token\n            AuthMiddleware->>AuthMiddleware: verify token signature\n            alt Invalid token\n                AuthMiddleware->>ErrorHandler: 401 Unauthorized\n                ErrorHandler-->>Client: 401 response\n            else Valid token\n                AuthMiddleware->>Database: fetch user data\n                Database-->>AuthMiddleware: user & enterprise data\n                alt User not found\n                    AuthMiddleware->>ErrorHandler: 401 Unauthorized\n                else User valid\n                    AuthMiddleware->>AuthMiddleware: check role permissions\n                    alt Insufficient permissions\n                        AuthMiddleware->>ErrorHandler: 403 Forbidden\n                    else Authorized\n                        AuthMiddleware->>Express: add user to request\n                    end\n                end\n            end\n        else Public route\n            AuthMiddleware->>Express: proceed (no auth required)\n        end\n\n        %% Business Logic Processing\n        Express->>BusinessLogic: execute route handler\n        BusinessLogic->>BusinessLogic: validate request data\n        alt Validation failed\n            BusinessLogic->>ErrorHandler: 400 Bad Request\n            ErrorHandler-->>Client: validation errors\n        else Validation passed\n            BusinessLogic->>Database: perform database operations\n            Database-->>BusinessLogic: query results\n\n            alt Requires external services\n                BusinessLogic->>ExternalServices: call Redis/MinIO/RabbitMQ\n                ExternalServices-->>BusinessLogic: service response\n            end\n\n            BusinessLogic->>BusinessLogic: process business logic\n            BusinessLogic->>Database: save/update data\n            Database-->>BusinessLogic: operation result\n        end\n\n        %% Response Generation\n        BusinessLogic->>Express: return response data\n        Express->>ResponseLogger: log response\n        ResponseLogger->>ResponseLogger: format and log response details\n        ResponseLogger->>Express: proceed\n\n        Express->>Client: HTTP Response (200/201/204 etc.)\n    end\n\n    %% Error Handling Flow\n    rect rgb(255, 240, 248)\n        Note over BusinessLogic, Client: Error Handling Flow\n        BusinessLogic->>ErrorHandler: throw/catch error\n        ErrorHandler->>ErrorHandler: determine error type\n        ErrorHandler->>ErrorHandler: format error response\n        alt Operational error\n            ErrorHandler->>ErrorHandler: log error details\n            ErrorHandler-->>Client: appropriate HTTP status + error message\n        else Programmer error\n            ErrorHandler->>ErrorHandler: log full stack trace\n            ErrorHandler-->>Client: 500 Internal Server Error\n        end\n    end\n\n    %% Health Check Flow\n    rect rgb(248, 255, 240)\n        Note over Client, Express: Health Check Flow\n        Client->>Express: GET /health\n        Express->>Express: bypass rate limiting (health endpoint)\n        Express->>RequestLogger: log health check\n        Express->>Express: generate health response\n        Express->>ResponseLogger: log health response\n        Express-->>Client: 200 OK + health data\n    end",
  "content_size": 5185,
  "collected_at": "2026-02-06T01:32:20.341229",
  "compilation_status": "success",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "FediMechergui",
  "repo_name": "THEA",
  "repo_description": "The Entire THEA BACKEND",
  "repo_language": "JavaScript",
  "repo_topics": [],
  "repo_created_at": "2025-09-14T15:33:42Z",
  "repo_updated_at": "2025-10-15T00:49:26Z"
}