{
  "id": "gh_sequence_00814",
  "source": "github",
  "source_url": "https://github.com/filecoin-project/specs/blob/a95002835b34d4042c007feda3fecf5e68e79dfa/content/systems/filecoin_markets/storage_market/storage_market_flow.mmd",
  "github_repo": "filecoin-project/specs",
  "github_file_path": "content/systems/filecoin_markets/storage_market/storage_market_flow.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n  participant StorageClient\n  participant DT as Data Transfer\n  participant StorageProvider\n  participant Node\n  participant SMA as StorageMarketActor\n  participant SMS as Storage Mining Subsystem\n\n  rect rgb(240, 250, 190)\n    Note over StorageClient, SMS: Discovery\n    rect rgb(210, 145, 188)\n      Note over StorageClient, Node: Discovering Miners\n      StorageClient ->>+ Node: List Miner Actors from chain state\n      Node -->>- StorageClient: List of Miner Actors\n      loop Each Miner Actor\n      StorageClient ->>+ Node: Query actor properties from chain state\n      Node -->>- StorageClient: Miner actor properties from chain state\n      end\n    end\n\n    rect rgb(254, 200, 216)\n      Note over StorageClient, StorageProvider: Querying For Asks\n      loop each StorageProvider\n      StorageClient ->>+ StorageProvider: Send Query For Current Ask\n      StorageProvider -->>- StorageClient: Current Storage Ask\n      end\n    end\n  end\n  rect rgb(250, 240, 190)\n    Note over StorageClient, SMS: Negotiation\n  rect rgb(224, 187, 228)\n    Note over StorageClient, SMA: Proposing a deal\n    StorageClient ->>+ SMA: Add funds for a deal as neccesary\n    SMA -->>- StorageClient: Funds added\n    StorageClient ->> StorageClient: Calculate piece commitment\n    StorageClient ->>+ StorageProvider: Propose a deal\n  end\n\n  rect rgb(255, 223, 211)\n    Note over StorageClient, SMA: Verifying a deal\n    activate StorageProvider\n    StorageProvider ->> StorageProvider: Verify deal parameters (price, size, etc)\n    StorageProvider ->>+ SMA: Check StorageClient balance\n    SMA -->>- StorageProvider: Client balance\n    StorageProvider ->> StorageProvider: Verify balance greater that total storage price\n    StorageProvider -->>- StorageClient: Indicate Intent To Accept Deal\n  end\n\n  rect rgb(210, 145, 188)\n    Note over StorageClient, StorageProvider: Transferring Data\n    StorageClient ->>+ DT: Open push request to client\n    DT ->>+ StorageProvider: Send push request to provider\n    StorageProvider -->> DT: Accept and request data\n    DT -->>+ StorageClient: Send request for data\n    StorageClient -->> StorageProvider: Send Data\n    StorageClient ->>- DT: Finished Sending Data\n    DT ->>- StorageProvider: Notify data transfer complete\n    StorageProvider ->> StorageProvider: Verify data matches piece commitment\n  end\n\n  rect rgb(254, 200, 216)\n    Note over StorageProvider, SMA: Ensuring Collateral\n    StorageProvider ->>+ SMA: Add collateral for deal as needed\n    SMA -->>- StorageProvider: Collateral added\n  end\n  end\n  rect rgb(240, 250, 190)\n    Note over StorageClient, SMS: Publishing\n  rect rgb(224, 187, 228)\n    Note over StorageClient, SMA: Putting Deal On Chain\n    StorageProvider ->> StorageProvider: Sign Deal Proposal\n    StorageProvider ->>+ SMA: Publish Deal On Chain\n    StorageProvider -->> StorageClient: Deal Accepted (w/ Publish Message CID)\n    SMA -->>- StorageProvider: Deal Published\n    deactivate StorageProvider\n  end\n\n  rect rgb(210, 145, 188)\n    Note over StorageClient, SMA: Verify Deal Published\n    StorageClient ->>+ Node: Verify Publish Message Appears On Chain\n    Node -->>- StorageClient: Deal Published\n  end\n  end\n\n  rect rgb(250, 240, 190)\n    Note over StorageClient, SMS: Handoff\n  rect rgb(210, 145, 188)\n    Note over StorageProvider, SMS: StorageMiner Handoff And Sealing\n    StorageProvider ->>+ SMS: Add Piece\n    Note left of SMS: Storage Miner <br/> adds piece to sector <br/> precommits,<br/> seals sector, <br/> activates deal <br/> See Storage Mining <br/> Subsystem <br>for more detail\n  end\n  end",
  "content_size": 3587,
  "collected_at": "2026-02-06T01:37:25.283242",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License (Assumed)",
  "license_url": null,
  "repo_stars": 366,
  "repo_forks": 167,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}