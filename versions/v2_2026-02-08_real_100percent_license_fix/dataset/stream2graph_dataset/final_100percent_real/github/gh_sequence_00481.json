{
  "id": "gh_sequence_00481",
  "source": "github",
  "source_url": "https://github.com/HonoraryIndians/axon/blob/a9f706c1df9fbed67940bfc2db02938aac0907bb/mermaid/ok/sequence-fcfs-batch.mmd",
  "github_repo": "HonoraryIndians/axon",
  "github_file_path": "mermaid/ok/sequence-fcfs-batch.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    autonumber\n    participant Entry as Entry 서버\n    participant Kafka as 카프카 (대기열)\n    participant Consumer as Core 서버 (소비자)\n    participant Buffer as 메모리 버퍼 (ConcurrentLinkedQueue)\n    participant Strategy as 선착순 로직 (FirstComeFirstServeStrategy)\n    participant MySQL as DB (최종 저장)\n\n    Note over Entry,MySQL: 사용자가 선착순에 당첨된 직후 상황\n\n    loop 수많은 사용자가 동시 당첨\n        Entry->>Kafka: 당첨 티켓 발행 (Produce Message)\n        Note right of Kafka: \"누가(User), 무엇을(Item)<br/>언제(Time) 당첨됐나\"\n    end\n\n    Note over Consumer,Buffer: Core 서버는 자신의 속도대로 처리 (Backpressure)\n\n    activate Consumer\n    Consumer->>Kafka: 메시지 뭉치 가져오기 (Poll Messages)\n    Kafka-->>Consumer: 메시지 다발 보내기\n\n    loop 내부 버퍼링 (Add to Buffer)\n        Consumer->>Buffer: 임시 저장 (메모리)\n    end\n\n    Consumer->>Consumer: 처리 조건 확인 (Check Flush Condition)\n    Note right of Consumer: 1. 20개가 모였거나<br/>2. 0.1초가 지났으면<br/>-> DB에 저장하러 간다\n\n    alt 조건 충족 (Flush Condition Met)\n        Consumer->>Buffer: 메시지 모두 꺼내기 (Drain All Messages)\n\n        Consumer->>Strategy: processBatch(messages)\n        activate Strategy\n\n        Strategy->>Strategy: 중복 제거 (Deduplicate by activityId:userId)\n        Note right of Strategy: 혹시 모를 중복 요청 걸러냄<br/>(멱등성 보장)\n\n        Strategy->>MySQL: 한 번에 저장 (Bulk Upsert)\n        Note right of MySQL: INSERT INTO CampaignActivityEntry<br/>ON DUPLICATE KEY UPDATE<br/>(원자성 보장)\n\n        MySQL-->>Strategy: 저장 완료 (Affected Rows)\n        deactivate Strategy\n\n        Consumer->>MySQL: 트랜잭션 커밋 (Commit Transaction)\n    end\n\n    deactivate Consumer",
  "content_size": 1518,
  "collected_at": "2026-02-06T01:32:54.234851",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 6,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}