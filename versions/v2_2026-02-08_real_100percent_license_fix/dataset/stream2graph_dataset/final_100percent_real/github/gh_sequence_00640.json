{
  "id": "gh_sequence_00640",
  "source": "github",
  "source_url": "https://github.com/zone17/sovren/blob/d3da3358e52da6ae6b2365e89401eca50f337a0c/docs/architecture/diagrams/nostr/nostr-event-publishing-flow.mmd",
  "github_repo": "zone17/sovren",
  "github_file_path": "docs/architecture/diagrams/nostr/nostr-event-publishing-flow.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    %% NOSTR Event Publishing Flow - Sovren Platform\n    %% Complete lifecycle from event creation to multi-relay broadcasting\n\n    participant Creator as Content Creator\n    participant UI as Content Editor UI\n    participant Validator as Event Validator\n    participant Signer as Signing Service\n    participant KMS as Key Management\n    participant Publisher as Event Publisher\n    participant Pool as Relay Pool\n    participant R1 as Relay 1<br/>(relay.damus.io)\n    participant R2 as Relay 2<br/>(relay.nostr.band)\n    participant R3 as Relay 3<br/>(nos.lol)\n\n    %% Event Creation Phase\n    rect rgb(240, 248, 255)\n        Note over Creator,Pool: Event Creation Phase\n        Creator->>UI: Create Content\n        UI->>UI: Compose Event Data\n\n        Note right of UI: Event Types:<br/>• kind 1: Text Note<br/>• kind 3: Contact List<br/>• kind 4: Encrypted DM<br/>• kind 30023: Long-form<br/>• kind 30078: App Data\n\n        UI->>Validator: validateEventData(draft)\n\n        Validator->>Validator: Check Required Fields\n        Note right of Validator: Required:<br/>• content<br/>• kind<br/>• tags (optional)\n\n        Validator->>Validator: Validate Content Length\n        alt Content Too Long\n            Validator-->>UI: Validation Error\n            UI->>Creator: Show Error Message\n        end\n\n        Validator->>Validator: Sanitize Content\n        Note right of Validator: Remove XSS vectors,<br/>validate URLs,<br/>check markdown\n\n        Validator->>Validator: Process Tags\n        Note right of Validator: Tags:<br/>• e (event refs)<br/>• p (pubkey refs)<br/>• t (hashtags)<br/>• d (identifiers)\n\n        Validator-->>UI: Validation Passed\n    end\n\n    %% Event Signing Phase\n    rect rgb(240, 255, 240)\n        Note over Creator,Pool: Event Signing Phase\n        UI->>Signer: signEvent(eventData)\n\n        Signer->>KMS: Get Active Key\n        KMS-->>Signer: Public Key\n\n        Signer->>Signer: Build Event Object\n        Note right of Signer: {<br/>  kind: number<br/>  content: string<br/>  tags: array<br/>  created_at: timestamp<br/>  pubkey: hex<br/>}\n\n        Signer->>Signer: Calculate Event ID\n        Note right of Signer: SHA256 hash of<br/>serialized event\n\n        Signer->>KMS: Sign Event Hash\n        Note right of KMS: Schnorr signature<br/>using secp256k1\n\n        alt Using Browser Extension\n            KMS->>Creator: Request Signature Approval\n            Creator->>KMS: Approve\n            KMS->>KMS: Sign via Extension\n        else Using Stored Key\n            KMS->>KMS: Decrypt Private Key\n            KMS->>KMS: Sign Event\n            KMS->>KMS: Clear Key from Memory\n        end\n\n        KMS-->>Signer: Signature (hex)\n\n        Signer->>Signer: Attach Signature\n        Signer->>Signer: Verify Signature\n        Note right of Signer: Validate signature<br/>matches event ID\n\n        alt Signature Invalid\n            Signer-->>UI: Signature Error\n            UI->>Creator: Show Error\n        end\n\n        Signer-->>UI: Signed Event Ready\n    end\n\n    %% Publishing Phase\n    rect rgb(255, 250, 240)\n        Note over Creator,Pool: Multi-Relay Publishing Phase\n        UI->>Publisher: publishEvent(signedEvent)\n\n        Publisher->>Pool: Get Connected Relays\n        Pool-->>Publisher: Relay List (3+ relays)\n\n        Publisher->>Publisher: Create Publish Promises\n        Note right of Publisher: Parallel publishing<br/>to all relays\n\n        %% Parallel publishing\n        par Publish to Relay 1\n            Publisher->>R1: EVENT message\n            Note right of R1: [\"EVENT\", {...}]\n            R1->>R1: Validate Event\n            R1->>R1: Store Event\n            R1-->>Publisher: OK message\n            Note left of R1: [\"OK\", event_id,<br/> true, \"\"]\n        and Publish to Relay 2\n            Publisher->>R2: EVENT message\n            R2->>R2: Validate Event\n            R2->>R2: Store Event\n            R2-->>Publisher: OK message\n        and Publish to Relay 3\n            Publisher->>R3: EVENT message\n            R3->>R3: Validate Event\n            R3->>R3: Check Rate Limits\n            alt Rate Limited\n                R3-->>Publisher: ERROR message\n                Note left of R3: [\"OK\", event_id,<br/> false, \"rate-limited\"]\n            else Success\n                R3->>R3: Store Event\n                R3-->>Publisher: OK message\n            end\n        end\n    end\n\n    %% Result Aggregation Phase\n    rect rgb(255, 240, 245)\n        Note over Creator,Pool: Result Aggregation Phase\n        Publisher->>Publisher: Collect Responses\n\n        Publisher->>Publisher: Calculate Success Rate\n        Note right of Publisher: Success if:<br/>• 2/3 relays succeeded<br/>• At least 1 succeeded\n\n        alt Majority Success\n            Publisher->>Publisher: Mark as Published\n            Publisher->>Publisher: Update Local Cache\n            Publisher-->>UI: Publish Success\n            UI->>Creator: Show Success + Relay Stats\n            Note right of UI: \"Published to<br/>3/3 relays\"\n\n        else Partial Success\n            Publisher->>Publisher: Mark as Partially Published\n            Publisher-->>UI: Partial Success\n            UI->>Creator: Show Warning + Stats\n            Note right of UI: \"Published to<br/>2/3 relays<br/>Relay 3 failed\"\n\n        else Complete Failure\n            Publisher-->>UI: Publish Failed\n            UI->>Creator: Show Error + Retry Option\n        end\n    end\n\n    %% Error Handling & Retry\n    rect rgb(255, 245, 240)\n        Note over Creator,Pool: Error Handling & Retry\n        alt Relay Timeout\n            Publisher->>Publisher: Wait for Response (10s)\n            Publisher->>Publisher: Timeout Exceeded\n            Publisher->>Publisher: Mark Relay as Failed\n            Note right of Publisher: Relay health<br/>score decreased\n\n        else Network Error\n            Publisher->>Publisher: Detect Connection Lost\n            Publisher->>Pool: Request Reconnect\n            Pool->>Pool: Attempt Reconnection\n            alt Reconnect Success\n                Pool-->>Publisher: Relay Reconnected\n                Publisher->>Creator: Prompt to Retry\n            else Reconnect Failed\n                Pool-->>Publisher: Relay Unavailable\n                Publisher->>Publisher: Remove from Active Pool\n            end\n\n        else Invalid Event (Relay Rejection)\n            R1-->>Publisher: ERROR: duplicate event\n            Publisher->>Publisher: Log Rejection Reason\n            Publisher-->>UI: Event Rejected\n            UI->>Creator: Show Specific Error\n            Note right of UI: \"Event already<br/>published\"\n        end\n    end\n\n    %% Retry Logic\n    rect rgb(245, 240, 255)\n        Note over Creator,Pool: Automatic Retry Logic\n        alt Transient Failure Detected\n            Publisher->>Publisher: Check Retry Count\n            alt Retries < 3\n                Publisher->>Publisher: Wait (Exponential Backoff)\n                Note right of Publisher: Delays:<br/>• 1st retry: 2s<br/>• 2nd retry: 4s<br/>• 3rd retry: 8s\n\n                Publisher->>Publisher: Increment Retry Count\n                Publisher->>R1: EVENT message (retry)\n                R1-->>Publisher: OK message\n                Publisher-->>UI: Retry Successful\n            else Max Retries Reached\n                Publisher-->>UI: Publish Failed (Final)\n                UI->>Creator: Show Error + Manual Retry\n            end\n        end\n    end\n\n    %% Broadcasting to Followers\n    rect rgb(240, 255, 255)\n        Note over Creator,Pool: Follower Notification\n        Publisher->>Publisher: Check Event Type\n        alt Public Event (kind 1, 30023)\n            Publisher->>Pool: Broadcast to All Relays\n            Note right of Pool: Followers subscribed<br/>to creator's pubkey<br/>will receive event\n\n            Pool->>R1: Notify Subscribers\n            Pool->>R2: Notify Subscribers\n            Pool->>R3: Notify Subscribers\n\n            Note over R1,R3: Relays push event to<br/>subscribed clients via<br/>WebSocket connections\n\n        else Private Event (kind 4)\n            Publisher->>Publisher: Encrypt Content\n            Note right of Publisher: NIP-04 encryption<br/>using recipient's<br/>public key\n\n            Publisher->>Pool: Publish Encrypted Event\n            Note right of Pool: Only recipient<br/>can decrypt\n        end\n    end\n\n    %% Post-Publishing Tasks\n    rect rgb(255, 240, 240)\n        Note over Creator,Pool: Post-Publishing Tasks\n        Publisher->>Publisher: Update Analytics\n        Note right of Publisher: Track:<br/>• Publish time<br/>• Relay success rate<br/>• Event ID\n\n        Publisher->>Publisher: Update Local Database\n        Note right of Publisher: Cache event locally<br/>for offline viewing\n\n        Publisher->>Publisher: Trigger Indexing\n        Note right of Publisher: Update search index,<br/>content graph\n\n        Publisher-->>UI: Complete\n        UI->>Creator: Event Published Successfully\n    end\n\n    %% Event State Transitions\n    Note over Creator: Event States:<br/>• DRAFT: Being composed<br/>• VALIDATING: Checking data<br/>• SIGNING: Awaiting signature<br/>• PUBLISHING: Sending to relays<br/>• PUBLISHED: Confirmed on relays<br/>• FAILED: Publishing failed\n\n    Note over Pool: Relay Selection:<br/>• Primary relays (always)<br/>• User-preferred relays<br/>• Geo-optimized relays<br/>• Backup relays (on failure)\n\n    Note over Publisher: Success Criteria:<br/>• ≥2 relays confirmed<br/>• Response time <10s<br/>• Valid OK message<br/>• Event ID matches\n",
  "content_size": 9423,
  "collected_at": "2026-02-06T01:35:06.344094",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}