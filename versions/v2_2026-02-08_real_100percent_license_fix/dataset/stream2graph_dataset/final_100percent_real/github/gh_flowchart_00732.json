{
  "id": "gh_flowchart_00732",
  "source": "github",
  "source_url": "https://github.com/HonoraryIndians/axon/blob/a9f706c1df9fbed67940bfc2db02938aac0907bb/mermaid/ok/03-fcfs-payment-flowchart.mmd",
  "github_repo": "HonoraryIndians/axon",
  "github_file_path": "mermaid/ok/03-fcfs-payment-flowchart.mmd",
  "diagram_type": "flowchart",
  "code": "%% 3. FCFS + 결제 플로우차트 - 전체 프로세스\n\nflowchart TD\n    Start([사용자: 선착순 참여 버튼 클릭]) --> CheckLogin{로그인 여부}\n\n    CheckLogin -->|미로그인| RedirectLogin[OAuth2 로그인 페이지 리디렉션]\n    RedirectLogin --> Start\n\n    CheckLogin -->|로그인됨| SendRequest[POST /entry/api/v1/entries<br/>userId + activityId]\n\n    SendRequest --> EntryController[\"Entry Controller<br/>요청 수신\"]\n\n    EntryController --> CheckMeta{캠페인 메타<br/>존재 여부}\n\n    CheckMeta -->|Redis Miss| FetchMeta[\"Core Service 호출<br/>GET /api/v1/campaign/activities/:id<br/>TTL 1시간\"]\n    FetchMeta --> CheckMeta\n\n    CheckMeta -->|캐시 Hit| CheckStatus{캠페인 상태}\n\n    CheckStatus -->|INACTIVE/CLOSED| ReturnClosed[응답: 캠페인 종료]\n    ReturnClosed --> End1([종료])\n\n    CheckStatus -->|ACTIVE| FastValidation[\"Fast Validation<br/><br/><br/>Redis 캐시 조회: userCache:userId<br/>연령 조건 검증<br/>등급 조건 검증\"]\n\n    FastValidation -->|실패| ReturnFail[응답: 참여 불가<br/>사유: 연령/등급 미달]\n    ReturnFail --> End2([종료])\n\n    FastValidation -->|성공| HeavyValidation[\"Heavy Validation<br/>(선택적)<br/><br/><br/>Core Service API 호출<br/>복잡한 필터 조건 검증\"]\n\n    HeavyValidation -->|실패| ReturnFail\n    HeavyValidation -->|성공| GenerateToken[\"결정론적 토큰 생성<br/><br/><br/>Payload: userId, activityId,<br/>productId, quantity, timestamp<br/>HMAC 서명 + Base64\"]\n\n    GenerateToken --> FCFSReserve[\"FCFS 예약 로직<br/><br/><br/>원자성 보장\"]\n\n    FCFSReserve --> RedisAdd[\"Redis SADD<br/>campaign:activityId:users userId\"]\n\n    RedisAdd --> CheckDuplicate{추가 성공?}\n\n    CheckDuplicate -->|\"0 (이미 존재)\"| ReturnDuplicate[응답: 중복 참여]\n    ReturnDuplicate --> End3([종료])\n\n    CheckDuplicate -->|\"1 (신규)\"| RedisIncr[\"Redis INCR<br/>campaign:activityId:counter\"]\n\n    RedisIncr --> CheckLimit{counter > limitCount?}\n\n    CheckLimit -->|초과| Rollback[\"Rollback<br/><br/><br/>SREM campaign:activityId:users userId<br/>DECR campaign:activityId:counter\"]\n    Rollback --> ReturnSoldOut[응답: 품절]\n    ReturnSoldOut --> End4([종료])\n\n    CheckLimit -->|미초과| PublishEvent[\"ReservationApprovedEvent 발행<br/>(로컬 이벤트)\"]\n\n    PublishEvent --> ReturnToken[\"응답: 예약 성공<br/><br/><br/>• 순번: counter<br/>• 예약 토큰: JWT<br/> 데이터 원자성을 위한 2차토큰 발급<br/>TTL : 30분\"]\n\n    ReturnToken --> UserPayment([사용자: 결제 페이지 이동])\n\n    UserPayment --> ShowPayment[결제 정보 표시<br/>상품명, 가격, 수량]\n\n    ShowPayment --> UserConfirm{사용자<br/>결제 확인?}\n\n    UserConfirm -->|취소| PaymentCancel[1차토큰 만료 전까지 재결제 가능]\n    PaymentCancel --> End5([재결제 / 종료])\n\n    UserConfirm -->|확인| SendPayment[\"POST /entry/api/v1/payment/confirm<br/>예약 토큰 전송\"]\n\n    SendPayment --> ValidateToken{토큰 검증}\n\n    ValidateToken -->|만료/변조| ReturnInvalid[응답: 토큰 오류]\n    ReturnInvalid --> Retry{1차 토큰 유효기간동안 <br/> 재결제}\n\n    Retry -->|예| UserPayment\n    Retry -->|1차 토큰 TTL 만료| End6([종료])\n\n    ValidateToken -->|유효| PublishKafka[\"Kafka Producer<br/><br/><br/>Topic: axon.campaign-activity.command<br/>Payload: CampaignActivityKafkaProducerDto\"]\n\n    PublishKafka --> ReturnSuccess[응답: 결제 접수 완료<br/>비동기 처리 예정]\n\n    ReturnSuccess --> KafkaBuffer[\"이후 로직은 마이크로 배치 bulk insert<br/>향후 설명\"]\n\n\n    %% 스타일링 (진한 색상)\n    style Start fill:#81d4fa,stroke:#0277bd,stroke-width:2px\n    style FCFSReserve fill:#ef9a9a,stroke:#c62828,stroke-width:3px\n    style RedisAdd fill:#ffb74d,stroke:#ef6c00,stroke-width:2px\n    style RedisIncr fill:#ffb74d,stroke:#ef6c00,stroke-width:2px\n    style CheckLimit fill:#fff176,stroke:#f57f17,stroke-width:2px\n    style PublishKafka fill:#81c784,stroke:#388e3c,stroke-width:2px\n    style CoreConsumer fill:#ce93d8,stroke:#7b1fa2,stroke-width:2px\n    style GenerateToken fill:#f48fb1,stroke:#c2185b,stroke-width:2px\n    style ValidateToken fill:#f48fb1,stroke:#c2185b,stroke-width:2px\n",
  "content_size": 3561,
  "collected_at": "2026-02-06T01:47:20.934968",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 6,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}