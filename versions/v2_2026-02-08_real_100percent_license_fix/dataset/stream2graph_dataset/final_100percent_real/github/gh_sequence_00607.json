{
  "id": "gh_sequence_00607",
  "source": "github",
  "source_url": "https://github.com/chukwukap/half-life-smart-contracts/blob/6c35bcba17c3fc81739828753b0cd969c01d7a30/architecture.mmd",
  "github_repo": "chukwukap/half-life-smart-contracts",
  "github_file_path": "architecture.mmd",
  "diagram_type": "sequence",
  "code": "%% Half-Life Protocol Architecture Diagrams (2025)\n%% Paste any section into https://mermaid.live for visualization\n\n%% 1. High-Level System Architecture\nflowchart TD\n    User[\"User / Trader / LP\"]\n    Frontend[\"Frontend (Web App)\"]\n    Backend[\"Backend / API\"]\n    Oracle[\"OracleAdapter\"]\n    Market[\"PerpetualIndexMarket\"]\n    PositionMgr[\"PositionManager\"]\n    Funding[\"FundingRateEngine\"]\n    FeeMgr[\"FeeManager\"]\n    Liquidation[\"LiquidationEngine\"]\n    UniswapV4[\"Uniswap v4 Pool & HalfLifePerpetualsHook\"]\n    ERC20[\"Margin Token (ERC20)\"]\n\n    User -->|UI/Tx| Frontend\n    Frontend -->|API/Tx| Backend\n    Backend -->|Tx/Call| Market\n    Market -->|open/close/settle| PositionMgr\n    Market -->|funding| Funding\n    Market -->|fees| FeeMgr\n    Market -->|liquidation| Liquidation\n    Market -->|oracle price| Oracle\n    Market -->|margin transfer| ERC20\n    Market -->|swap/liquidity| UniswapV4\n    UniswapV4 -->|hook calls| Market\n    UniswapV4 -->|hook calls| PositionMgr\n    UniswapV4 -->|hook calls| Funding\n    UniswapV4 -->|hook calls| FeeMgr\n    UniswapV4 -->|hook calls| Oracle\n\n%% 2. Onchain Module Interaction (Detailed)\nflowchart TD\n    subgraph \"Uniswap v4\"\n        Pool[\"Uniswap v4 Pool\"]\n        Hook[\"HalfLifePerpetualsHook\"]\n    end\n\n    Market[\"PerpetualIndexMarket\"]\n    PositionMgr[\"PositionManager\"]\n    Funding[\"FundingRateEngine\"]\n    FeeMgr[\"FeeManager\"]\n    Liquidation[\"LiquidationEngine\"]\n    Oracle[\"OracleAdapter\"]\n    ERC20[\"Margin Token (ERC20)\"]\n\n    Pool -->|swap/add/remove| Hook\n    Hook -->|applyFunding/isSolvent/liquidate| PositionMgr\n    Hook -->|calculateFundingRate| Funding\n    Hook -->|collectFee| FeeMgr\n    Hook -->|getLatestIndexValue| Oracle\n\n    Market -->|open/close/settle| PositionMgr\n    Market -->|funding| Funding\n    Market -->|fees| FeeMgr\n    Market -->|liquidation| Liquidation\n    Market -->|oracle price| Oracle\n    Market -->|margin transfer| ERC20\n\n%% 3. Position Lifecycle\nsequenceDiagram\n    participant User\n    participant Frontend\n    participant Market as PerpetualIndexMarket\n    participant PositionMgr as PositionManager\n    participant ERC20 as MarginToken\n\n    User->>Frontend: Open Position (UI)\n    Frontend->>Market: openPosition(tx)\n    Market->>ERC20: Transfer margin from user\n    Market->>PositionMgr: openPosition(user, params)\n    PositionMgr-->>Market: positionId\n    Market-->>Frontend: positionId\n    Frontend-->>User: Position Opened\n\n    User->>Frontend: Close Position (UI)\n    Frontend->>Market: closePosition(positionId)\n    Market->>PositionMgr: closePosition(positionId)\n    PositionMgr-->>Market: pnl\n    Market->>ERC20: Transfer payout to user\n    Market-->>Frontend: Position Closed, PnL\n    Frontend-->>User: Position Closed, PnL\n\n%% 4. Uniswap v4 Hook Flow\nsequenceDiagram\n    participant Pool as Uniswap_v4_Pool\n    participant Hook as HalfLifePerpetualsHook\n    participant PositionMgr as PositionManager\n    participant Funding as FundingRateEngine\n    participant FeeMgr as FeeManager\n    participant Oracle as OracleAdapter\n\n    Pool->>Hook: beforeSwap()\n    Hook->>Oracle: getLatestIndexValue()\n    Hook->>Funding: calculateFundingRate()\n    Hook->>PositionMgr: applyFunding()\n    Hook->>PositionMgr: isSolvent()\n    alt Not Solvent\n        Hook->>PositionMgr: liquidate()\n    end\n    Hook->>FeeMgr: collectFee()\n    Hook-->>Pool: beforeSwap return\n    Pool->>Hook: afterSwap()\n    Hook-->>Pool: afterSwap return\n\n%% 5. Deployment/Upgrade Flow\nflowchart TD\n    Deployer[\"Deployer / DevOps\"]\n    Script[\"Deploy.s.sol\"]\n    Market[\"PerpetualIndexMarket\"]\n    PositionMgr[\"PositionManager\"]\n    Funding[\"FundingRateEngine\"]\n    FeeMgr[\"FeeManager\"]\n    Liquidation[\"LiquidationEngine\"]\n    Oracle[\"OracleAdapter\"]\n    Hook[\"HalfLifePerpetualsHook\"]\n\n    Deployer -->|forge script| Script\n    Script -->|deploy & initialize| Market\n    Script -->|deploy & initialize| PositionMgr\n    Script -->|deploy & initialize| Funding\n    Script -->|deploy & initialize| FeeMgr\n    Script -->|deploy & initialize| Liquidation\n    Script -->|deploy & initialize| Oracle\n    Script -->|deploy & initialize| Hook ",
  "content_size": 4105,
  "collected_at": "2026-02-06T01:34:38.727982",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 1
}