{
  "id": "gh_flowchart_00632",
  "source": "github",
  "source_url": "https://github.com/tareksalem/falak/blob/efdb210570643d84f8e566d6318022984aac7eb3/docs/nodeCommunicationFlow.mmd",
  "github_repo": "tareksalem/falak",
  "github_file_path": "docs/nodeCommunicationFlow.mmd",
  "diagram_type": "flowchart",
  "code": "flowchart TD\n    subgraph \"Node Discovery & Communication\"\n        Start([Start]) --> BootNode[\"New Node Boots\"]\n        BootNode --> InitLib[\"Initialize libp2p\"]\n        InitLib --> PBInit[\"Initialize Phonebook\"]\n        \n        PBInit --> LoadPhonebook[\"Load Phonebook\\n(Cached or Pre-provisioned)\"]\n        LoadPhonebook --> GroupByDC[\"Group Peers by\\nData Center\"]\n        GroupByDC --> ParallelConnect[\"Initiate Parallel Connection\\nAttempts Per Data Center\"]\n        \n        ParallelConnect --> AttemptConn[\"Attempt Connection to Peer\\nwith Exponential Backoff\"]\n        AttemptConn --> ConnSuccess{\"Connection\\nSuccessful?\"}\n        ConnSuccess -->|No| NextPeer[\"Try Next Peer in\\nSame Data Center\"]\n        NextPeer --> PeerAvailable{\"More Peers\\nAvailable?\"}\n        PeerAvailable -->|Yes| AttemptConn\n        PeerAvailable -->|No| MarkDCFailed[\"Mark Data Center\\nas Unreachable\"]\n        \n        ConnSuccess -->|Yes| PSInit[\"Initialize PubSub\\n(GossipSub)\"]\n    end\n    \n    subgraph \"Node Authentication\"\n        PSInit --> TLSHandshake[\"TLS Handshake with\\nMutual Certificate Verification\"]\n        TLSHandshake --> VerifyCerts[\"Verify Peer Certificate\\nAgainst Root CA\"]\n        VerifyCerts --> JoinAuthStream[\"Open Authentication Stream\\n(/falak/join/1.0)\"]\n        JoinAuthStream --> SendClientHello[\"Send ClientHello\\n(clusterId, nodeId, metadata)\"]\n        SendClientHello --> RecvChallenge[\"Receive ServerChallenge\\n(nonce, timestamp)\"]\n        RecvChallenge --> SignChallenge[\"Sign Challenge with\\nEd25519 Private Key\"]\n        SignChallenge --> SendResponse[\"Send ClientResponse\\n(signature of challenge)\"]\n        SendResponse --> AuthCheck{\"Authentication\\nSuccessful?\"}\n        AuthCheck -->|No| AuthFail[\"Authentication Failed\\nConnection Dropped\"]\n        AuthCheck -->|Yes| RecvPhonebook[\"Receive Phonebook Delta\\nin ServerAck\"]\n        RecvPhonebook --> PreserveInitial[\"Preserve Copy of\\nInitial Phonebook\"]\n        PreserveInitial --> UpdatePhonebook[\"Update Data Center-Specific\\nSections of Phonebook\"]\n    end\n    \n    subgraph \"Cluster PubSub Integration\"\n        UpdatePhonebook --> SubMembership[\"Subscribe to Membership Topic\\n(falak/<clusterId>/membership)\"]\n        SubMembership --> SubHeartbeat[\"Subscribe to Heartbeat Topic\\n(falak/<clusterId>/heartbeat)\"]\n        SubHeartbeat --> InitHealthRegistry[\"Initialize Health Registry\"]\n        InitHealthRegistry --> AnnounceJoin[\"Publish NodeJoined\\nto Membership Topic\"]\n        AnnounceJoin --> StartHeartbeat[\"Start Heartbeat\\nPublisher\"]\n        StartHeartbeat --> ListenMembership[\"Listen for Membership Events\\n(NodeJoined, NodeLeft, NodeUpdate)\"]\n        \n        ListenMembership --> ReadyForOps[\"Node Ready\\nfor Operations\"]\n    end\n    \n    subgraph \"Failure Detection\"\n        ReadyForOps --> MonitorHeartbeats[\"Monitor Peer Heartbeats\"]\n        MonitorHeartbeats --> CalcPhi[\"Calculate Phi Score\\nfor Each Peer\"]\n        CalcPhi --> PhiCheck{\"Phi ≥ Threshold?\"}\n        PhiCheck -->|No| ContinueMonitoring[\"Continue\\nMonitoring\"]\n        ContinueMonitoring --> MonitorHeartbeats\n        \n        PhiCheck -->|Yes| DirectPing[\"Perform Direct Ping\\nto Suspected Peer\"]\n        DirectPing --> PingSuccess{\"Ping\\nSuccessful?\"}\n        PingSuccess -->|Yes| ResetPhi[\"Reset Phi\\nfor Peer\"]\n        ResetPhi --> MonitorHeartbeats\n        \n        PingSuccess -->|No| IndirectProbe[\"Perform Indirect Probes\\nvia K Other Peers\"]\n        IndirectProbe --> IndirectSuccess{\"Any Probe\\nSuccessful?\"}\n        IndirectSuccess -->|Yes| ResetPhi\n        \n        IndirectSuccess -->|No| PublishSuspicion[\"Publish Suspicion\\nto Suspicion Topic\"]\n        PublishSuspicion --> WaitForRefutation[\"Wait for Refutation\\nor Quorum\"]\n        WaitForRefutation --> RefutationReceived{\"Refutation\\nReceived?\"}\n        \n        RefutationReceived -->|Yes| ResetPhi\n        RefutationReceived -->|No| QuorumReached{\"Quorum\\nReached?\"}\n        \n        QuorumReached -->|No| ContinueMonitoring\n        QuorumReached -->|Yes| MarkFailed[\"Mark Peer as Failed\"]\n        MarkFailed --> PublishQuorum[\"Publish Quorum Verdict\"]\n    end\n    \n    subgraph \"Self-Healing\"\n        MonitorQuorum[\"Monitor Quorum Topic\\nfor Self Failures\"] --> SelfFailed{\"Self\\nMarked Failed?\"}\n        SelfFailed -->|No| ContinueSelfMonitor[\"Continue\\nSelf-Monitoring\"]\n        ContinueSelfMonitor --> MonitorQuorum\n        \n        SelfFailed -->|Yes| IncrementIncarnation[\"Increment Incarnation\\nNumber\"]\n        IncrementIncarnation --> ReauthFlow[\"Re-run Authentication\\nFlow\"]\n        ReauthFlow --> PublishHeartbeat[\"Publish Immediate\\nHeartbeat\"]\n        PublishHeartbeat --> CoolOffPeriod[\"Observe Cool-off\\nPeriod\"]\n        CoolOffPeriod --> ResumeFull[\"Resume Full\\nCluster Participation\"]\n    end\n    \n    %% Connect the subgraphs\n    AuthFail -.-> BootNode\n    MarkDCFailed -.-> ParallelConnect\n    ReadyForOps -.-> MonitorQuorum\n    \n    %% Dark Mode Styling with Better Text Contrast\n    classDef primary fill:#0f172a,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef secondary fill:#172554,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef success fill:#022c22,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef error fill:#450a0a,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef neutral fill:#1f2937,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef decision fill:#2e1065,stroke:#475569,stroke-width:2px,color:#e2e8f0;\n    classDef warning fill:#2d1c04,stroke:#475569,stroke-width:2px,color:#f8fafc;\n    \n    class Start,BootNode,InitLib,PBInit,LoadPhonebook,GroupByDC,ParallelConnect primary;\n    class PSInit,JoinAuthStream,SendClientHello,RecvChallenge,SendResponse,SubHeartbeat,InitHealthRegistry,StartHeartbeat,TLSHandshake,VerifyCerts,SignChallenge,PreserveInitial secondary;\n    class UpdatePhonebook,SubMembership,AnnounceJoin,ListenMembership,ReadyForOps,ResumeFull success;\n    class AuthFail,MarkDCFailed,MarkFailed error;\n    class AttemptConn,NextPeer,DirectPing,IndirectProbe,ContinueMonitoring,WaitForRefutation,PublishQuorum neutral;\n    class ConnSuccess,AuthCheck,PeerAvailable,PhiCheck,PingSuccess,IndirectSuccess,RefutationReceived,QuorumReached,SelfFailed decision;\n    class MonitorHeartbeats,CalcPhi,ResetPhi,PublishSuspicion,MonitorQuorum,IncrementIncarnation,ReauthFlow,PublishHeartbeat,CoolOffPeriod warning;\n",
  "content_size": 6347,
  "collected_at": "2026-02-06T01:46:08.233645",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}