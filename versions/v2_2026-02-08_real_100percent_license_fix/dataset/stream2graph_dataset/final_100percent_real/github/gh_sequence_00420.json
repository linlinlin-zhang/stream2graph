{
  "id": "gh_sequence_00420",
  "source": "github",
  "source_url": "https://github.com/seanchatmangpt/erlmcp/blob/1356e12d778f4f4908360bdb3af445db8caff50d/docs/diagrams/examples/error-scenario.mmd",
  "github_repo": "seanchatmangpt/erlmcp",
  "github_file_path": "docs/diagrams/examples/error-scenario.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant AI as AI Application\n    participant Client as erlmcp_client\n    participant Transport as erlmcp_transport_tcp\n    participant Server as erlmcp_server\n    participant Validator as JSON Schema Validator\n    participant Circuit as Circuit Breaker\n    participant Metrics as erlmcp_metrics\n    participant OTEL as erlmcp_otel\n    participant Recovery as Recovery Manager\n\n    Note over AI,Recovery: Error Handling Scenario: Cascading Failures & Recovery\n\n    %% Normal operation begins\n    AI->>Client: call_tool(<<\"database_query\">>, #{query => \"SELECT * FROM users\"})\n    Client->>Transport: send(tools/call)\n    Transport->>Server: TCP stream\n\n    %% Error 1: Invalid tool name (protocol error)\n    Note over AI,Recovery: Error Type 1: Protocol Error - Tool Not Found\n\n    Server->>Server: Decode JSON-RPC request\n    Server->>Server: Lookup tool: <<\"database_query\">>\n    Server->>Server: Tool not found in registry\n    Server->>Server: erlmcp_errors:protocol_error(-32601, \"Tool not found\")\n    Server-->>Transport: JSON-RPC Error Response\n    Note left of Server: {<br/>  \"jsonrpc\": \"2.0\",<br/>  \"id\": \"uuid-001\",<br/>  \"error\": {<br/>    \"code\": -32601,<br/>    \"message\": \"Method not found\",<br/>    \"data\": \"Tool 'database_query' not found\"<br/>  }<br/>}\n\n    Transport-->>Client: Error response\n    Client->>Client: Match uuid-001 from State.pending\n    Client-->>AI: {error, {tool_not_found, \"database_query\"}}\n\n    %% Record error metrics\n    Client->>Metrics: erlmcp_metrics:increment_error(<<\"tool_not_found\">>)\n    Metrics->>Metrics: Update error counters\n    Metrics->>OTEL: Record error span\n    Note over Metrics: Error rate: 0.1%<br/>Below threshold\n\n    %% Error 2: Schema validation failure (business logic error)\n    Note over AI,Recovery: Error Type 2: Schema Validation Error\n\n    AI->>Client: call_tool(<<\"execute_query\">>, #{\n        query => \"SELECT *\",\n        limit => \"invalid\"  %% Should be integer\n    })\n    Client->>Transport: send(tools/call)\n    Transport->>Server: TCP stream\n    Server->>Validator: jesse:validate(Schema, Arguments)\n    Validator->>Validator: Validate arguments against schema\n    Note right of Validator: Schema expects:<br/>limit: integer<br/>Got: \"invalid\"\n\n    Validator-->>Server: {error, validation_failed}\n    Server->>Server: erlmcp_errors:app_error(-32602, \"Invalid params\")\n    Server-->>Transport: JSON-RPC Error\n    Note left of Server: {<br/>  \"error\": {<br/>    \"code\": -32602,<br/>    \"message\": \"Invalid params\",<br/>    \"data\": {<br/>      \"field\": \"limit\",<br/>      \"expected\": \"integer\",<br/>      \"got\": \"string\"<br/>    }<br/>  }<br/>}\n\n    Transport-->>Client: Error response\n    Client-->>AI: {error, {invalid_params, #{\n        field => <<\"limit\">>,\n        expected => integer,\n        got => string\n    }}}\n\n    %% Record validation error\n    Client->>Metrics: erlmcp_metrics:increment_error(<<\"validation_failed\">>)\n\n    %% Error 3: Transport failure (network error)\n    Note over AI,Recovery: Error Type 3: Transport Failure - Connection Lost\n\n    AI->>Client: call_tool(<<\"long_running_task\">>, #{duration => 60000})\n    Client->>Transport: send(tools/call)\n\n    Transport->>Transport: Network timeout\n    Note right of Transport: Connection lost<br/>during request\n\n    Transport->>Transport: erlmcp_transport_tcp:handle_disconnect()\n    Transport->>Circuit: Check circuit state\n    Circuit->>Circuit: Track failure count\n    Note right of Circuit: Failures: 1/5<br/>Circuit: CLOSED\n\n    Transport-->>Client: {error, transport_disconnected}\n    Client->>Client: Detect transport failure\n    Client-->>AI: {error, {transport_failed, disconnected}}\n\n    %% Record transport error\n    Client->>Metrics: erlmcp_metrics:increment_error(<<\"transport_disconnected\">>)\n\n    %% Automatic retry with exponential backoff\n    Note over AI,Recovery: Recovery Strategy: Automatic Retry\n\n    Client->>Client: Check retry policy for transport errors\n    Client->>Client: Calculate backoff: 2^0 * 1000ms = 1s\n    Client->>Client: Schedule retry\n\n    Note over Client: Wait 1s (exponential backoff)\n\n    Client->>Transport: Reconnect attempt 1\n    Transport->>Transport: erlmcp_transport_tcp:reconnect()\n    Transport->>Transport: Establish new TCP connection\n    Transport-->>Client: {ok, reconnected}\n\n    %% Retry the request\n    Client->>Transport: send(tools/call) - retry\n    Transport->>Server: TCP stream\n    Server-->>Transport: Response\n    Transport-->>Client: {ok, Result}\n    Client-->>AI: {ok, Result} (after retry)\n\n    %% Record successful recovery\n    Client->>Metrics: erlmcp_metrics:record_recovery(<<\"transport_disconnected\">>)\n\n    %% Error 4: Circuit breaker activation (cascading failures)\n    Note over AI,Recovery: Error Type 4: Circuit Breaker - Service Degradation\n\n    loop Multiple rapid failures\n        AI->>Client: call_tool(<<\"external_api\">>, Args)\n        Client->>Transport: send(tools/call)\n        Transport->>Transport: Request timeout\n        Transport-->>Client: {error, timeout}\n\n        Client->>Metrics: increment_error(<<\"timeout\">>)\n        Client->>Circuit: record_failure(<<\"external_api\">>)\n\n        Note over Circuit: Failures: 2/5<br/>Circuit: CLOSED\n    end\n\n    %% Threshold reached, circuit opens\n    Client->>Client: call_tool(<<\"external_api\">>, Args)\n    Client->>Circuit: check_circuit(<<\"external_api\">>)\n    Circuit->>Circuit: Failure count: 5/5\n    Circuit->>Circuit: Open circuit\n    Note over Circuit: Circuit: HALF_OPEN → OPEN<br/>Block requests for 30s\n\n    Circuit-->>Client: {error, circuit_open}\n    Client-->>AI: {error, {service_degraded, refusal_code => 1089}}\n    Note left of Client: Refusal Code 1089:<br/>Service temporarily unavailable<br/>due to degradation\n\n    %% Record circuit breaker event\n    Client->>Metrics: erlmcp_metrics:record_circuit_open(<<\"external_api\">>)\n    Metrics->>Recovery: Trigger recovery manager\n    Recovery->>Recovery: Schedule health check in 30s\n\n    %% Alternative: Fallback to cached response\n    Note over AI,Recovery: Recovery Strategy: Graceful Degradation\n\n    AI->>Client: call_tool(<<\"external_api\">>, #{\n        use_fallback => true\n    })\n    Client->>Client: Check circuit state\n    Client->>Client: Circuit is OPEN\n    Client->>Client: Return cached data\n    Note right of Client: Return last known<br/>good response from cache\n\n    Client-->>AI: {ok, CachedResult}\n    Note over AI: Stale data accepted<br/>while circuit is open\n\n    %% Circuit breaker recovery test\n    Note over AI,Recovery: Recovery Strategy: Circuit Breaker Recovery\n\n    Recovery->>Recovery: 30s elapsed\n    Recovery->>Circuit: Attempt recovery\n    Circuit->>Circuit: Transition to HALF_OPEN\n    Note over Circuit: Circuit: OPEN → HALF_OPEN<br/>Allow 1 test request\n\n    Recovery->>Client: Test request to external_api\n    Client->>Transport: send(test request)\n    Transport->>Server: TCP stream\n    Server-->>Transport: Success response\n    Transport-->>Client: {ok, Success}\n    Client-->>Recovery: Test successful\n\n    Recovery->>Circuit: Record success\n    Circuit->>Circuit: Reset failure count\n    Circuit->>Circuit: Close circuit\n    Note over Circuit: Circuit: HALF_OPEN → CLOSED<br/>Normal operation resumed\n\n    %% Full recovery achieved\n    AI->>Client: call_tool(<<\"external_api\">>, Args)\n    Client->>Transport: send(tools/call)\n    Transport->>Server: TCP stream\n    Server-->>Transport: Response\n    Transport-->>Client: {ok, Result}\n    Client-->>AI: {ok, Result}\n\n    %% Record recovery metrics\n    Client->>Metrics: erlmcp_metrics:record_recovery(<<\"circuit_breaker\">>)\n    Metrics->>OTEL: Record recovery span\n    Note over Metrics: Recovery time: 32s<br/>Errors during outage: 5<br/>Fallback usage: 12\n\n    %% Summary: Error handling effectiveness\n    Note over AI,Recovery: Error Handling Summary<br/>========================<br/>Total Errors: 8<br/>  - Protocol: 1 (no retry)<br/>  - Validation: 1 (no retry)<br/>  - Transport: 1 (retry success)<br/>  - Timeout: 5 (circuit breaker)<br/>Recovery: Automatic<br/>User Impact: Minimal<br/>Fallback: Cached responses\n",
  "content_size": 8074,
  "collected_at": "2026-02-06T01:32:05.104624",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "apache-2.0",
  "license_name": "Apache License 2.0",
  "license_url": "https://api.github.com/licenses/apache-2.0",
  "repo_stars": 0,
  "repo_forks": 0
}