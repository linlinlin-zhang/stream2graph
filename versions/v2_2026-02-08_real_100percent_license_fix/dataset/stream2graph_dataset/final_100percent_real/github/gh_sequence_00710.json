{
  "id": "gh_sequence_00710",
  "source": "github",
  "source_url": "https://github.com/zone17/sovren/blob/d3da3358e52da6ae6b2365e89401eca50f337a0c/docs/architecture/diagrams/service-interactions/payment-processing-flow.mmd",
  "github_repo": "zone17/sovren",
  "github_file_path": "docs/architecture/diagrams/service-interactions/payment-processing-flow.mmd",
  "diagram_type": "sequence",
  "code": "%% Payment Processing Flow - Service Interaction Sequence\n%% Version: 1.0.0\n%% Date: 2025-10-27\n%% Description: Complete sequence diagram for Lightning payment processing workflow\n\nsequenceDiagram\n    actor User as User/Supporter\n    participant WebApp as Web Application\n    participant API as API Gateway\n    participant Auth as Auth Middleware\n    participant PaymentProc as Payment Processing Service\n    participant Currency as Currency Service\n    participant Lightning as Lightning Node\n    participant Webhook as Webhook Service\n    participant Repo as Repository Factory\n    participant DB as PostgreSQL\n    participant EventBus as Event Bus Service\n    participant PaymentAnalytics as Payment Analytics Service\n    participant Notification as Notification Service\n    participant Cache as Cache Service\n\n    User->>WebApp: Initiate Payment (1000 sats)\n    WebApp->>API: POST /api/payments/create\n    API->>Auth: Validate JWT\n    Auth-->>API: Authentication Success\n\n    API->>PaymentProc: createPayment(amount, userId)\n\n    Note over PaymentProc: Generate unique payment ID\n    PaymentProc->>Currency: convertIfNeeded(amount, currency)\n    Currency-->>PaymentProc: Amount in sats\n\n    PaymentProc->>Lightning: createInvoice(amount, description)\n    Lightning-->>PaymentProc: BOLT11 Invoice + Payment Hash\n\n    PaymentProc->>Repo: savePayment(pending)\n    Repo->>DB: INSERT INTO payments\n    DB-->>Repo: Payment ID\n    Repo-->>PaymentProc: Payment Saved\n\n    PaymentProc->>EventBus: publish('payment.created', data)\n    EventBus->>PaymentAnalytics: trackPaymentCreated(data)\n\n    PaymentProc-->>API: Invoice Data\n    API-->>WebApp: 201 Created with BOLT11\n    WebApp-->>User: Display Payment QR Code\n\n    User->>Lightning: Pay Invoice via Wallet\n    Lightning->>Lightning: Process Payment\n\n    Lightning-->>Webhook: Payment Received Callback\n    Webhook->>PaymentProc: verifyPayment(paymentHash)\n\n    PaymentProc->>Lightning: checkPaymentStatus(paymentHash)\n    Lightning-->>PaymentProc: Payment Confirmed\n\n    alt Payment Confirmed\n        PaymentProc->>Repo: updatePayment(status: confirmed)\n        Repo->>DB: UPDATE payments SET status='confirmed'\n        DB-->>Repo: Updated\n\n        PaymentProc->>EventBus: publish('payment.confirmed', data)\n\n        EventBus->>PaymentAnalytics: recordPayment(data)\n        PaymentAnalytics->>Repo: updateMetrics()\n        Repo->>DB: UPDATE payment_metrics\n\n        EventBus->>Notification: notifyCreator(paymentData)\n        Notification->>Repo: getCreator()\n        Notification->>EventBus: publish('notification.created')\n\n        EventBus->>Cache: invalidate(payment_stats_*)\n\n        PaymentProc-->>Webhook: Success\n        Webhook->>Repo: logWebhookDelivery(success)\n\n        Note over User,Notification: Payment confirmed,<br/>creator notified,<br/>analytics updated\n\n    else Payment Failed\n        PaymentProc->>Repo: updatePayment(status: failed)\n        Repo->>DB: UPDATE payments SET status='failed'\n\n        PaymentProc->>EventBus: publish('payment.failed', data)\n        EventBus->>Notification: notifyUserFailure(data)\n\n        PaymentProc-->>Webhook: Failure\n        Webhook->>Repo: logWebhookDelivery(failure)\n\n        Note over User,Notification: Payment failed,<br/>user notified\n    end\n\n    User->>WebApp: Check Payment Status\n    WebApp->>API: GET /api/payments/{id}\n    API->>Cache: get(payment_{id})\n\n    alt Cache Hit\n        Cache-->>API: Payment Data\n    else Cache Miss\n        API->>PaymentProc: getPayment(id)\n        PaymentProc->>Repo: findPayment(id)\n        Repo->>DB: SELECT FROM payments\n        DB-->>Repo: Payment Data\n        Repo-->>PaymentProc: Payment Data\n        PaymentProc-->>API: Payment Data\n        API->>Cache: set(payment_{id}, data, ttl: 60s)\n    end\n\n    API-->>WebApp: Payment Status\n    WebApp-->>User: Display Confirmation\n",
  "content_size": 3828,
  "collected_at": "2026-02-06T01:36:00.536949",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}