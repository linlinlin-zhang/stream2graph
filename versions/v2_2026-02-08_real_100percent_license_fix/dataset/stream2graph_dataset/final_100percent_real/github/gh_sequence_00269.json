{
  "id": "gh_sequence_00269",
  "source": "github",
  "source_url": "https://github.com/dtolan/hub_and_spoke_wireguard/blob/70ed2caff5fa8de0fd573655efb74142421093e5/docs/diagrams/spoke-provisioning-sequence.mmd",
  "github_repo": "dtolan/hub_and_spoke_wireguard",
  "github_file_path": "docs/diagrams/spoke-provisioning-sequence.mmd",
  "diagram_type": "sequence",
  "code": "%% Spoke Provisioning Sequence Diagram\n\nsequenceDiagram\n    participant Admin as Admin<br/>(Browser)\n    participant Dashboard as React<br/>Dashboard\n    participant API as Express<br/>API\n    participant DB as SQLite<br/>Database\n    participant WG as WireGuard<br/>Service\n    participant Spoke as Spoke<br/>Device\n\n    Admin->>Dashboard: 1. Click \"Add Spoke\"<br/>Name: \"laptop-001\"\n    Dashboard->>API: 2. POST /api/installation/token<br/>{spokeName: \"laptop-001\"}\n\n    API->>API: 3. Generate 256-bit token<br/>crypto.randomBytes(32)\n    API->>DB: 4. Allocate next IP<br/>10.0.1.5/24\n    API->>DB: 5. INSERT token record<br/>(unused, expires 24h)\n    DB-->>API: Token created\n\n    API-->>Dashboard: 6. Return token + install cmd\n    Dashboard-->>Admin: 7. Show installation command<br/>curl https://hub/.../TOKEN | bash\n\n    Admin->>Spoke: 8. SSH to spoke device<br/>Execute install command\n\n    Spoke->>API: 9. GET /api/installation/script/TOKEN?platform=linux\n    API->>DB: 10. Validate token<br/>(exists, unused, not expired)\n    API->>DB: 11. Mark token as USED<br/>(atomic UPDATE)\n    DB-->>API: Token marked used\n    API-->>Spoke: 12. Return rendered script<br/>(with embedded config)\n\n    Spoke->>Spoke: 13. Install WireGuard<br/>apt-get install wireguard\n    Spoke->>Spoke: 14. Generate keys locally<br/>wg genkey | wg pubkey\n    Spoke->>Spoke: 15. Private key NEVER leaves device\n\n    Spoke->>API: 16. POST /api/spoke/register<br/>{token, publicKey, os}\n    API->>DB: 17. Validate token again<br/>(prevent replay)\n    API->>DB: 18. Check public key unique\n    API->>DB: 19. INSERT spoke registration\n    DB-->>API: Spoke registered\n\n    API->>WG: 20. wg set wg0 peer <publicKey><br/>allowed-ips 10.0.1.5/32\n    WG-->>API: Peer added\n    API->>WG: 21. wg-quick save wg0\n    WG-->>API: Config saved\n\n    API-->>Spoke: 22. Registration successful\n\n    Spoke->>Spoke: 23. Create /etc/wireguard/wg0.conf\n    Spoke->>Spoke: 24. systemctl enable wg-quick@wg0\n    Spoke->>Spoke: 25. systemctl start wg-quick@wg0\n\n    Spoke->>WG: 26. Establish VPN tunnel\n    WG->>Spoke: 27. Handshake complete\n\n    Spoke-->>Admin: 28. ✅ Installation complete<br/>VPN IP: 10.0.1.5\n\n    Note over Admin,Spoke: Total time: ~30-60 seconds\n",
  "content_size": 2222,
  "collected_at": "2026-02-06T01:29:58.913134",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}