{
  "id": "gh_architecture_01504",
  "source": "github",
  "source_url": "https://github.com/trutkowski22/claude-task-master/blob/80b6b87d8682d53235785872ed02e4e8c2106272/project-overlord-context/Pre-CLI-Removal-MMDs/Shared-Infrastructure-Layer/utils_contextGatherer.mmd",
  "github_repo": "trutkowski22/claude-task-master",
  "github_file_path": "project-overlord-context/Pre-CLI-Removal-MMDs/Shared-Infrastructure-Layer/utils_contextGatherer.mmd",
  "diagram_type": "architecture",
  "code": "flowchart TB\n    subgraph contextGatherer-Imports[\"contextGatherer-Imports\"]\n        I1[\"IMPORT: fs, FROM: fs\"]\n        I2[\"IMPORT: path, FROM: path\"]\n        I3[\"IMPORT: pkg, FROM: gpt-tokens\"]\n        I4[\"IMPORT: Fuse, FROM: fuse.js\"]\n        I5[\"IMPORT: readJSON, findTaskById, truncate, flattenTasksWithSubtasks, FROM: /claude-task-master/scripts/modules/utils.js\"]\n    end\n    subgraph contextGatherer-Dependencies[\"contextGatherer-Dependencies\"]\n        D1[\"DEP: File system\"]\n        D2[\"DEP: GPT Tokens\"]\n        D3[\"DEP: Fuse.js fuzzy search\"]\n    end\n    subgraph contextGatherer-FunctionsDefined[\"contextGatherer-Functions Defined\"]\n        FU1[\"FUNCTION: constructor\"]\n        FU2[\"FUNCTION: _loadAllTasks\"]\n        FU3[\"FUNCTION: countTokens\"]\n        FU4[\"FUNCTION: gather\"]\n        FU5[\"FUNCTION: _performSemanticSearch\"]\n        FU6[\"FUNCTION: _buildDependencyContext\"]\n        FU7[\"FUNCTION: _buildDependencyGraphs\"]\n        FU8[\"FUNCTION: _buildDependencyGraph\"]\n        FU9[\"FUNCTION: _formatDependencyChain\"]\n        FU10[\"FUNCTION: _parseTaskIds\"]\n        FU11[\"FUNCTION: _gatherTaskContext\"]\n        FU12[\"FUNCTION: _formatTaskForContext\"]\n        FU13[\"FUNCTION: _formatSubtaskForContext\"]\n        FU14[\"FUNCTION: _gatherFileContext\"]\n        FU15[\"FUNCTION: _gatherProjectTreeContext\"]\n        FU16[\"FUNCTION: _formatSingleFileForContext\"]\n        FU17[\"FUNCTION: _generateFileTree\"]\n        FU18[\"FUNCTION: _formatCustomContext\"]\n        FU19[\"FUNCTION: _formatTaskContextSection\"]\n        FU20[\"FUNCTION: _formatFileContextSection\"]\n        FU21[\"FUNCTION: _formatProjectTreeSection\"]\n        FU22[\"FUNCTION: _renderFileTree\"]\n        FU23[\"FUNCTION: _joinContextSections\"]\n        FU24[\"FUNCTION: createContextGatherer\"]\n    end\n    subgraph contextGatherer-Exports[\"contextGatherer-Exports\"]\n        E1[\"EXP: ContextGatherer\"]\n        E2[\"EXP: createContextGatherer\"]\n    end\n    subgraph contextGatherer-Parameters[\"contextGatherer-Parameters\"]\n        P1[\"PARAM: {string} projectRoot - Project root directory\"]\n        P2[\"PARAM: {string} tag - Tag for the task\"]\n        P3[\"PARAM: {string} text - Text to count tokens for\"]\n        P4[\"PARAM: {Object} options - Context gathering options\"]\n        P5[\"PARAM: {Array<string>} [options.tasks] - Task/subtask IDs to include\"]\n        P6[\"PARAM: {Array<string>} [options.files] - File paths to include\"]\n        P7[\"PARAM: {string} [options.customContext] - Additional custom context\"]\n        P8[\"PARAM: {boolean} [options.includeProjectTree] - Include project file tree\"]\n        P9[\"PARAM: {string} [options.format] - Output format: research, chat, system-prompt\"]\n        P10[\"PARAM: {boolean} [options.includeTokenCounts] - Whether to include token breakdown\"]\n        P11[\"PARAM: {string} [options.semanticQuery] - A query string for semantic task searching\"]\n        P12[\"PARAM: {number} [options.maxSemanticResults] - Max number of semantic results\"]\n        P13[\"PARAM: {Array<number>} [options.dependencyTasks] - Array of task IDs to build dependency graphs from\"]\n        P14[\"PARAM: {string} query - Search query string\"]\n        P15[\"PARAM: {number} maxResults - Maximum number of results to return\"]\n        P16[\"PARAM: {Array<string>} taskIds - Task/subtask IDs\"]\n        P17[\"PARAM: {Array<string>} filePaths - File paths to read\"]\n        P18[\"PARAM: {string} dirPath - Directory path\"]\n        P19[\"PARAM: {number} maxDepth - Maximum depth to traverse\"]\n    end\n    subgraph contextGatherer-Constants[\"contextGatherer-Const Declarations\"]\n        C1[\"CONST: { encode }, VALUE: pkg\"]\n        C2[\"CONST: tasksPath, VALUE: path.join(projectRoot, '.taskmaster', 'tasks', 'tasks.json')\"]\n        C3[\"CONST: data, VALUE: readJSON(this.tasksPath, this.projectRoot, this.tag)\"]\n        C4[\"CONST: tasks, VALUE: data?.tasks || []\"]\n        C5[\"CONST: contextSections, VALUE: []\"]\n        C6[\"CONST: finalTaskIds, VALUE: new Set(tasks.map(String))\"]\n        C7[\"CONST: tokenBreakdown, VALUE: token counting breakdown object\"]\n        C8[\"CONST: searchOptions, VALUE: Fuse.js search configuration\"]\n        C9[\"CONST: fuse, VALUE: new Fuse(searchableTasks, searchOptions)\"]\n        C10[\"CONST: promptWords, VALUE: significant words extracted from query\"]\n        C11[\"CONST: fuzzyResults, VALUE: fuse.search(query)\"]\n        C12[\"CONST: parsedIds, VALUE: this._parseTaskIds(taskIds)\"]\n        C13[\"CONST: contextItems, VALUE: formatted context items array\"]\n        C14[\"CONST: breakdown, VALUE: token breakdown array\"]\n        C15[\"CONST: fileContents, VALUE: array of file data objects\"]\n        C16[\"CONST: tree, VALUE: this._generateFileTree(this.projectRoot, 5)\"]\n        C17[\"CONST: ignoreDirs, VALUE: ['.git', 'node_modules', '.env', 'coverage', 'dist', 'build']\"]\n        C18[\"CONST: ignoreFiles, VALUE: ['.DS_Store', '.env', '.env.local', '.env.production']\"]\n    end\n    subgraph contextGatherer-ExecutionFlow[\"contextGatherer-Execution Flow\"]\n        FL1[\"Initialize ContextGatherer with project root and tag\"]\n        FL2[\"Load all tasks from tasks.json using readJSON\"]\n        FL3[\"Set up file paths and initialize task data\"]\n        FL4[\"Count tokens in text using gpt-tokens package\"]\n        FL5[\"Gather context from multiple sources based on options\"]\n        FL6[\"Perform semantic search using Fuse.js with configurable options\"]\n        FL7[\"Extract significant words from search query\"]\n        FL8[\"Execute fuzzy search and word-based search\"]\n        FL9[\"Group results by relevance score (high/medium/recent)\"]\n        FL10[\"Build dependency graphs for related tasks\"]\n        FL11[\"Parse task IDs supporting both task and subtask formats\"]\n        FL12[\"Gather task context with detailed formatting\"]\n        FL13[\"Format tasks and subtasks for context inclusion\"]\n        FL14[\"Gather file context with size and content validation\"]\n        FL15[\"Generate project tree structure with depth limiting\"]\n        FL16[\"Apply format-specific rendering (research/chat/system-prompt)\"]\n        FL17[\"Calculate token counts and character breakdowns\"]\n        FL18[\"Join context sections with format-appropriate separators\"]\n        FL19[\"Return comprehensive context object with analysis data\"]\n    end\n    subgraph contextGatherer[\"contextGatherer.js\"]\n        contextGatherer-Imports\n        contextGatherer-Dependencies\n        contextGatherer-FunctionsDefined\n        contextGatherer-Exports\n        contextGatherer-Parameters\n        contextGatherer-Constants\n        contextGatherer-ExecutionFlow\n    end\n    FL1 --> FL2\n    FL2 --> FL3\n    FL3 --> FL4\n    FL4 --> FL5\n    FL5 --> FL6\n    FL6 --> FL7\n    FL7 --> FL8\n    FL8 --> FL9\n    FL9 --> FL10\n    FL10 --> FL11\n    FL11 --> FL12\n    FL12 --> FL13\n    FL13 --> FL14\n    FL14 --> FL15\n    FL15 --> FL16\n    FL16 --> FL17\n    FL17 --> FL18\n    FL18 --> FL19",
  "content_size": 6821,
  "collected_at": "2026-02-06T01:47:06.720966",
  "license": "none",
  "license_name": "No License",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0
}