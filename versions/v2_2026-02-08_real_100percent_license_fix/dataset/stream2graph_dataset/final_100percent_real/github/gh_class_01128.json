{
  "id": "gh_class_01128",
  "source": "github",
  "source_url": "https://github.com/distractdiverge/ship-gift/blob/22ba4ded08d13714f7579cd7aee9729ee4d3e7bb/docs/architecture/diagrams/data-model.mmd",
  "github_repo": "distractdiverge/ship-gift",
  "github_file_path": "docs/architecture/diagrams/data-model.mmd",
  "diagram_type": "class",
  "code": "```mermaid\nclassDiagram\n    class User {\n        +UUID id\n        +string email\n        +string phone\n        +boolean phone_verified\n        +string handle\n        +string avatar_url\n        +int reputation_score\n        +string[] roles\n        +timestamp created_at\n        +timestamp updated_at\n        +signUp()\n        +signIn()\n        +signOut()\n        +updateProfile()\n    }\n\n    class Address {\n        +UUID id\n        +UUID user_id\n        +string masked_token\n        +string city\n        +string state\n        +string country\n        +string zip_code\n        +boolean is_default\n        +timestamp created_at\n    }\n\n    class Item {\n        +UUID id\n        +UUID owner_id\n        +UUID category_id\n        +string title\n        +string description\n        +string[] photos\n        +string condition\n        +int weight_grams\n        +string dimensions\n        +string status\n        +boolean is_bundle_eligible\n        +timestamp bundle_deadline\n        +timestamp created_at\n        +timestamp updated_at\n        +create()\n        +update()\n        +claim()\n        +cancel()\n    }\n\n    class Category {\n        +UUID id\n        +string name\n        +string slug\n        +string description\n        +string icon\n        +UUID parent_id\n        +timestamp created_at\n    }\n\n    class Tag {\n        +UUID id\n        +string name\n        +string category\n        +string color\n        +timestamp created_at\n    }\n\n    class ItemTag {\n        +UUID item_id\n        +UUID tag_id\n    }\n\n    class ShippingQuote {\n        +UUID id\n        +UUID item_id\n        +string carrier\n        +string service\n        +int cost_cents\n        +int estimated_days\n        +string label_type\n        +timestamp expires_at\n        +timestamp created_at\n    }\n\n    class Shipment {\n        +UUID id\n        +UUID item_id\n        +UUID buyer_id\n        +UUID quote_id\n        +string tracking_number\n        +string carrier\n        +string service\n        +string label_url\n        +string status\n        +timestamp shipped_at\n        +timestamp delivered_at\n        +timestamp created_at\n        +timestamp updated_at\n        +generateLabel()\n        +updateTracking()\n        +markDelivered()\n    }\n\n    class Payment {\n        +UUID id\n        +UUID shipment_id\n        +string stripe_payment_intent_id\n        +int amount_cents\n        +string status\n        +timestamp refunded_at\n        +timestamp created_at\n        +processPayment()\n        +refund()\n    }\n\n    class Flag {\n        +UUID id\n        +UUID reporter_id\n        +string target_type\n        +UUID target_id\n        +string reason\n        +string description\n        +string status\n        +timestamp created_at\n        +review()\n        +resolve()\n        +dismiss()\n    }\n\n    %% User relationships\n    User \"1\" --> \"*\" Item : owns\n    User \"1\" --> \"*\" Shipment : receives\n    User \"1\" --> \"*\" Address : has\n    User \"1\" --> \"*\" Flag : reports\n\n    %% Item relationships\n    Item \"*\" --> \"1\" Category : belongs to\n    Item \"*\" --> \"*\" Tag : tagged with\n    Item \"1\" --> \"*\" ShippingQuote : has quotes\n    Item \"1\" --> \"*\" Shipment : shipped via\n\n    %% Junction table\n    Item \"*\" --> \"*\" ItemTag\n    Tag \"*\" --> \"*\" ItemTag\n\n    %% Shipment relationships\n    Shipment \"*\" --> \"1\" ShippingQuote : uses\n    Shipment \"1\" --> \"1\" Payment : paid by\n\n    %% Self-referential\n    Category \"1\" --> \"*\" Category : parent/child\n\n    %% Notes\n    note for User \"Default reputation: 100<br/>RLS: Users see own data only\"\n    note for Item \"Status: available → claimed → shipped → delivered<br/>RLS: Public if status=available\"\n    note for Address \"masked_token prevents address harvesting<br/>RLS: User private data only\"\n    note for Shipment \"Auto-refund if no carrier scan in 5 days\"\n    note for Payment \"Platform controls all payments (BR-002)\"\n```\n\n**Data Model Overview**\n\nThis diagram shows the key domain entities in ShipGift and their relationships.\n\n## Key Entities\n\n### Core Entities\n1. **User** - Platform users (buyers and sellers)\n2. **Item** - Items being given away\n3. **Shipment** - Shipping transactions\n4. **Payment** - Stripe payment records\n\n### Supporting Entities\n5. **Address** - Shipping addresses (privacy-protected)\n6. **Category** - Item classification\n7. **Tag** - Mutual aid tags\n8. **ShippingQuote** - Carrier rate quotes\n9. **Flag** - Content moderation reports\n10. **ItemTag** - Many-to-many junction table\n\n## Relationships\n\n### User Relationships (One-to-Many)\n- **User → Items:** One user can list many items\n- **User → Shipments:** One user can receive many shipments\n- **User → Addresses:** One user can have many addresses\n- **User → Flags:** One user can report many issues\n\n### Item Relationships\n- **Item → Category (Many-to-One):** Each item in one category\n- **Item → Tags (Many-to-Many):** Items can have multiple tags\n- **Item → ShippingQuotes (One-to-Many):** Item can have multiple quotes\n- **Item → Shipments (One-to-Many):** Item can be claimed multiple times (if cancelled)\n\n### Shipment Relationships\n- **Shipment → ShippingQuote (Many-to-One):** Shipment uses one selected quote\n- **Shipment → Payment (One-to-One):** Each shipment has one payment\n\n### Category Hierarchy\n- **Category → Category (Self-referential):** Supports nested categories\n\n## Business Rules Enforced\n\n### Structural Enforcement\n- **BR-001:** No price field on Item (items always free)\n- **BR-002:** Payment tied to Shipment (platform controls payments)\n- **BR-008:** Address has masked_token (privacy protection)\n\n### Constraint Enforcement\n- **BR-006:** Item.condition has CHECK constraint (enum values)\n- **BR-007:** Item.status has CHECK constraint (workflow states)\n- **BR-009:** Flag access controlled by RLS policy\n\n### Default Values\n- **BR-005:** User.reputation_score DEFAULT 100\n- **BR-012:** Item.status DEFAULT 'available'\n\n## Security (Row Level Security)\n\nAll tables have RLS policies:\n\n**Users:**\n- Users can only view/update their own profile\n- Public fields: id, handle, reputation_score, avatar_url\n\n**Items:**\n- Anyone can view items WHERE status='available'\n- Owners can view all their items regardless of status\n- Owners can insert/update their own items\n\n**Addresses:**\n- Users can only access their own addresses\n- Full address stored separately (not in schema)\n\n**Shipments:**\n- Visible only to buyer and seller (item owner)\n- Payment details restricted\n\n**Payments:**\n- Visible only to shipment participants\n- RLS prevents unauthorized access\n\n**Flags:**\n- Reporters can view their own flags\n- Admins with 'admin' role can view all flags\n\n## Type Safety\n\nAll entities have auto-generated TypeScript types:\n\n```typescript\nimport { Database } from '@/types/supabase'\n\ntype User = Database['public']['Tables']['users']['Row']\ntype Item = Database['public']['Tables']['items']['Row']\ntype Shipment = Database['public']['Tables']['shipments']['Row']\n// ... etc\n```\n\n**Generation Command:** `npm run db:generate`\n\n## File References\n\n- **Schema:** `supabase/migrations/20240101000000_initial_schema.sql`\n- **Types:** `src/types/supabase.ts` (auto-generated)\n- **Documentation:** `docs/requirements/data-model.md`\n",
  "content_size": 7116,
  "collected_at": "2026-02-06T01:53:21.455645",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0
}