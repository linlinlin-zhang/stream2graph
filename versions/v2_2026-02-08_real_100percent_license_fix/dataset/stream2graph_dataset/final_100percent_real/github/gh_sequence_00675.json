{
  "id": "gh_sequence_00675",
  "source": "github",
  "source_url": "https://github.com/sage-base/sagebase/blob/6b7ae62c050417c56b69a6edf140da51fe97be03/docs/diagrams/extraction-log-data-flow.mmd",
  "github_repo": "sage-base/sagebase",
  "github_file_path": "docs/diagrams/extraction-log-data-flow.mmd",
  "diagram_type": "sequence",
  "code": "# 抽出ログ データフロー\n\nこの図は、LLM抽出からGold Layer更新までのデータフローを示しています。\n\n## シーケンス図\n\n```mermaid\nsequenceDiagram\n    autonumber\n    participant LLM as LLM Service<br/>(Gemini API)\n    participant UseCase as UpdateEntityFromExtractionUseCase\n    participant LogRepo as ExtractionLogRepository\n    participant EntityRepo as EntityRepository\n    participant DB as Database\n\n    Note over LLM,DB: Phase 1: LLM抽出\n\n    LLM->>UseCase: 抽出結果 (ExtractionResult)\n\n    Note over LLM,DB: Phase 2: Bronze Layer 保存（常に実行）\n\n    UseCase->>UseCase: ExtractionLog作成\n    UseCase->>LogRepo: create(extraction_log)\n    LogRepo->>DB: INSERT INTO extraction_logs\n    DB-->>LogRepo: log_id\n    LogRepo-->>UseCase: log_id\n\n    Note over LLM,DB: Phase 3: Gold Layer 更新判定\n\n    UseCase->>EntityRepo: find_by_id(entity_id)\n    EntityRepo->>DB: SELECT * FROM entities\n    DB-->>EntityRepo: entity data\n    EntityRepo-->>UseCase: entity\n\n    alt is_manually_verified = true\n        Note right of UseCase: 人間が検証済み\n        UseCase-->>UseCase: スキップ\n        UseCase-->>LLM: UpdateEntityResult(updated=false, reason=\"manually_verified\")\n    else is_manually_verified = false\n        Note right of UseCase: 未検証（AI更新可能）\n\n        Note over LLM,DB: Phase 4: Gold Layer 更新\n\n        UseCase->>UseCase: エンティティに抽出結果を適用\n        UseCase->>EntityRepo: save(entity)\n        EntityRepo->>DB: UPDATE entities SET ... , latest_extraction_log_id = log_id\n        DB-->>EntityRepo: success\n        EntityRepo-->>UseCase: success\n        UseCase-->>LLM: UpdateEntityResult(updated=true, extraction_log_id=log_id)\n    end\n```\n\n## 手動検証フロー\n\n```mermaid\nsequenceDiagram\n    autonumber\n    participant User as ユーザー\n    participant UI as Streamlit UI\n    participant UseCase as MarkEntityAsVerifiedUseCase\n    participant EntityRepo as EntityRepository\n    participant DB as Database\n\n    User->>UI: エンティティを修正\n    User->>UI: 「検証済み」ボタンをクリック\n\n    UI->>UseCase: execute(entity_type, entity_id, is_verified=true)\n    UseCase->>EntityRepo: find_by_id(entity_id)\n    EntityRepo->>DB: SELECT * FROM entities\n    DB-->>EntityRepo: entity data\n    EntityRepo-->>UseCase: entity\n\n    UseCase->>UseCase: entity.mark_as_manually_verified()\n    UseCase->>EntityRepo: save(entity)\n    EntityRepo->>DB: UPDATE entities SET is_manually_verified = true\n    DB-->>EntityRepo: success\n    EntityRepo-->>UseCase: success\n    UseCase-->>UI: MarkEntityAsVerifiedOutputDto(success=true)\n    UI-->>User: \"検証済みとしてマークしました\"\n\n    Note over User,DB: 以降のAI抽出では更新されない\n```\n\n## 更新判定ロジック\n\n```mermaid\nflowchart TD\n    START([LLM抽出完了]) --> SAVE_LOG[Bronze Layer に保存<br/>extraction_logs]\n    SAVE_LOG --> GET_ENTITY[Gold Entity を取得]\n    GET_ENTITY --> CHECK{is_manually_verified?}\n\n    CHECK -->|true| SKIP[Gold 更新スキップ<br/>reason: manually_verified]\n    CHECK -->|false| UPDATE[Gold Entity 更新<br/>latest_extraction_log_id 設定]\n\n    SKIP --> RETURN_FALSE([UpdateEntityResult<br/>updated: false])\n    UPDATE --> RETURN_TRUE([UpdateEntityResult<br/>updated: true])\n\n    style SAVE_LOG fill:#fff3e0,stroke:#e65100\n    style SKIP fill:#ffebee,stroke:#c62828\n    style UPDATE fill:#e8f5e9,stroke:#2e7d32\n```\n\n## UseCase 実装パターン\n\n### UpdateEntityFromExtractionUseCase（基底クラス）\n\n```python\nasync def execute(\n    self,\n    entity_id: int,\n    extraction_result: TExtractionResult,\n    pipeline_version: str\n) -> UpdateEntityResult:\n    # Phase 1: Bronze Layer 保存（常に実行）\n    log = ExtractionLog(\n        entity_type=self._get_entity_type(),\n        entity_id=entity_id,\n        pipeline_version=pipeline_version,\n        extracted_data=self._to_extracted_data(extraction_result),\n        confidence_score=self._get_confidence_score(extraction_result),\n        extraction_metadata=self._get_metadata(extraction_result)\n    )\n    created_log = await self._extraction_log_repo.create(log)\n    log_id = created_log.id\n\n    # Phase 2: Gold Layer 取得\n    entity = await self._get_entity(entity_id)\n    if entity is None:\n        return UpdateEntityResult(updated=False, reason=\"entity_not_found\", extraction_log_id=log_id)\n\n    # Phase 3: 更新判定\n    if not entity.can_be_updated_by_ai():\n        return UpdateEntityResult(updated=False, reason=\"manually_verified\", extraction_log_id=log_id)\n\n    # Phase 4: Gold Layer 更新\n    await self._apply_extraction(entity, extraction_result, log_id)\n    await self._save_entity(entity)\n\n    return UpdateEntityResult(updated=True, extraction_log_id=log_id)\n```\n\n## 関連ADR\n\n- [ADR 0005: 抽出層とGold Layer分離](../ADR/0005-extraction-layer-gold-layer-separation.md)\n",
  "content_size": 4456,
  "collected_at": "2026-02-06T01:35:31.859405",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0
}