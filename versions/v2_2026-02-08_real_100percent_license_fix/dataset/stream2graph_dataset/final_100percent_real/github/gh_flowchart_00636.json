{
  "id": "gh_flowchart_00636",
  "source": "github",
  "source_url": "https://github.com/animicaorg/all/blob/81c5557a26defd300015b53827699b5d5989bb17/docs/diagrams/RANDOMNESS.mmd",
  "github_repo": "animicaorg/all",
  "github_file_path": "docs/diagrams/RANDOMNESS.mmd",
  "diagram_type": "flowchart",
  "code": "%% Mermaid: Randomness Pipeline — Commit/Reveal → VDF → Optional QRNG Mix\n%% View online: https://mermaid.live\n\nflowchart LR\n  %% ===================== ACTORS / STAGES =====================\n  subgraph USERS[Participants (Users/Contracts)]\n    direction TB\n    Prep[Prepare salt+payload]:::user\n    CommitTx[Submit commit: C = H(tag | addr | salt | payload)]:::user\n    RevealTx[Submit reveal: (salt, payload)]:::user\n    Consume[Consume beacon in contracts\\nor off-chain apps]:::user\n  end\n\n  subgraph CRW[Commit–Reveal Window (Node)]\n    direction TB\n    Sched[randomness.beacon.schedule\\n(round windows)]:::node\n    AcceptC[Accept commitment\\n(window open)]:::node\n    StoreC[Store commitment in KV]:::node\n    AcceptR[Accept reveal\\n(window open, commitment found)]:::node\n    VerifyR[Verify reveal ↔ commitment]:::node\n    Agg[Aggregate reveals\\n(hash-xor fold; bias-resistant)]:::node\n  end\n\n  subgraph VDF[VDF Stage]\n    direction TB\n    Input[Derive VDF input\\nfrom aggregate + prev beacon]:::node\n    Prover[VDF Prover (optional worker)\\nWesolowski π]:::worker\n    Verifier[VDF Verifier (consensus check)]:::node\n  end\n\n  subgraph QRNG[Optional QRNG Mixing]\n    direction TB\n    QR[Read QRNG bytes\\n(providers/file/http)]:::qrng\n    Attest[Attest QRNG provenance\\n(optional)]:::qrng\n    Mix[Extract-then-XOR with beacon\\n(transcript updated)]:::qrng\n  end\n\n  subgraph FIN[Finalize & Publish Beacon]\n    direction TB\n    Finalize[Finalize BeaconOut\\n{roundId, output, vdfProof, lightProof}]:::node\n    Persist[Persist state & history]:::node\n    Gossip[P2P gossip: beacon/light proof]:::p2p\n    RPC[RPC: rand.getBeacon, getHistory]:::rpc\n  end\n\n  subgraph LC[Light Clients / Verifiers]\n    direction TB\n    Light[Verify light_proof\\n(hash-chain + VDF proof)]:::light\n    Use[Use beacon for lotteries,\\nsybil beacons, scheduling]:::light\n  end\n\n  %% ===================== FLOWS =====================\n\n  %% Users → Commit–Reveal\n  Prep --> CommitTx --> Sched -->|if commit window open| AcceptC --> StoreC\n  StoreC -->|later| RevealTx --> AcceptR --> VerifyR --> Agg\n\n  %% Aggregation → VDF\n  Agg --> Input --> Prover -->|π| Verifier\n\n  %% VDF → Finalization\n  Verifier --> Finalize --> Persist --> Gossip --> RPC\n\n  %% Optional QRNG Mix (after VDF verify, before finalize OR as post-mix variant)\n  Verifier -. optional .-> QR\n  QR --> Attest --> Mix --> Finalize\n\n  %% Light clients & consumers\n  RPC --> Light --> Use\n  Finalize --> Consume\n\n  %% ===================== EVENTS (WS) =====================\n  subgraph EVENTS[Events / WS Notifications]\n    direction TB\n    E1[roundOpened]:::evt\n    E2[commitAccepted]:::evt\n    E3[revealAccepted]:::evt\n    E4[vdfVerified]:::evt\n    E5[beaconFinalized]:::evt\n  end\n  Sched --> E1\n  AcceptC --> E2\n  AcceptR --> E3\n  Verifier --> E4\n  Finalize --> E5\n\n  %% ===================== NOTES =====================\n  %% - Round schedule defines commit and reveal windows. Late/early submissions rejected.\n  %% - Commitment: domain-separated SHA3; binds addr + salt + payload; prevents reveal grinding.\n  %% - Aggregation: order-independent fold (e.g., H^*(concat) or XOR of hashes) to resist bias.\n  %% - VDF: Wesolowski proof π verified in consensus; prover may be miner/worker.\n  %% - Optional QRNG: mixed via extract-then-XOR; transcript must record bytes and source.\n  %% - Light proof: compact chain (prev→curr) + VDF proof lets light clients verify cheaply.\n  %% - All transitions are persisted with roundId and window boundaries to support audits.\n\n  %% ===================== STYLES =====================\n  classDef user fill:#d1fae5,stroke:#065f46,stroke-width:1,color:#064e3b;\n  classDef node fill:#e0f2fe,stroke:#075985,stroke-width:1,color:#0c4a6e;\n  classDef worker fill:#fde68a,stroke:#92400e,stroke-width:1,color:#78350f;\n  classDef qrng fill:#f5d0fe,stroke:#86198f,stroke-width:1,color:#701a75;\n  classDef p2p fill:#f3f4f6,stroke:#6b7280,stroke-width:1,color:#111827;\n  classDef rpc fill:#ddd6fe,stroke:#6d28d9,stroke-width:1,color:#4c1d95;\n  classDef light fill:#bbf7d0,stroke:#14532d,stroke-width:1,color:#064e3b;\n  classDef evt fill:#fee2e2,stroke:#991b1b,stroke-width:1,color:#7f1d1d;\n\n",
  "content_size": 4148,
  "collected_at": "2026-02-06T01:46:10.867152",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "ofl-1.1",
  "license_name": "SIL Open Font License 1.1",
  "license_url": "https://api.github.com/licenses/ofl-1.1",
  "repo_stars": 0,
  "repo_forks": 0
}