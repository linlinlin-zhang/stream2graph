{
  "id": "gh_sequence_00490",
  "source": "github",
  "source_url": "https://github.com/forepath/agenstra/blob/6a2b5d1006fcb07aeb873ca3cd0c6f8e184b2b85/libs/domains/framework/backend/feature-agent-manager/docs/sequence-http-vcs.mmd",
  "github_repo": "forepath/agenstra",
  "github_file_path": "libs/domains/framework/backend/feature-agent-manager/docs/sequence-http-vcs.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant Client as HTTP Client\n    participant API as AgentsVcsController<br/>(/api/agents/:id/vcs)\n    participant VcsService as AgentsVcsService\n    participant AgentService as AgentsService\n    participant Docker as DockerService\n    participant Container as Agent Container<br/>(/app)\n\n    Note over Client,Container: HTTP API - Agent VCS Operations\n\n    rect rgb(230, 240, 255)\n        Note over Client,Container: Get Git Status\n        Client->>API: GET /api/agents/{id}/vcs/status\n        API->>VcsService: getStatus(agentId)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git status --porcelain\")\n        Docker->>Container: Execute git status\n        Container-->>Docker: status output\n        Docker-->>VcsService: output string\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git branch --show-current\")\n        Docker->>Container: Execute git branch\n        Container-->>Docker: branch name\n        Docker-->>VcsService: branch name\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git rev-list --count @{u}..HEAD\")\n        Docker->>Container: Execute git rev-list\n        Container-->>Docker: ahead count\n        Docker-->>VcsService: ahead count\n        VcsService->>VcsService: parse status output to GitStatusDto\n        VcsService-->>API: GitStatusDto\n        API-->>Client: 200 OK<br/>{status, branches, files}\n    end\n\n    rect rgb(240, 255, 240)\n        Note over Client,Container: List Branches\n        Client->>API: GET /api/agents/{id}/vcs/branches\n        API->>VcsService: getBranches(agentId)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git branch -a\")\n        Docker->>Container: Execute git branch\n        Container-->>Docker: branch list\n        Docker-->>VcsService: branch list\n        VcsService->>VcsService: parse branches to GitBranchDto[]\n        VcsService-->>API: GitBranchDto[]\n        API-->>Client: 200 OK<br/>[branches]\n    end\n\n    rect rgb(255, 240, 240)\n        Note over Client,Container: Get File Diff\n        Client->>API: GET /api/agents/{id}/vcs/diff?path={filePath}\n        API->>VcsService: getFileDiff(agentId, filePath)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git diff --no-color {filePath}\")\n        Docker->>Container: Execute git diff\n        Container-->>Docker: diff output\n        Docker-->>VcsService: diff output\n        alt Binary file detected\n            VcsService->>Docker: sendCommandToContainer(containerId, \"stat -c%s {filePath}\")\n            Docker->>Container: Execute stat\n            Container-->>Docker: file size\n            Docker-->>VcsService: file size\n            VcsService->>VcsService: create GitDiffDto with size info only\n        else Text file\n            VcsService->>VcsService: parse diff, encode content to base64\n            VcsService->>VcsService: create GitDiffDto with content\n        end\n        VcsService-->>API: GitDiffDto\n        API-->>Client: 200 OK<br/>{diff}\n    end\n\n    rect rgb(255, 255, 230)\n        Note over Client,Container: Stage Files\n        Client->>API: POST /api/agents/{id}/vcs/stage<br/>{files: []}\n        API->>VcsService: stageFiles(agentId, files)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        alt files.length === 0\n            VcsService->>Docker: sendCommandToContainer(containerId, \"git add -A\")\n        else\n            VcsService->>Docker: sendCommandToContainer(containerId, \"git add {files}\")\n        end\n        Docker->>Container: Execute git add\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 204 No Content\n    end\n\n    rect rgb(255, 230, 255)\n        Note over Client,Container: Commit Changes\n        Client->>API: POST /api/agents/{id}/vcs/commit<br/>{message: \"...\"}\n        API->>VcsService: commit(agentId, message)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>VcsService: get commit author from ENV (GIT_AUTHOR_NAME, GIT_AUTHOR_EMAIL)\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git -c user.name='{name}' -c user.email='{email}' commit -m '{message}'\")\n        Docker->>Container: Execute git commit\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 204 No Content\n    end\n\n    rect rgb(240, 230, 255)\n        Note over Client,Container: Push Changes\n        Client->>API: POST /api/agents/{id}/vcs/push<br/>{force?: boolean}\n        API->>VcsService: push(agentId, force)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git push [--force-with-lease] [-u] origin {branch}\")\n        Docker->>Container: Execute git push<br/>(uses .netrc or SSH key)\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 204 No Content\n    end\n\n    rect rgb(230, 255, 240)\n        Note over Client,Container: Create Branch\n        Client->>API: POST /api/agents/{id}/vcs/branches<br/>{name, useConventionalPrefix, conventionalType}\n        API->>VcsService: createBranch(agentId, dto)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>VcsService: build branch name with prefix if needed\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git checkout -b {branchName}\")\n        Docker->>Container: Execute git checkout\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 201 Created\n    end\n\n    rect rgb(255, 240, 230)\n        Note over Client,Container: Switch Branch\n        Client->>API: POST /api/agents/{id}/vcs/branches/{branch}/switch\n        API->>VcsService: switchBranch(agentId, branch)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git checkout {branch}\")\n        Docker->>Container: Execute git checkout\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 204 No Content\n    end\n\n    rect rgb(240, 240, 255)\n        Note over Client,Container: Resolve Conflict\n        Client->>API: POST /api/agents/{id}/vcs/conflicts/resolve<br/>{path, strategy}\n        API->>VcsService: resolveConflict(agentId, dto)\n        VcsService->>AgentService: findOne(agentId)\n        AgentService-->>VcsService: agent entity\n        alt strategy === 'yours'\n            VcsService->>Docker: sendCommandToContainer(containerId, \"git checkout --theirs {path}\")\n        else if strategy === 'mine'\n            VcsService->>Docker: sendCommandToContainer(containerId, \"git checkout --ours {path}\")\n        else if strategy === 'both'\n            VcsService->>Docker: sendCommandToContainer(containerId, \"git checkout --conflict=diff3 {path}\")\n        end\n        Docker->>Container: Execute git checkout\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService->>Docker: sendCommandToContainer(containerId, \"git add {path}\")\n        Docker->>Container: Execute git add\n        Container-->>Docker: success\n        Docker-->>VcsService: success\n        VcsService-->>API: void\n        API-->>Client: 204 No Content\n    end\n",
  "content_size": 7884,
  "collected_at": "2026-02-06T01:33:01.065360",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License (Assumed)",
  "license_url": null,
  "repo_stars": 1,
  "repo_forks": 0,
  "repo_owner": "forepath",
  "repo_name": "agenstra",
  "repo_description": "Centralized management platform for distributed AI agent infrastructure with real-time interaction, code editing, and automated provisioning.",
  "repo_language": "TypeScript",
  "repo_topics": [
    "angular",
    "bootstrap",
    "clarity",
    "forepath",
    "framework"
  ],
  "repo_created_at": "2025-09-24T22:34:48Z",
  "repo_updated_at": "2026-02-04T23:08:27Z",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}