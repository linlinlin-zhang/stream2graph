{
  "id": "gh_sequence_00820",
  "source": "github",
  "source_url": "https://github.com/sethmcknight/quantic-msse-easy-park-plus/blob/039c5204b7b2c68b7ff94688985eb9bc26fba23c/project-submission/proposed-ddd-microservices-architecture/diagrams/sequence/mermaid/electric-vehicle-charging-sequence.mmd",
  "github_repo": "sethmcknight/quantic-msse-easy-park-plus",
  "github_file_path": "project-submission/proposed-ddd-microservices-architecture/diagrams/sequence/mermaid/electric-vehicle-charging-sequence.mmd",
  "diagram_type": "sequence",
  "code": "---\ntitle: Easy Park Plus - Electric Vehicle Charging Sequence Diagram (Proposed)\n---\n\nsequenceDiagram\n    participant EV_Driver as EV Driver\n    participant ChargerHW as Charger Hardware\n    participant ExtInt as External Integrations Service\n    participant EVCS as EV Charging Service\n    participant PO as Parking Operations Service\n    participant IMS as Infrastructure Management Service\n    participant PolMS as Policy Management Service\n    participant PS as Pricing Service\n    participant BS as Billing Service\n    participant IAET as Internal Audit & Event Trace Service\n    participant IES as Incident & Enforcement Service\n    participant MB as Message Broker\n\n    Note over EV_Driver, MB: Electric Vehicle Charging Session Flow\n\n    %% Vehicle Plug-in & Session Initialization\n    rect rgb(230, 245, 255)\n    Note over EV_Driver, EVCS: Charging Session Initialization\n    EV_Driver->>ChargerHW: Plugs in vehicle\n    ChargerHW->>ExtInt: PlugInEvent (chargerId, timestamp)\n    ExtInt->>MB: Publish(VehiclePluggedInEvent)\n    ExtInt->>EVCS: NotifyPlugIn(chargerId, timestamp)\n\n    EVCS->>PO: GetActiveVisitForCharger(chargerId) // Assumes charger is in a slot\n    PO-->>EVCS: VisitDetails (visitId, vehicleRegistration)\n\n    EVCS->>IMS: GetChargerDetails(chargerId)\n    IMS-->>EVCS: ChargerConfig (type, capabilities)\n    \n    alt Infrastructure Service Degraded\n        IMS-->>EVCS: ServiceDegradedResponse\n        EVCS->>PolMS: GetFallbackPolicy(lotId, \"ChargerInfoUnavailable\")\n        PolMS-->>EVCS: FallbackPolicy (use default charger config)\n        EVCS->>MB: Publish(FallbackPolicyAppliedEvent)\n    end\n    end\n\n    %% Policy Application & Session Creation\n    rect rgb(255, 245, 230)\n    Note over EVCS, PolMS: Policy Application & Authorization\n    EVCS->>PolMS: GetApplicableChargingPolicies(lotId, chargerType, customerType_if_known)\n    PolMS-->>EVCS: ChargingPolicies (e.g., GracePeriodPolicy for idle time)\n\n    EVCS->>EVCS: CreateChargingSession(visitId, vehicleRegistration, chargerId, policies)\n    EVCS->>MB: Publish(ChargingSessionStartedEvent)\n    EVCS-->>IAET: Publish(ChargingSessionStartedEvent)\n    EVCS-->>ExtInt: AuthorizeChargingCommand(chargerId)\n    ExtInt-->>ChargerHW: StartPowerDelivery\n    ChargerHW-->>EV_Driver: Charging initiated\n\n    Note over EVCS: ChargingSessionStatus: Charging\n    end\n\n    %% Active Charging Monitoring\n    rect rgb(240, 255, 240)\n    Note over ChargerHW, IAET: Energy Delivery Monitoring\n    loop Periodically during charging\n        ChargerHW->>ExtInt: EnergyDeliveryUpdate(chargerId, kWh_delivered)\n        ExtInt->>EVCS: NotifyEnergyUpdate(chargerId, kWh_delivered)\n        EVCS->>EVCS: RecordEnergyConsumption(sessionId, kWh_delivered)\n        EVCS->>MB: Publish(EnergyDeliveredUpdateEvent)\n        EVCS-->>IAET: Publish(EnergyDeliveredUpdateEvent)\n    end\n    end\n\n    %% Charging Completion & Grace Period\n    rect rgb(255, 240, 255)\n    Note over ChargerHW, IAET: Charging Session Completion\n    alt Charging completes (vehicle full or stopped by user via car/app)\n        ChargerHW->>ExtInt: ChargingCompletedEvent(chargerId, completionTime, totalEnergy)\n        ExtInt->>EVCS: NotifyChargingCompleted(chargerId, completionTime, totalEnergy)\n        EVCS->>EVCS: FinalizeEnergyDelivery(sessionId, totalEnergy, completionTime)\n        EVCS->>EVCS: ApplyGracePeriodPolicy(sessionId, policies)\n        EVCS->>MB: Publish(ChargingCompletedEvent)\n        EVCS-->>IAET: Publish(ChargingCompletedGracePeriodActiveEvent)\n        Note over EVCS: ChargingSessionStatus: GracePeriodActive\n        \n        alt Grace period expires and vehicle still plugged in\n            EVCS->>EVCS: StartIdleTimeTracking(sessionId)\n            EVCS->>MB: Publish(IdleTimeStartedEvent)\n            EVCS-->>IAET: Publish(IdleTimeStartedEvent)\n            Note over EVCS: ChargingSessionStatus: Idle\n        end\n    end\n    end\n\n    %% Fault Handling & Emergency Procedures\n    rect rgb(255, 235, 235)\n    Note over ChargerHW, IES: Charger Fault Management\n    alt Charger Fault Detected\n        ChargerHW->>ExtInt: FaultEvent(chargerId, faultCode, timestamp)\n        ExtInt->>EVCS: NotifyChargerFault(chargerId, faultCode, timestamp)\n        EVCS->>EVCS: HandleChargerFault(sessionId_if_active, chargerId, faultCode)\n        EVCS->>MB: Publish(ChargerFaultDetectedEvent)\n        EVCS-->>IAET: Publish(ChargerFaultDetectedEvent)\n        EVCS->>IES: ReportChargerFault(chargerId, faultDetails)\n        \n        alt Critical Charger Fault\n            EVCS->>PolMS: GetEmergencyPolicy(lotId, \"ChargerFault\")\n            PolMS-->>EVCS: EmergencyPolicy (safe shutdown procedures)\n            EVCS->>ExtInt: EmergencyStopCharging(chargerId)\n            EVCS->>MB: Publish(EmergencyChargingStopEvent)\n        end\n    end\n    end\n\n    %% Vehicle Unplug & Session Finalization\n    rect rgb(235, 255, 235)\n    Note over EV_Driver, MB: Session Completion & Billing\n    EV_Driver->>ChargerHW: Unplugs vehicle\n    ChargerHW->>ExtInt: UnplugEvent(chargerId, unplugTime)\n    ExtInt->>MB: Publish(VehicleUnpluggedEvent)\n    ExtInt->>EVCS: NotifyUnplug(chargerId, unplugTime)\n\n    EVCS->>EVCS: CompleteChargingSession(sessionId_or_chargerId, unplugTime)\n    \n    alt Pricing Service Available\n        EVCS->>PS: RequestChargingPrice(sessionId, energyConsumed, idleTime, chargingDuration, policies)\n        PS-->>EVCS: ChargingCostDetails\n        PS->>MB: Publish(ChargingPriceCalculatedEvent)\n    else Pricing Service Degraded\n        EVCS->>PolMS: GetFallbackPolicy(lotId, \"PricingDegraded\")\n        PolMS-->>EVCS: FallbackPolicy (use standard rates)\n        EVCS->>MB: Publish(FallbackPolicyAppliedEvent)\n    end\n    \n    opt Billing Service Available\n        EVCS->>BS: FinalizeBillForChargingSession(sessionId, visitId, chargingCostDetails)\n        BS-->>EVCS: BillingAcknowledged\n        BS->>MB: Publish(ChargingBillingFinalizedEvent)\n    end\n    \n    EVCS->>MB: Publish(ChargingSessionEndedEvent)\n    EVCS-->>IAET: Publish(ChargingSessionEndedEvent)\n\n    Note over EVCS: ChargingSessionStatus: Ended\n    Note over MB: All domain events published for downstream consumers\n    end",
  "content_size": 6120,
  "collected_at": "2026-02-06T01:37:30.049012",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}