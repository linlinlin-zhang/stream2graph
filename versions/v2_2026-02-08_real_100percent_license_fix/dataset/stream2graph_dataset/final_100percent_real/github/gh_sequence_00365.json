{
  "id": "gh_sequence_00365",
  "source": "github",
  "source_url": "https://github.com/JeromeDesseaux/fastapi_user_registration_production/blob/e51496c1a4c3b212e644238eccfec527b273e813/docs/diagrams/registration-sequence.mmd",
  "github_repo": "JeromeDesseaux/fastapi_user_registration_production",
  "github_file_path": "docs/diagrams/registration-sequence.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    participant Client\n    participant RateLimitMW as Rate Limit Middleware\n    participant MetricsMW as Metrics Middleware\n    participant API as FastAPI Routes\n    participant UC as RegisterUserUseCase\n    participant User as User Entity\n    participant Repo as PostgresRepository\n    participant DB as PostgreSQL\n    participant Queue as TaskQueue\n    participant Redis\n    participant Worker as Celery Worker\n    participant SMTP\n\n    Client->>RateLimitMW: POST /api/v1/users/register<br/>{\"email\": \"user@example.com\",<br/>\"password\": \"SecurePass123\"}\n\n    Note over RateLimitMW: Check rate limit<br/>5 requests/hour per IP\n    RateLimitMW->>Redis: ZREMRANGEBYSCORE<br/>ZCARD (count requests)\n    Redis-->>RateLimitMW: Allowed (under limit)\n    RateLimitMW->>Redis: ZADD (add request timestamp)\n\n    RateLimitMW->>MetricsMW: Forward request\n    Note over MetricsMW: Start timing request\n\n    MetricsMW->>API: Forward request\n    API->>API: Validate request (Pydantic)\n    API->>UC: execute(email, password)\n\n    UC->>Repo: find_by_email(email)\n    Repo->>DB: SELECT * FROM users<br/>WHERE email = $1\n    DB-->>Repo: None (user doesn't exist)\n    Repo-->>UC: None\n\n    UC->>User: create(email, password)\n    User->>User: validate_email()<br/>(regex check)\n    User->>User: validate_password()<br/>(min 8 chars)\n    User->>User: hash_password()<br/>(bcrypt, 12 rounds)\n    User->>User: generate_activation_code()<br/>(4-digit, 1000-9999)\n    User-->>UC: user instance\n\n    UC->>Repo: save(user)\n    Repo->>DB: INSERT INTO users<br/>(id, email, password_hash,<br/>activation_code, ...)\n    DB-->>Repo: OK\n    Repo-->>UC: user saved\n\n    UC->>Queue: enqueue_activation_email(email, code)\n    Queue->>Redis: Celery: publish task<br/>{email, code, template}\n    Redis-->>Queue: OK (task ID)\n    Queue-->>UC: task enqueued\n\n    UC-->>API: user\n    API-->>MetricsMW: 201 Created<br/>{\"id\": \"...\", \"email\": \"...\",<br/>\"is_activated\": false}\n\n    Note over MetricsMW: Calculate duration<br/>Store metrics in Redis\n    MetricsMW->>Redis: HINCRBY metrics:request_counts<br/>\"POST /api/v1/users/register\" 1\n    MetricsMW->>Redis: HINCRBY metrics:status_counts<br/>\"201\" 1\n    MetricsMW->>Redis: ZADD metrics:latencies:POST...<br/>timestamp:duration_ms\n    MetricsMW->>Redis: HINCRBY metrics:business<br/>\"registrations\" 1\n\n    MetricsMW-->>RateLimitMW: Response + metrics recorded\n    RateLimitMW-->>Client: 201 Created<br/>X-RateLimit-Limit: 5<br/>X-RateLimit-Remaining: 4<br/>{\"id\": \"...\", \"is_activated\": false}\n\n    Note over Redis,Worker: Async email processing<br/>(separate from API request)\n\n    Worker->>Redis: Celery: consume task\n    Redis-->>Worker: {email, code, template}\n    Worker->>Worker: Render email template<br/>(HTML + plain text)\n    Worker->>SMTP: SEND email<br/>Subject: Activate your account<br/>Body: Your code is XXXX\n    SMTP-->>Worker: 250 OK\n    Worker->>Redis: Task success (result)\n\n    Note over Client,SMTP: Key Design Decisions:<br/>1. Rate limit by IP (prevent bulk registration)<br/>2. Async email (fast API response ~200ms)<br/>3. Metrics in Redis (multi-worker aggregation)<br/>4. 4-digit code (user-friendly, 60s expiry)\n",
  "content_size": 3169,
  "collected_at": "2026-02-06T01:31:16.183186",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}