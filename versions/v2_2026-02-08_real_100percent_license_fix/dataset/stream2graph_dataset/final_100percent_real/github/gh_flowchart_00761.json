{
  "id": "gh_flowchart_00761",
  "source": "github",
  "source_url": "https://github.com/animicaorg/all/blob/81c5557a26defd300015b53827699b5d5989bb17/docs/diagrams/RETARGET.mmd",
  "github_repo": "animicaorg/all",
  "github_file_path": "docs/diagrams/RETARGET.mmd",
  "diagram_type": "flowchart",
  "code": "%% Mermaid: Difficulty Retarget — Θ (Theta) Update Loop\n%% View online: https://mermaid.live\n\nflowchart TB\n  %% ===================== INPUTS =====================\n  subgraph INPUTS[Inputs]\n    direction TB\n    ThetaPrev[Θₙ (previous threshold)\\n(µ-nats)]:::cons\n    LambdaTarget[λ_target (target blocks/sec)\\n= 1 / T_target]:::data\n    Window[Recent block timestamps\\n(last W heights)]:::data\n    Params[(Retarget Params)\\nβ (EMA), clamps (min/max),\\nstep caps, guard bands]:::data\n  end\n\n  %% ===================== WINDOW STATS =====================\n  subgraph STATS[Observed Window Statistics]\n    direction TB\n    Deltas[Δtᵢ = tsᵢ − tsᵢ₋₁ for window]:::calc\n    ClampOutliers[Clamp/trim jitters & outliers]:::calc\n    MeanDelta[\\n\\bar{Δt}_win (mean/median)\\n]:::calc\n  end\n\n  %% ===================== EMA =====================\n  subgraph EMA[Exponential Moving Average]\n    direction TB\n    EMADelta[EMA(Δt):\\nΔ̂ₙ = (1−β)·Δ̂ₙ₋₁ + β·\\bar{Δt}_win]:::calc\n    LambdaObs[λ_obs = 1 / Δ̂ₙ]:::calc\n  end\n\n  %% ===================== RATIO & LOG STEP =====================\n  subgraph RATIO[Ratio & Proposed Step]\n    direction TB\n    Ratio[r = λ_obs / λ_target]:::calc\n    LogStep[s* = k · ln(r)\\n(k is gain; units: µ-nats)]:::calc\n    ClampStep[Clamp s* to [s_min, s_max]]:::guard\n  end\n\n  %% ===================== GUARDS =====================\n  subgraph GUARDS[Guards & Stability]\n    direction TB\n    Deadband[Deadband: if |ln(r)| < ε → s = 0]:::guard\n    Hysteresis[Hysteresis around recent Θ to avoid flip-flop]:::guard\n    RateLimit[Rate-Limit per retarget: |Θₙ − Θₙ₋₁| ≤ step_cap]:::guard\n  end\n\n  %% ===================== OUTPUT =====================\n  subgraph OUTPUT[Update & Persist]\n    direction TB\n    ThetaNew[Θₙ₊₁ = Θₙ + s\\n(apply deadband, clamp, rate limit)]:::cons\n    Persist[Persist Θₙ₊₁ for next height\\n(broadcast in header hints)]:::core\n  end\n\n  %% ===================== FLOWS =====================\n  ThetaPrev --> OUTPUT\n  Window --> Deltas --> ClampOutliers --> MeanDelta --> EMADelta --> LambdaObs --> Ratio --> LogStep --> ClampStep --> ThetaNew\n  LambdaTarget --> Ratio\n  Params --> EMADelta\n  Params --> ClampStep\n  Params --> Deadband\n  Params --> Hysteresis\n  Params --> RateLimit\n  ClampStep --> Deadband --> Hysteresis --> RateLimit --> ThetaNew\n  ThetaNew --> Persist\n\n  %% ===================== NOTES =====================\n  %% Equivalents:\n  %% - Using µ-nats (fixed-point) keeps log/exp stable and deterministic.\n  %% - k (gain) tunes responsiveness; too high → oscillations, too low → sluggishness.\n  %% - Deadband ε avoids tiny jitter; Hysteresis & step_cap smooth abrupt changes.\n  %% - Window W and β control noise vs. lag; suggest W≈(5–20) blocks, β≈0.2–0.4.\n  %% - All ops must be deterministic (fixed rounding, saturating clamps).\n\n  %% ===================== STYLES =====================\n  classDef data fill:#f3f4f6,stroke:#888,stroke-width:1,color:#222;\n  classDef calc fill:#93c5fd,stroke:#225,stroke-width:1,color:#001;\n  classDef guard fill:#fde68a,stroke:#a16207,stroke-width:1,color:#442;\n  classDef cons fill:#34d399,stroke:#0b4,stroke-width:1,color:#062;\n  classDef core fill:#10b981,stroke:#0b4,stroke-width:1,color:#062;\n",
  "content_size": 3172,
  "collected_at": "2026-02-06T01:47:46.201236",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "ofl-1.1",
  "license_name": "SIL Open Font License 1.1",
  "license_url": "https://api.github.com/licenses/ofl-1.1",
  "repo_stars": 0,
  "repo_forks": 0
}