{
  "id": "gl_flowchart_00782",
  "source": "gitlab",
  "source_url": "https://github.com/Maha-Jr10/artisanat-explorer/blob/28ca0823c37524a2f6df3e98c60957132a03aae2/static/images/rag_architecture.mmd",
  "source_note": "collected_from_github_final",
  "github_repo": "Maha-Jr10/artisanat-explorer",
  "diagram_type": "flowchart",
  "code": "%% Mermaid Diagram: RAG Architecture & Data Flow\r\n%% Render with: mmdc -i static/images/rag_architecture.mmd -o static/images/rag_architecture.png\r\n%% Or use an online Mermaid live editor.\r\n\r\nflowchart LR\r\n    subgraph Sources\r\n        A1[\"Peinture_et_Calligraphie.xlsx\"]\r\n        A2[\"Poterie_et_Céramique.xlsx\"]\r\n    end\r\n\r\n    A1 --> B[\"Pandas Loader\\n(clean + normalize)\"]\r\n    A2 --> B\r\n\r\n    B --> C{\"Cache? (df_full.pkl valid)\"}\r\n    C -- Yes --> D1[\"Load DataFrame\\nfrom Pickle\"]\r\n    C -- No --> D2[\"Build Fresh DataFrame\\n+ enrich dimensions/prix\"]\r\n\r\n    D1 --> E[\"DataFrame df_full\"]\r\n    D2 --> E\r\n\r\n    E --> F{\"Vector Store Exists? (chroma_db dir)\"}\r\n\r\n    F -- Yes --> G[\"Chroma Load\\n+ metadata get\"]\r\n    F -- No --> H[\"Build Text Chunks\\n+ Metadata\"] --> I[\"Embed & Persist\\nChroma Vector Store\"]\r\n\r\n    G --> J{\"Metadata Version\\nMatches?\"}\r\n    J -- Yes --> K[\"Reconstruct df_full\\nfrom metadata\"] --> L[\"Retriever (k=5)\"]\r\n    J -- No --> H\r\n\r\n    I --> L\r\n\r\n    subgraph Request Handling\r\n        Q[\"/ask Endpoint\"]\r\n        H1[\"User Question\"] --> Q\r\n        S1[\"Session History\"] --> Q\r\n        Q --> P{\"Product Mention?\"}\r\n        P -- Yes --> P1[\"Product-Specific Prompt\"]\r\n        P -- No --> P2[\"General Prompt\\nGuidelines\"]\r\n        P1 --> R[\"LLM (Ollama)\"]\r\n        P2 --> R\r\n        R --> T[\"Raw Answer\\nMarkdown\"]\r\n        T --> U[\"Post-Processing\\n(newlines, spaces)\"]\r\n        U --> V[\"Markdown -> HTML\"]\r\n        V --> W[\"JSON Response\"]\r\n    end\r\n\r\n    L --> R\r\n\r\n    subgraph Health\r\n        H2[\"/health Endpoint\\n(ok, records, store_loaded, metadata_version)\"]\r\n    end\r\n\r\n    classDef source fill:#fdf6e3,stroke:#b58900,stroke-width:1px,color:#444;\r\n    classDef process fill:#e0f7fa,stroke:#00838f,stroke-width:1px,color:#044;\r\n    classDef decision fill:#fff3e0,stroke:#fb8c00,stroke-width:1px,color:#5d3a00;\r\n    classDef storage fill:#ede7f6,stroke:#5e35b1,stroke-width:1px,color:#311b92;\r\n    classDef endpoint fill:#f1f8e9,stroke:#33691e,stroke-width:1px,color:#1b5e20;\r\n    classDef llm fill:#fce4ec,stroke:#ad1457,stroke-width:1px,color:#880e4f;\r\n\r\n    class A1,A2 source;\r\n    class B,D1,D2,H,H1,S1,P1,P2,T,U,V process;\r\n    class C,F,J,P decision;\r\n    class E,I,G,K,L storage;\r\n    class Q,H2,W endpoint;\r\n    class R llm;",
  "content_size": 2272,
  "collected_at": "2026-02-06T14:20:17.649896",
  "compilation_status": "failed",
  "license": "gitlab_repo",
  "license_name": "GitLab Repository",
  "license_url": "https://gitlab.com",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}