{
  "id": "gl_packet-beta_00404",
  "source": "gitlab",
  "source_url": "https://github.com/vinq1911/coralie-sfu/blob/4c7fab98e1d4cafb4824d4abb5c19042ea84b7d0/docs/diagrams/room-lifecycle.mmd",
  "source_note": "collected_from_github_additional",
  "github_repo": "vinq1911/coralie-sfu",
  "diagram_type": "packet-beta",
  "code": "// Purpose: Room ownership lifecycle and epoch management diagram.\n// Scope: Shows lease acquisition, renewal, failover, and subscription flow.\n// If you are an AI agent: Update this when lease/epoch semantics change.\n//   Keep TTL values accurate (currently 3-5s). Show epoch increments on owner change.\n\nsequenceDiagram\n    participant PC as PolyCore\n    participant RD as RoomDirectory\n    participant ER as EdgeRelay\n    participant EP as EdgePop\n    participant V as Viewer\n\n    Note over PC,RD: Room Ownership Lifecycle\n\n    %% Initial lease acquisition\n    PC->>RD: AcquireLease(room_id, owner_id, addrs)\n    RD-->>PC: epoch=\"epoch-1\", ttl_ms=4000\n    Note over PC: PolyCore owns room<br/>Epoch: epoch-1\n\n    %% Lease renewal loop\n    loop Every 2 seconds\n        PC->>RD: RenewLease(room_id, owner_id, epoch-1)\n        RD-->>PC: renewed=true, ttl_ms=4000\n    end\n\n    %% EdgeRelay subscribes\n    ER->>RD: ResolveRoom(room_id)\n    RD-->>ER: owner_id, epoch=\"epoch-1\", active=true\n    ER->>PC: SubscribeProgram(room_id, want_rungs)\n    PC-->>ER: ProgramKey(epoch-1), ladder, UDP flows\n    Note over ER: Subscribed to epoch-1<br/>Receiving RTP/RTCP\n\n    %% Viewer joins\n    V->>EP: WebRTC Connect\n    EP->>ER: GetProgramFlow(room_id)\n    ER-->>EP: Flow info (epoch-1)\n    EP->>PC: Request Keyframe (via EdgeRelay)\n    PC-->>EP: H.264 IDR frame\n    EP-->>V: WebRTC Stream (epoch-1)\n\n    %% Owner failure scenario\n    Note over PC: Owner fails<br/>(no renewal for 5s)\n    RD->>RD: TTL expires<br/>epoch-1 invalidated\n\n    %% New owner acquires\n    PC->>RD: AcquireLease(room_id, new_owner_id, addrs)\n    RD-->>PC: epoch=\"epoch-2\", ttl_ms=4000\n    Note over PC: New owner<br/>Epoch: epoch-2\n\n    %% EdgeRelay detects epoch change\n    ER->>RD: ResolveRoom(room_id)\n    RD-->>ER: owner_id, epoch=\"epoch-2\", active=true\n    Note over ER: Epoch changed:<br/>epoch-1 → epoch-2\n    ER->>ER: Stop forwarding epoch-1 packets\n    ER->>PC: SubscribeProgram(room_id, want_rungs)\n    PC-->>ER: ProgramKey(epoch-2), ladder, UDP flows\n    Note over ER: Resubscribed to epoch-2\n\n    %% Viewer transitions\n    EP->>ER: GetProgramFlow(room_id)\n    ER-->>EP: Flow info (epoch-2)\n    EP->>PC: Request Keyframe (new epoch)\n    PC-->>EP: H.264 IDR frame (epoch-2)\n    EP-->>V: WebRTC Stream (epoch-2)\n    Note over V: Seamless transition<br/>to new epoch\n",
  "content_size": 2336,
  "collected_at": "2026-02-06T14:09:06.500919",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "vinq1911",
  "repo_name": "coralie-sfu",
  "repo_description": "Monorepo-style work directory for the Coralie SFU (Selective Forwarding Unit) system. Contains multiple independent service repositories as Git submodules, plus shared documentation, deployment config",
  "repo_language": "TypeScript",
  "repo_topics": [],
  "repo_created_at": "2026-01-22T12:25:37Z",
  "repo_updated_at": "2026-01-25T15:27:50Z"
}