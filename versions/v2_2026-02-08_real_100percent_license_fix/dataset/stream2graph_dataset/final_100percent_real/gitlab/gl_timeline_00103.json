{
  "id": "gl_timeline_00103",
  "source": "gitlab",
  "source_url": "https://github.com/ultrasoundlabs/untron-v3/blob/0d9744d83e96791fdb8807f12361f5716e21201d/docs/untron-v3.mmd",
  "source_note": "collected_from_github_additional",
  "github_repo": "ultrasoundlabs/untron-v3",
  "diagram_type": "timeline",
  "code": "%% Untron V3 protocol lifecycle (infographic-ready)\n%% Render (local):  npx -y @mermaid-js/mermaid-cli@latest -i docs/untron-v3.mmd -o docs/untron-v3.svg\n%% Render (docker): docker run --rm -v \"$PWD:/data\" ghcr.io/mermaid-js/mermaid-cli/mermaid-cli:latest -i /data/docs/untron-v3.mmd -o /data/docs/untron-v3.svg\n\nflowchart LR\n  %% -------------------------------------------------------------------------\n  %% LANE: ONE-TIME SETUP / CONFIG\n  %% -------------------------------------------------------------------------\n  subgraph SETUP[\"Setup / config (occasionally)\"]\n    direction TB\n    Admin[\"Owner / Admin\"]\n    Realtor[\"Realtor (allowlisted)\"]\n    LP[\"LP (allowlisted for deposits)\"]\n\n    AdminCfg[\"EVM Hub config:\\n- setUsdt\\n- setTronReader\\n- setSwapRate\\n- setBridger\\n- allowlists\\n- pause/unpause\"]\n    Admin --> AdminCfg\n  end\n\n  %% -------------------------------------------------------------------------\n  %% LANE: TRON SIDE (SOURCE CHAIN)\n  %% -------------------------------------------------------------------------\n  subgraph TRON[\"Tron lane (source chain)\"]\n    direction TB\n    Depositor[\"Depositor / end user\"]\n    ReceiverAddr[\"Deterministic receiver address\\n(predictable from controller+salt)\"]\n    TronUSDT[\"Tron USDT (TRC-20 contract)\"]\n\n    TronController[\"UntronController\\n- pullFromReceivers (permissionless)\\n- rebalanceUsdt (permissionless)\\n- emits event hash-chain tip\"]\n    Receiver[\"UntronReceiver (CREATE2)\\n- holds tokens\\n- only controller can pull()\"]\n    EventChainTip[\"Controller eventChainTip (sha256 hash-chain)\\nmaintained by UntronControllerIndex\"]\n\n    Depositor -->|\"TRC-20 transfer(to receiver, amount)\"| TronUSDT\n    TronUSDT -->|\"USDT credited to receiver address\"| ReceiverAddr\n    ReceiverAddr -. \"receiver may not be deployed yet\" .-> Receiver\n\n    TronController -->|\"deploy receiver if missing (CREATE2)\"| Receiver\n    TronController -->|\"pull(token, amount) from receivers\"| Receiver\n    TronController -->|\"emit PulledFromReceiver + other events\\n(advances eventChainTip)\"| EventChainTip\n  end\n\n  %% -------------------------------------------------------------------------\n  %% LANE: EVM HUB (DESTINATION/SETTLEMENT CHAIN)\n  %% -------------------------------------------------------------------------\n  subgraph EVM[\"EVM lane (UntronV3 hub)\"]\n    direction TB\n\n    Hub[\"UntronV3 hub (facets)\\n- LeaseFacet\\n- EntitleFacet\\n- ControllerFacet\\n- FillFacet\\n- LpFacet\\n(+ AdminFacet)\"]\n\n    LeaseTimeline[\"Lease timeline per receiverSalt\\n(active lease by timestamp)\\ncreated by createLease (realtor-only)\"]\n    PayoutCfg[\"Per-lease payout config\\n(targetChainId, targetToken, beneficiary)\\nmutable by lessee\"]\n\n    ClaimQueues[\"Claim queues (FIFO) keyed by targetToken\\nClaim.amountUsdt is always USDT-denominated\"]\n    NextIdx[\"nextIndexByTargetToken[targetToken]\\n(head cursor; filled slots deleted)\"]\n\n    LPVault[\"Fast-fill LP vault (principal-only)\\n- deposit: allowlisted\\n- withdraw: always allowed\\nlpPrincipal[lp] tracks principal\"]\n    HubUSDT[\"Hub-held USDT balance\\n(usdtBalance())\"]\n\n    TronReader[\"tronReader (ITronTxReader)\\nverifies Tron tx:\\n- finalized block headers\\n- inclusion proof\\n- success\\n- parses TriggerSmartContract\"]\n\n    SwapExec[\"SwapExecutor (per-hub)\\nexecutes arbitrary calls\\n+ enforces min output\"]\n\n    Bridger[\"IBridger registry\\nbridgers[targetToken][targetChainId]\"]\n\n    Fill[\"fill(targetToken, maxClaims, calls)\\n- plans batch by available USDT\\n- swaps once per targetToken (optional)\\n- pays locally or via bridger\\n- swap surplus -> filler incentive\"]\n\n    %% Lease creation + payout config\n    Realtor -->|\"createLease(receiverSalt,...)\"| Hub\n    Hub --> LeaseTimeline\n    Hub --> PayoutCfg\n\n    %% LP vault -> available USDT liquidity\n    LP -->|\"deposit(amount USDT)\"| Hub\n    Hub --> LPVault\n    LPVault --> HubUSDT\n\n    %% Claims are created by either fast or slow recognition paths\n    Hub --> ClaimQueues\n    ClaimQueues --> NextIdx\n\n    %% Fill uses USDT liquidity + optional swap + optional bridge\n    HubUSDT -->|\"fill() consumption\"| Hub\n    Hub --> Fill\n    Fill -->|\"if targetToken != USDT:\\nswap once for batch\"| SwapExec\n    Fill -->|\"local transfer OR bridge\"| Bridger\n  end\n\n  %% -------------------------------------------------------------------------\n  %% FAST PATH: PER-DEPOSIT PROOF -> CLAIM (PERMISSIONLESS)\n  %% -------------------------------------------------------------------------\n  subgraph FAST[\"Fast path (permissionless): prove deposit -> claim\"]\n    direction TB\n    PreEntitle[\"preEntitle(receiverSalt, blocks, tx, proof, index)\\n- replay-protected by txId\\n- enforces tx calls tronUsdt\\n- enforces recipient == predicted receiver\\n- attributes to active lease at tx timestamp\\n- recognizedRaw += raw\\n- unbackedRaw += raw\\n- books fees to protocolPnl\\n- enqueues claim(netOut) if > 0\"]\n\n    PreEntitle --> ClaimQueues\n  end\n\n  %% -------------------------------------------------------------------------\n  %% OPTIONAL ACCELERATOR: SUBJECTIVE PRE-ENTITLE (LP-SPONSORED)\n  %% -------------------------------------------------------------------------\n  subgraph SUBJECTIVE[\"Optional accelerator: LP-sponsored subjective pre-entitle\"]\n    direction TB\n    Subj[\"subjectivePreEntitle(txId guess, leaseId guess, raw guess)\\n- debits sponsor lpPrincipal immediately\\n- enqueues normal claim\\n- reimburses sponsor if later preEntitle proves exact match\"]\n    Subj --> ClaimQueues\n  end\n\n  %% -------------------------------------------------------------------------\n  %% SLOW PATH: CONTROLLER EVENT HASH-CHAIN -> BACKING + CLAIMS (PERMISSIONLESS)\n  %% -------------------------------------------------------------------------\n  subgraph SLOW[\"Slow path (permissionless): controller event-chain -> backing + claims\"]\n    direction TB\n    TipTx[\"Tron tx calls isEventChainTip(tipNew)\\n(provable successful tx)\"]\n\n    Relay[\"relayControllerEventChain(blocks, tx, proof, index, events)\\n- proves TipTx\\n- checks to == controller\\n- checks provided events hash-link lastTip->tipNew\\n- enqueues raw events\"]\n    Process[\"processControllerEvents(max)\\n- consumes queued events\\n- PulledFromReceiver:\\n  - updates lastReceiverPullTimestampByToken\\n  - if token==tronUsdt: repays unbackedRaw oldest-first\\n  - leftover becomes profit volume\\n  - profit volume -> claim under lease active at dumpTimestamp\\n- UsdtSet/UsdtRebalanced/ControllerUsdtTransfer update state/PnL\"]\n\n    Relay --> Process\n    Process --> LeaseTimeline\n    Process --> ClaimQueues\n  end\n\n  %% -------------------------------------------------------------------------\n  %% DESTINATION (OPTIONAL): BRIDGE DELIVERY\n  %% -------------------------------------------------------------------------\n  subgraph DEST[\"Destination chain (optional)\"]\n    direction TB\n    Beneficiary[\"Beneficiary receives\\n- local transfer, or\\n- bridged delivery\"]\n  end\n\n  %% -------------------------------------------------------------------------\n  %% CROSS-LANE CONNECTIONS\n  %% -------------------------------------------------------------------------\n  %% Fast path uses tronReader to verify the deposit proof\n  PreEntitle -->|\"uses\"| TronReader\n  TronReader -->|\"verifies included tx\\n+ returns txId,timestamp,to,calldata\"| PreEntitle\n  TronUSDT -->|\"deposit tx is about this contract\"| PreEntitle\n  ReceiverAddr -->|\"recipient must match predicted receiver\"| PreEntitle\n  LeaseTimeline -->|\"active lease at tx timestamp\"| PreEntitle\n\n  %% Subjective reconciliation happens inside preEntitle (if a subjective record exists for txId)\n  Subj -. \"later: preEntitle reimburses sponsor if exact match\" .-> PreEntitle\n\n  %% Slow path uses tronReader to prove the isEventChainTip call happened on Tron\n  TipTx -->|\"proved by\"| TronReader\n  TronReader --> Relay\n  EventChainTip -->|\"tipNew equals controller state\\nat proved block\"| Relay\n\n  %% Filling settles to beneficiary (directly or via bridger)\n  Bridger --> Beneficiary\n  Hub -->|\"if targetChainId == chainid:\\ntransfer(targetToken, beneficiary)\"| Beneficiary\n\n  %% -------------------------------------------------------------------------\n  %% STYLING (lightweight)\n  %% -------------------------------------------------------------------------\n  classDef perm fill:#E8FFF0,stroke:#0E7A39,stroke-width:1px,color:#0E7A39;\n  classDef permOnly fill:#FFF3E0,stroke:#B26A00,stroke-width:1px,color:#7A3F00;\n  classDef core fill:#EEF5FF,stroke:#2B62D6,stroke-width:1px,color:#133B8A;\n  classDef data fill:#F3F4F6,stroke:#6B7280,stroke-width:1px,color:#111827;\n\n  class PreEntitle,Relay,Process perm;\n  class TronController perm;\n  class Fill perm;\n\n  class Realtor,LP,Admin permOnly;\n  class Hub,SwapExec,TronReader core;\n  class LeaseTimeline,PayoutCfg,ClaimQueues,EventChainTip,HubUSDT,LPVault,NextIdx data;\n",
  "content_size": 8735,
  "collected_at": "2026-02-06T14:02:45.184165",
  "compilation_status": "failed",
  "license": "mit",
  "license_name": "MIT License",
  "license_url": "https://api.github.com/licenses/mit",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "ultrasoundlabs",
  "repo_name": "untron-v3",
  "repo_description": "Horizontally scalable cross-chain liquidity protocol for Tron and EVM with bulletproof security",
  "repo_language": "Rust",
  "repo_topics": [],
  "repo_created_at": "2025-05-11T08:54:43Z",
  "repo_updated_at": "2026-02-06T09:38:30Z",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}