{
  "id": "ot_gantt_00781",
  "source": "other",
  "source_url": "https://github.com/CuongHayHo/Baidoxe/blob/97595273a689580af51dbcfd5c549ab001570e52/Analysis_Reports_VI/DIAGRAM_ESP32_OPERATION.mmd",
  "source_type": "github_search_special",
  "github_repo": "CuongHayHo/Baidoxe",
  "diagram_type": "gantt",
  "code": "%% ESP32 Sensors - Pull Model: Backend-Driven Request/Response\n\nsequenceDiagram\n    participant Backend as Backend Server<br/>Flask 5000\n    participant ESP32 as ESP32<br/>HTTP Server<br/>Port 80\n    participant Shift as 74HC595<br/>Shift Register\n    participant Mux as CD74HC4067<br/>MUX\n    participant Sensor as HC-SR04<br/>Sensor\n    participant Cache as currentDistances[]<br/>Array\n    \n    rect rgb(200, 220, 255)\n        note right of Backend: T=0: Backend Polling (every 30 minutes)\n        Backend->>ESP32: GET /data\n    end\n    \n    rect rgb(220, 240, 220)\n        note right of ESP32: T=10-50ms: Return Cached Data\n        ESP32->>Cache: Get currentDistances[0..14]\n        Cache->>ESP32: Array values\n        ESP32->>ESP32: Build JSON response<br/>success, soIC=2, totalSensors=15<br/>data[], timestamp\n        ESP32->>Backend: Response 200 OK\n    end\n    \n    rect rgb(240, 240, 200)\n        note right of Backend: T=100-200ms: Update DB\n        Backend->>Backend: Parse response<br/>occupied = distance <= 15cm\n        Backend->>Backend: Update 15 parking slots<br/>in database\n    end\n    \n    rect rgb(200, 220, 240)\n        note right of Backend: Optional: Backend Request Rescan\n        Backend->>ESP32: POST /detect<br/>(force fresh scan)\n    end\n    \n    rect rgb(220, 240, 200)\n        note right of ESP32: T=300ms: Start Sensor Scan (15 seconds)\n        ESP32->>ESP32: Call shiftbyteICs()\n    end\n    \n    loop For each sensor (1 to 15, ~1 second each)\n        rect rgb(255, 240, 200)\n            note right of Shift: Shift register control\n            ESP32->>Shift: shiftOut BIT_8[b]<br/>shiftOut BIT_8[a]\n            Shift->>Mux: Q0-Q7 active (relay power)\n        end\n        \n        rect rgb(240, 220, 200)\n            note right of Mux: MUX channel select\n            ESP32->>Mux: digitalWrite S0-S3<br/>select channel\n            Mux->>Sensor: Route TRIG/ECHO\n        end\n        \n        rect rgb(200, 240, 220)\n            note right of Sensor: HC-SR04 measurement\n            ESP32->>Sensor: Send TRIG pulse\n            Sensor->>Sensor: Measure ECHO (timeout 30ms)\n            Sensor->>ESP32: ECHO time microseconds\n        end\n        \n        rect rgb(220, 240, 220)\n            note right of Cache: Store result\n            ESP32->>Cache: distance = echoUs * 0.034 / 2\n            Cache->>Cache: currentDistances[i] = distance\n        end\n        \n        ESP32->>ESP32: delay(1000)\n    end\n    \n    rect rgb(240, 220, 200)\n        note right of ESP32: T=15.3s: Scan Complete\n        ESP32->>ESP32: All 15 sensors scanned<br/>currentDistances[] updated\n        ESP32->>Backend: Response 200 OK<br/>with fresh data\n    end\n\n---\n\n%% ESP32 Sensors - 74HC595 Shift Register + CD74HC4067 MUX Timing\n\ngantt\n    title ESP32 Sensor Scan Cycle: 15 Sensors x 1 Second = 15 Seconds\n    dateFormat YYYY-MM-DD HH:mm:ss\n    \n    section 74HC595 Control\n    Reset MR (LOW then HIGH) :shift1, 2025-12-26 00:00:00, 5ms\n    Shift out IC2 BIT_8[b] :shift2, 2025-12-26 00:00:00, 100ms\n    Shift out IC1 BIT_8[a] :shift3, 2025-12-26 00:00:00, 100ms\n    Latch ST (LOW→HIGH) :shift4, 2025-12-26 00:00:00, 5ms\n    \n    section Relay & Power\n    Relay settling time :relay1, 2025-12-26 00:00:00, 1s\n    \n    section Sensor Scanning\n    Sensor 1 read :sensor1, 2025-12-26 00:00:00, 1s\n    Sensor 2-5 read (4x) :sensor2, 2025-12-26 00:00:01, 4s\n    Sensor 6-10 read (5x) :sensor3, 2025-12-26 00:00:05, 5s\n    Sensor 11-15 read (5x) :sensor4, 2025-12-26 00:00:10, 5s\n    \n    section Complete Cycle\n    Total scan time :total, 2025-12-26 00:00:00, 15s\n    Ready for next poll :crit, 2025-12-26 00:00:15, 100ms\n\n---\n\n%% ESP32 Sensors - Main Loop (Pull Model)\n\nflowchart TD\n    A[\"loop() START<br/>Continuous\"] --> B[\"checkWiFiConnection()\"]\n    \n    B --> C{\"WiFi check<br/>timer >= 30s?\"]\n    C -->|No| D[\"Continue\"]\n    C -->|Yes| E{\"WiFi<br/>connected?\"]\n    E -->|Yes| F[\"Log status\"]\n    E -->|No| G[\"reconnectWiFi()<br/>timeout 10s\"]\n    \n    F --> D\n    G --> D\n    \n    D --> H[\"server.handleClient()\"]\n    H --> I{\"HTTP Request<br/>received?\"]\n    \n    I -->|GET /data| J[\"handleGetData()\"]\n    J --> K[\"Return cached<br/>currentDistances[]<br/>as JSON\"]\n    \n    I -->|POST /detect| L[\"handleDetect()\"]\n    L --> M[\"Call shiftbyteICs()\"]\n    M --> N[\"Scan all 15 sensors<br/>~15 seconds\"]\n    N --> O[\"Update currentDistances[]<br/>with fresh values\"]\n    O --> P[\"Return fresh data<br/>as JSON\"]\n    \n    I -->|OPTIONS| Q[\"handleCORS()\"]\n    Q --> R[\"Send CORS headers\"]\n    \n    I -->|Other| S[\"handleNotFound()\"]\n    S --> T[\"Send 404\"]\n    \n    I -->|None| U[\"Wait for next\"]\n    U --> U\n    \n    K --> V[\"Response 200 OK\"]\n    P --> V\n    R --> V\n    T --> V\n    \n    V --> W[\"delay(100ms)\"]\n    W --> X[\"Loop back\"]\n    X --> A\n    \n    style H fill:#fff3cd\n    style J fill:#c8e6c9\n    style L fill:#ffcccc\n    style M fill:#ffcccc\n\n---\n\n%% ESP32 Sensors - HTTP Server Endpoints (Pull Model)\n\nflowchart LR\n    A[\"Backend<br/>Flask Server<br/>192.168.4.2:5000\"] -->|GET /data<br/>frequent| B[\"handleGetData()\"]\n    A -->|POST /detect<br/>occasional| C[\"handleDetect()\"]\n    A -->|OPTIONS /data<br/>CORS preflight| D[\"handleCORS()\"]\n    \n    B --> E[\"Get cached<br/>currentDistances[]\"]\n    E --> F[\"Build JSON:<br/>success=true<br/>soIC=2<br/>totalSensors=15<br/>timestamp<br/>data[0..14]<br/>wifi_connected<br/>wifi_rssi\"]\n    F --> G[\"Send 200 OK<br/>application/json\"]\n    \n    C --> H[\"Call shiftbyteICs()\"]\n    H --> I[\"Loop through 15 sensors<br/>Shift + MUX + read<br/>~1 second per sensor<br/>~15 seconds total\"]\n    I --> J[\"Update currentDistances[]<br/>with fresh measurements\"]\n    J --> K[\"Build JSON:<br/>success=true<br/>message='Da detect lai 15 cam bien'<br/>soIC=2<br/>totalSensors=15<br/>timestamp<br/>data[0..14]<br/>wifi_connected<br/>wifi_rssi\"]\n    K --> L[\"Send 200 OK\"]\n    \n    D --> M[\"Send CORS Headers:<br/>Access-Control-Allow-Origin: *<br/>Access-Control-Allow-Methods<br/>Access-Control-Allow-Headers\"]\n    M --> N[\"Send 200 OK\"]\n    \n    G --> O[\"Response sent\"]\n    L --> O\n    N --> O\n    O --> A\n    \n    style A fill:#c8e6c9\n    style B fill:#e3f2fd\n    style C fill:#fff3cd\n    style D fill:#f3e5f5\n\n---\n\n%% ESP32 Sensors - 74HC595 + MUX Sensor Selection Logic\n\nflowchart TD\n    A[\"shiftbyteICs()<br/>scan 15 sensors\"] --> B[\"Initialize:<br/>a=1, b=0, count=0\"]\n    \n    B --> C[\"Loop: while b != 9\"]\n    C --> D[\"Check: a == 9?\"]\n    D -->|Yes| E[\"Reset a=0<br/>Increment b++\"]\n    D -->|No| F[\"Continue\"]\n    E --> F\n    \n    F --> G[\"74HC595 Reset MR:<br/>Set LOW then HIGH\"]\n    G --> H[\"Shift out BIT_8[b]<br/>via shiftOut MSBFIRST\"]\n    H --> I[\"Shift out BIT_8[a]<br/>via shiftOut MSBFIRST\"]\n    I --> J[\"Latch ST:<br/>LOW → HIGH\"]\n    J --> K[\"Enable OE:<br/>Set LOW\"]\n    \n    K --> L[\"Relay settling<br/>delay(1000ms)\"]\n    \n    L --> M[\"Calculate channel:<br/>channel = (b==0)<br/>? (a-1)<br/>: (7+b)\"]\n    \n    M --> N[\"readDistanceCmMux(channel)\"]\n    N --> O[\"MUX select: S0-S3 bits\"]\n    O --> P[\"HC-SR04 measure<br/>Send TRIG<br/>Measure ECHO<br/>timeout 30ms\"]\n    P --> Q[\"distance = echoUs<br/>* 0.034 / 2\"]\n    \n    Q --> R[\"currentDistances[count]<br/>= distance\"]\n    R --> S[\"count++\"]\n    S --> T{\"count < 15<br/>and<br/>b != 9?\"]\n    \n    T -->|Yes| U[\"Next iteration<br/>a or b increment\"]\n    U --> C\n    T -->|No| V[\"Loop exit\"]\n    V --> W[\"Disable ST<br/>Set LOW\"]\n    W --> X[\"Scan complete\"]\n    \n    style C fill:#fff3cd\n    style N fill:#ffcccc\n    style R fill:#c8e6c9\n\n---\n\n%% ESP32 Sensors vs UNO R4 WiFi Architecture\n\ngraph TB\n    subgraph UNO[\"UNO R4 WiFi<br/>(Event-Driven / Push)\"]\n        U1[\"RFID Readers<br/>Active listening\"]\n        U2[\"Loop: 10ms<br/>10ms = 100 Hz\"]\n        U3[\"State Machine<br/>Barrier Control<br/>(8 states)\"]\n        U4[\"HTTP Client<br/>POST /api/cards/scan<br/>Event-triggered\"]\n        U1 --> U2 --> U3 --> U4\n    end\n    \n    subgraph ESP[\"ESP32<br/>(Pull-Based)\"]\n        E1[\"WiFi Check<br/>every 30s<br/>reconnect timeout 10s\"]\n        E2[\"Loop: 100ms<br/>100ms = 10 Hz<br/>handle requests\"]\n        E3[\"HTTP Server<br/>Port 80<br/>Pull Model\"]\n        E4[\"On request:<br/>GET /data (cache)<br/>POST /detect (scan)\"]\n        E1 --> E2 --> E3 --> E4\n    end\n    \n    subgraph Backend[\"Backend<br/>Flask 5000\"]\n        B1[\"POST /api/cards/scan<br/>from UNO R4<br/>Event-driven\"]\n        B2[\"GET /api/parking-slots<br/>to ESP32<br/>Poll every 30min\"]\n        B3[\"Business Logic<br/>Database<br/>Parking Rules\"]\n        B1 --> B3\n        B2 --> B3\n    end\n    \n    U4 -.->|HTTP POST<br/>immediate| B1\n    E4 -.->|HTTP GET/POST<br/>on demand| B2\n    \n    style UNO fill:#e3f2fd\n    style ESP fill:#f3e5f5\n    style Backend fill:#c8e6c9\n",
  "content_size": 8667,
  "collected_at": "2026-02-06T10:46:50.553951",
  "compilation_status": "failed",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "license": "other_source",
  "license_name": "Other Source (GitHub-based)"
}