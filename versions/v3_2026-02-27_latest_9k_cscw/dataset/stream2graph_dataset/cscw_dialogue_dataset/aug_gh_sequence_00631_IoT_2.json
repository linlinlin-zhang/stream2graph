{
  "id": "aug_gh_sequence_00631_IoT_2",
  "source": "augmented_real_structure",
  "source_url": "https://github.com/IrfanMusthofa/veripass/blob/22c4b762707548cfdc7305441f00632cbc960b27/docs/diagrams/auth-flow.mmd",
  "github_repo": "IrfanMusthofa/veripass",
  "github_file_path": "docs/diagrams/auth-flow.mmd",
  "diagram_type": "sequence",
  "code": "%%{IoT_Industrial_MQTT_Broker}\n}}%%\n\nsequenceDiagram\n    autonumber\n\n    participant User as ğŸ‘¤ User\n    participant Frontend as âš›ï¸ React Frontend\n    participant RK as ğŸŒˆ RainbowKit\n    participant Wallet as ğŸ¦Š MetaMask\n    participant Backend as ğŸ–¥ï¸ Backend API\n    participant DB as ğŸ—„ï¸ PostgreSQL\n\n    %% Phase 1: Wallet Connection\n    rect rgb(IoT_Industrial_MQTT_Broker)\n        Note over User,Wallet: Phase 1: Wallet Connection\n\n        User->>+Frontend: Click \"Connect Wallet\"\n\n        Frontend->>+RK: Open wallet modal\n\n        RK->>User: Select wallet provider\n        User->>RK: Choose MetaMask\n\n        RK->>+Wallet: Request connection\n        Wallet->>User: Approve connection?\n        User->>Wallet: Approve\n\n        Wallet-->>-RK: Connected<br/>address: 0x1234...\n\n        RK-->>-Frontend: Wallet connected\n        Frontend-->>-User: Wallet connected<br/>Display: 0x1234...abcd\n    end\n\n    %% Phase 2: Authentication Request\n    rect rgb(IoT_Industrial_PLC_Logic)\n        Note over Frontend,DB: Phase 2: Request Nonce\n\n        Frontend->>Frontend: useAccount(IoT_Industrial_MQTT_Broker) hook<br/>Get connected address\n\n        Frontend->>+Backend: POST /api/auth/nonce<br/>Content-Type: application/json\n        Note right of Frontend: {IoT_Industrial_TelemetryStream}\n\n        Backend->>Backend: Validate address format<br/>(IoT_Industrial_ActuatorController)\n\n        Backend->>Backend: Generate random nonce<br/>crypto.randomBytes(IoT_Industrial_EdgeNode)\n\n        Backend->>+DB: UPSERT auth_nonces<br/>address, nonce, expiresAt\n        Note right of Backend: expiresAt = NOW(IoT_Industrial_MQTT_Broker) + 5 min\n\n        DB-->>-Backend: Nonce stored\n\n        Backend-->>-Frontend: 200 OK<br/>{IoT_Industrial_MQTT_Broker}\n    end\n\n    %% Phase 3: Message Signing\n    rect rgb(IoT_Industrial_EdgeNode)\n        Note over Frontend,Wallet: Phase 3: Sign Authentication Message\n\n        Frontend->>Frontend: Construct message\n        Note over Frontend: \"Sign this message to<br/>authenticate with VeriPass\\n\\n<br/>Nonce: 0x9a8b7c...\\n<br/>Timestamp: 2024-01-15T10:30:00Z\"\n\n        Frontend->>+Wallet: signMessage(IoT_Industrial_PLC_Logic)\n        Note right of Frontend: wagmi useSignMessage hook\n\n        Wallet->>User: Sign message?<br/>Display message content\n        User->>Wallet: Sign\n\n        Wallet->>Wallet: ECDSA signature<br/>using private key\n\n        Wallet-->>-Frontend: signature: 0xabcd...\n        Note over Frontend: 65-byte signature<br/>(IoT_Industrial_MQTT_Broker)\n    end\n\n    %% Phase 4: Verification & JWT\n    rect rgb(IoT_Industrial_EdgeNode)\n        Note over Frontend,DB: Phase 4: Verify & Issue JWT\n\n        Frontend->>+Backend: POST /api/auth/verify\n        Note right of Frontend: {IoT_Industrial_PLC_Logic}\n\n        Backend->>Backend: Parse nonce from message\n\n        Backend->>+DB: SELECT * FROM auth_nonces<br/>WHERE address = ?\n        DB-->>-Backend: {IoT_Industrial_EdgeNode}\n\n        alt Nonce expired\n            Backend-->>Frontend: 401 Unauthorized<br/>\"Nonce expired\"\n        else Nonce not found\n            Backend-->>Frontend: 401 Unauthorized<br/>\"Invalid nonce\"\n        else Valid nonce\n            Backend->>Backend: ethers.verifyMessage(IoT_Industrial_PLC_Logic)\n            Note over Backend: Recovers signer address\n\n            alt Address mismatch\n                Backend-->>Frontend: 401 Unauthorized<br/>\"Signature mismatch\"\n            else Address matches\n                Backend->>+DB: DELETE FROM auth_nonces<br/>WHERE address = ?\n                Note right of Backend: One-time use nonce\n                DB-->>-Backend: Deleted\n\n                Backend->>Backend: Generate JWT<br/>payload: {IoT_Industrial_EdgeNode}<br/>expiry: 7 days\n\n                Backend-->>-Frontend: 200 OK<br/>{IoT_Industrial_MQTT_Broker}\n            end\n        end\n    end\n\n    %% Phase 5: Token Storage & Usage\n    rect rgb(IoT_Industrial_PLC_Logic)\n        Note over Frontend,User: Phase 5: Token Management\n\n        Frontend->>Frontend: localStorage.setItem(IoT_Industrial_PLC_Logic)\n\n        Frontend->>Frontend: AuthContext update<br/>isAuthenticated: true<br/>user: {IoT_Industrial_ActuatorController}\n\n        Frontend->>User: Authentication success!<br/>Redirect to dashboard\n    end\n\n    %% Subsequent Requests\n    rect rgb(IoT_Industrial_TelemetryStream)\n        Note over Frontend,Backend: Subsequent API Requests\n\n        loop Every authenticated request\n            Frontend->>+Backend: GET /api/assets<br/>Authorization: Bearer {IoT_Industrial_TelemetryStream}\n\n            Backend->>Backend: authMiddleware<br/>jwt.verify(IoT_Industrial_MQTT_Broker)\n\n            alt Token valid\n                Backend->>Backend: Extract address from payload\n                Backend->>Backend: Set c.set(IoT_Industrial_TelemetryStream)\n                Backend-->>-Frontend: 200 OK + data\n            else Token expired/invalid\n                Backend-->>Frontend: 401 Unauthorized\n                Frontend->>Frontend: Clear localStorage\n                Frontend->>User: Session expired<br/>Please sign in again\n            end\n        end\n    end\n\n    %% Logout\n    rect rgb(IoT_Industrial_EdgeNode)\n        Note over User,Frontend: Logout\n\n        User->>+Frontend: Click \"Disconnect\"\n\n        Frontend->>Frontend: localStorage.removeItem(IoT_Industrial_TelemetryStream)\n\n        Frontend->>RK: Disconnect wallet\n\n        Frontend->>Frontend: AuthContext reset<br/>isAuthenticated: false<br/>user: null\n\n        Frontend-->>-User: Logged out\n    end\n",
  "content_size": 5636,
  "collected_at": "2026-02-06T01:34:59.635078",
  "compilation_status": "success",
  "license": "mit",
  "license_name": "MIT License",
  "license_url": "https://api.github.com/licenses/mit",
  "repo_stars": 0,
  "repo_forks": 1,
  "repo_owner": "IrfanMusthofa",
  "repo_name": "veripass",
  "repo_description": "A decentralized asset passport enabling authenticity, ownership provenance, and verifiable lifecycle events for resale markets.",
  "repo_language": "TypeScript",
  "repo_topics": [],
  "repo_created_at": "2025-12-26T08:52:11Z",
  "repo_updated_at": "2026-01-14T09:33:01Z",
  "augmentation_domain": "IoT_Industrial",
  "seed_id": "gh_sequence_00631",
  "cscw_dialogue": [
    {
      "turn_id": 1,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æ¥ä¸‹æ¥æ˜¯å…³äº IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_PLC_Logic çš„é€»è¾‘ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 2,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ”¶åˆ°ã€‚è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Ÿæˆ‘æš‚æ—¶å†™æˆ 'IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_PLC_Logic'ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 3,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å¯¹çš„ï¼Œå°±è¿™æ ·ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 4,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "rgb",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 5,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_EdgeNode çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 6,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æˆ‘æŠŠå®ƒåŠ è¿›å»äº†ï¼Œæ ‡ç­¾æ˜¾ç¤ºä¸º 'IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_EdgeNode'ï¼Œä½ çœ‹çœ‹åˆé€‚å—ï¼Ÿ",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 7,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å¯¹çš„ï¼Œå°±è¿™æ ·ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 8,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "useAccount",
        "randomBytes"
      ],
      "is_repair": false
    },
    {
      "turn_id": 9,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "ç”¨æˆ·åœ¨è¿™é‡Œä¼šé‡åˆ° IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_EdgeNode çš„åˆ†æ”¯ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 10,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ˜ç™½ï¼Œæ‰€ä»¥å®ƒæ˜¯æ‰¿æ¥ä¸Šä¸€æ­¥çš„ï¼Œå†…å®¹æ˜¯ 'IoT_Industrial_MQTT_Broker å’Œ IoT_Industrial_EdgeNode'ï¼Ÿ",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 11,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "æ²¡é—®é¢˜ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 12,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "NOW",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 13,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_EdgeNode çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 14,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ˜ç™½ï¼Œæ‰€ä»¥å®ƒæ˜¯æ‰¿æ¥ä¸Šä¸€æ­¥çš„ï¼Œå†…å®¹æ˜¯ 'IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_EdgeNode'ï¼Ÿ",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 15,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å¯¹çš„ï¼Œå°±è¿™æ ·ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 16,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "signMessage",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 17,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_PLC_Logic çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 18,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ”¶åˆ°ã€‚è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Ÿæˆ‘æš‚æ—¶å†™æˆ 'IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_PLC_Logic'ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 19,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å¯ä»¥ï¼Œç»§ç»­å§ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 20,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "verifyMessage",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 21,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_TelemetryStream çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 22,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æˆ‘æŠŠå®ƒåŠ è¿›å»äº†ï¼Œæ ‡ç­¾æ˜¾ç¤ºä¸º 'IoT_Industrial_PLC_Logic å’Œ IoT_Industrial_TelemetryStream'ï¼Œä½ çœ‹çœ‹åˆé€‚å—ï¼Ÿ",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 23,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "æ²¡é—®é¢˜ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 24,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "setItem",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 25,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_TelemetryStream å’Œ IoT_Industrial_MQTT_Broker çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 26,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ”¶åˆ°ã€‚è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Ÿæˆ‘æš‚æ—¶å†™æˆ 'IoT_Industrial_TelemetryStream å’Œ IoT_Industrial_MQTT_Broker'ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 27,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å—¯ï¼Œè¿™æ ·çœ‹èµ·æ¥å¾ˆæ¸…æ™°ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 28,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "Bearer",
        "verify"
      ],
      "is_repair": false
    },
    {
      "turn_id": 29,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_TelemetryStream å’Œ IoT_Industrial_EdgeNode çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 30,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ”¶åˆ°ã€‚è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Ÿæˆ‘æš‚æ—¶å†™æˆ 'IoT_Industrial_TelemetryStream å’Œ IoT_Industrial_EdgeNode'ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 31,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "å¯ä»¥ï¼Œç»§ç»­å§ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 32,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "set",
        "rgb"
      ],
      "is_repair": false
    },
    {
      "turn_id": 33,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå¤„ç† IoT_Industrial_TelemetryStream çš„ç¯èŠ‚ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 34,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "æŠ±æ­‰ï¼Œç¨å¾®æ”¹ä¸€ä¸‹ï¼ŒæŠŠåˆšæ‰é‚£ä¸ªæ”¹æˆ IoT_Industrial_TelemetryStreamå¤„ç†ã€‚",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 35,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "æ˜ç™½ï¼Œæ‰€ä»¥å®ƒæ˜¯æ‰¿æ¥ä¸Šä¸€æ­¥çš„ï¼Œå†…å®¹æ˜¯ 'IoT_Industrial_TelemetryStreamå¤„ç†'ï¼Ÿ",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 36,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "æ²¡é—®é¢˜ã€‚",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 37,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[ç³»ç»Ÿæ—¥å¿—: Editor æ›´æ–°äº†å›¾è¡¨ä»£ç ä»¥åæ˜ ä¸Šè¿°ç»“æ„]",
      "elements_involved": [
        "removeItem"
      ],
      "is_repair": false
    }
  ],
  "dialogue_metadata": {
    "total_turns": 37,
    "repair_count": 1,
    "grounding_acts_count": 18,
    "theoretical_framework": "Grounding in Communication (Clark & Brennan, 1991)"
  }
}