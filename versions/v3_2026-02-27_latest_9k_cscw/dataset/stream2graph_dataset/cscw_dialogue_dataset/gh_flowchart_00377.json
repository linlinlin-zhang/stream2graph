{
  "id": "gh_flowchart_00377",
  "source": "github",
  "source_url": "https://github.com/mpro775/tagdod-project/blob/559959d1da7616a664535f2d108100d8e7bbd888/docs/requirements/flows/payment/webhook.mmd",
  "github_repo": "mpro775/tagdod-project",
  "github_file_path": "docs/requirements/flows/payment/webhook.mmd",
  "diagram_type": "flowchart",
  "code": "%% Payment Webhook Processing Flow\n%% View at https://mermaid.live\nflowchart TD\n  A[استقبال Webhook من Payment Provider] --> B[استخراج البيانات من الطلب]\n  B --> C{التحقق من التوقيع?}\n  C -->|توقيع غير صحيح| D[إرجاع خطأ 401 - توقيع غير صحيح]\n  \n  %% Note: BANK_TRANSFER لا يستخدم webhooks\n  AA[ملاحظة: الدفع المحلي BANK_TRANSFER] --> AB[لا يستخدم webhooks]\n  AB --> AC[يتم المطابقة يدوياً من لوحة التحكم]\n  AC --> AD[انظر: Local Payment Verification Flow]\n\n  C -->|توقيع صحيح| E[البحث عن الطلب بـ paymentIntentId]\n  E --> F{وجد الطلب?}\n  F -->|لا| G[إرجاع خطأ - طلب غير موجود]\n\n  F -->|نعم| H{حالة الدفع في Webhook?}\n  H -->|SUCCESS| I[تحديث حالة الدفع إلى PAID]\n  H -->|FAILED| J[تحديث حالة الدفع إلى FAILED]\n\n  I --> K[تحديث حالة الطلب إلى CONFIRMED]\n  K --> L[تحديث confirmedAt إلى الآن]\n  L --> M[إرسال إشعار تأكيد الطلب]\n\n  J --> N[تحديث حالة الطلب إلى PAYMENT_FAILED]\n  N --> O[إرسال إشعار فشل الدفع]\n\n  M --> P[تحديث المخزون - تقليل الكميات]\n  O --> Q[لا تغيير في المخزون - الكميات محجوزة]\n\n  P --> R[إرسال إشعارات مخزون إذا لزم الأمر]\n  Q --> R\n\n  R --> S[حفظ تفاصيل Webhook في السجل]\n  S --> T[إرجاع استجابة نجاح 200]\n\n  %% Error Cases\n  D --> U[نهاية - خطأ]\n  G --> U\n\n  T --> V[نهاية - نجاح]\n\n  %% Webhook Data Structure\n  W[بيانات Webhook المتوقعة] --> W1[intentId: معرف نية الدفع]\n  W1 --> W2[status: SUCCESS أو FAILED]\n  W2 --> W3[amount: المبلغ المدفوع]\n  W3 --> W4[signature: توقيع HMAC]\n\n  %% Signature Verification\n  X[التحقق من التوقيع] --> X1[استخراج signature من headers]\n  X1 --> X2[إنشاء HMAC من البيانات]\n  X2 --> X3[مقارنة التوقيعين]\n\n  X3 -->|متطابق| Y[التوقيع صحيح]\n  X3 -->|غير متطابق| Z[التوقيع غير صحيح]\n\n  Y --> C\n  Z --> D\n",
  "content_size": 1655,
  "collected_at": "2026-02-06T01:43:43.808049",
  "compilation_status": "failed",
  "license": "none",
  "license_name": "No License",
  "license_url": "",
  "repo_stars": 0,
  "repo_forks": 0,
  "compilation_error": "[WinError 2] 系统找不到指定的文件。",
  "cscw_dialogue": [
    {
      "turn_id": 1,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 استقبال Webhook من Payment Provider 和 استخراج البيانات من الطلب 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 2,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'استقبال Webhook من Payment Provider 和 استخراج البيانات من الطلب'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 3,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 4,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "A",
        "B"
      ],
      "is_repair": false
    },
    {
      "turn_id": 5,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 التحقق من التوقيع? 和 إرجاع خطأ 401 - توقيع غير صحيح 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 6,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "抱歉，稍微改一下，把刚才那个改成 التحقق من التوقيع?处理。",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 7,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'التحقق من التوقيع?处理'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 8,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 9,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "C",
        "D"
      ],
      "is_repair": false
    },
    {
      "turn_id": 10,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 ملاحظة: الدفع المحلي BANK_TRANSFER 和 لا يستخدم webhooks 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 11,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "抱歉，稍微改一下，把刚才那个改成 ملاحظة: الدفع المحلي BANK_TRANSFER处理。",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 12,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'ملاحظة: الدفع المحلي BANK_TRANSFER处理'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 13,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 14,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "AA",
        "AB"
      ],
      "is_repair": false
    },
    {
      "turn_id": 15,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 يتم المطابقة يدوياً من لوحة التحكم 和 انظر: Local Payment Verification Flow 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 16,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'يتم المطابقة يدوياً من لوحة التحكم 和 انظر: Local Payment Verification Flow'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 17,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 18,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "AC",
        "AD"
      ],
      "is_repair": false
    },
    {
      "turn_id": 19,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 البحث عن الطلب بـ paymentIntentId 和 وجد الطلب? 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 20,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "不，其实叫 البحث عن الطلب بـ paymentIntentId处理 会更准确一点。",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 21,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'البحث عن الطلب بـ paymentIntentId处理'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 22,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 23,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "E",
        "F"
      ],
      "is_repair": false
    },
    {
      "turn_id": 24,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 إرجاع خطأ - طلب غير موجود 和 حالة الدفع في Webhook? 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 25,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'إرجاع خطأ - طلب غير موجود 和 حالة الدفع في Webhook?'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 26,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 27,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "G",
        "H"
      ],
      "is_repair": false
    },
    {
      "turn_id": 28,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 تحديث حالة الدفع إلى PAID 和 تحديث حالة الدفع إلى FAILED。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 29,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'تحديث حالة الدفع إلى PAID 和 تحديث حالة الدفع إلى FAILED'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 30,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 31,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "I",
        "J"
      ],
      "is_repair": false
    },
    {
      "turn_id": 32,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 تحديث حالة الطلب إلى CONFIRMED 和 تحديث confirmedAt إلى الآن 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 33,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'تحديث حالة الطلب إلى CONFIRMED 和 تحديث confirmedAt إلى الآن'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 34,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 35,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "K",
        "L"
      ],
      "is_repair": false
    },
    {
      "turn_id": 36,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 إرسال إشعار تأكيد الطلب 和 تحديث حالة الطلب إلى PAYMENT_FAILED 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 37,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'إرسال إشعار تأكيد الطلب 和 تحديث حالة الطلب إلى PAYMENT_FAILED'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 38,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 39,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "M",
        "N"
      ],
      "is_repair": false
    },
    {
      "turn_id": 40,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 إرسال إشعار فشل الدفع 和 تحديث المخزون - تقليل الكميات。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 41,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'إرسال إشعار فشل الدفع 和 تحديث المخزون - تقليل الكميات'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 42,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 43,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "O",
        "P"
      ],
      "is_repair": false
    },
    {
      "turn_id": 44,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 لا تغيير في المخزون - الكميات محجوزة 和 إرسال إشعارات مخزون إذا لزم الأمر。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 45,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'لا تغيير في المخزون - الكميات محجوزة 和 إرسال إشعارات مخزون إذا لزم الأمر'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 46,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 47,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Q",
        "R"
      ],
      "is_repair": false
    },
    {
      "turn_id": 48,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 حفظ تفاصيل Webhook في السجل 和 إرجاع استجابة نجاح 200 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 49,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'حفظ تفاصيل Webhook في السجل 和 إرجاع استجابة نجاح 200'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 50,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 51,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "S",
        "T"
      ],
      "is_repair": false
    },
    {
      "turn_id": 52,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 نهاية - خطأ 和 نهاية - نجاح 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 53,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'نهاية - خطأ 和 نهاية - نجاح'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 54,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 55,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "U",
        "V"
      ],
      "is_repair": false
    },
    {
      "turn_id": 56,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 بيانات Webhook المتوقعة 和 intentId: معرف نية الدفع 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 57,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'بيانات Webhook المتوقعة 和 intentId: معرف نية الدفع'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 58,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 59,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "W",
        "W1"
      ],
      "is_repair": false
    },
    {
      "turn_id": 60,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "用户在这里会遇到 status: SUCCESS أو FAILED 和 amount: المبلغ المدفوع 的分支。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 61,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'status: SUCCESS أو FAILED 和 amount: المبلغ المدفوع'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 62,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 63,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "W2",
        "W3"
      ],
      "is_repair": false
    },
    {
      "turn_id": 64,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 signature: توقيع HMAC 和 التحقق من التوقيع 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 65,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'signature: توقيع HMAC 和 التحقق من التوقيع'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 66,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 67,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "W4",
        "X"
      ],
      "is_repair": false
    },
    {
      "turn_id": 68,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 استخراج signature من headers 和 إنشاء HMAC من البيانات 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 69,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'استخراج signature من headers 和 إنشاء HMAC من البيانات'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 70,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 71,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "X1",
        "X2"
      ],
      "is_repair": false
    },
    {
      "turn_id": 72,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "用户在这里会遇到 مقارنة التوقيعين 和 التوقيع صحيح 的分支。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 73,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'مقارنة التوقيعين 和 التوقيع صحيح'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 74,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 75,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "X3",
        "Y"
      ],
      "is_repair": false
    },
    {
      "turn_id": 76,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 التوقيع غير صحيح 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 77,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'التوقيع غير صحيح'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 78,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 79,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Z"
      ],
      "is_repair": false
    }
  ],
  "dialogue_metadata": {
    "total_turns": 79,
    "repair_count": 3,
    "grounding_acts_count": 38,
    "theoretical_framework": "Grounding in Communication (Clark & Brennan, 1991)"
  }
}