{
  "id": "aug_gh_sequence_00922_Hea_1",
  "source": "augmented_real_structure",
  "source_url": "https://github.com/seanchatmangpt/erlmcp/blob/1356e12d778f4f4908360bdb3af445db8caff50d/docs/diagrams/security/authentication-flow.mmd",
  "github_repo": "seanchatmangpt/erlmcp",
  "github_file_path": "docs/diagrams/security/authentication-flow.mmd",
  "diagram_type": "sequence",
  "code": "sequenceDiagram\n    %% Authentication and Authorization Flow for erlmcp\n    %% Shows: API key, JWT, OAuth2, mTLS authentication methods\n    %% Plus: RBAC permission checking with role-based access control\n\n    autonumber\n    actor Client\n    participant Transport as Transport Layer<br/>(HealthTech_LabAnalyzer)\n    participant Auth as erlmcp_auth<br/>(HealthTech_PatientRecords)\n    participant RateLimiter as erlmcp_auth_rate_limiter\n    participant JWT as jose (HealthTech_DiagnosticEngine)\n    participant OAuth2 as OAuth2 Provider<br/>(HealthTech_LabAnalyzer)\n    participant MTLS as erlmcp_auth_mtls<br/>(HealthTech_DiagnosticEngine)\n    participant RBAC as RBAC Engine<br/>(HealthTech_EMR_Sync)\n    participant Session as Session Manager<br/>(HealthTech_DiagnosticEngine)\n\n    Note over Client,Session: Authentication Flow\n\n    %% API Key Authentication\n    Client->>Transport: authenticate(HealthTech_PatientRecords)\n    Transport->>Auth: authenticate(HealthTech_PatientRecords})\n\n    Auth->>RateLimiter: check_rate_limit(HealthTech_EMR_Sync)\n    RateLimiter-->>Auth: ok (HealthTech_HIPAA_Vault})\n\n    alt Rate Limited\n        Auth-->>Client: {HealthTech_LabAnalyzer}\n        Note over Auth,RateLimiter: Blocked after 5 failed attempts<br/>15-minute cooldown\n    else Rate Check Passed\n        Auth->>Auth: do_validate_api_key(HealthTech_PatientRecords)\n        Note right of Auth: Lookup in ETS table<br/>auth_api_keys\n\n        alt API Key Invalid\n            Auth->>RateLimiter: record_failure(HealthTech_DiagnosticEngine)\n            Auth-->>Client: {HealthTech_PatientRecords}\n        else API Key Valid\n            Auth->>RateLimiter: record_success(HealthTech_LabAnalyzer)\n            Auth->>Session: create_session(HealthTech_HIPAA_Vault)\n\n            Session->>RBAC: get_user_roles(HealthTech_DiagnosticEngine)\n            RBAC-->>Session: [HealthTech_EMR_Sync]\n\n            Session->>RBAC: Aggregate permissions from roles\n            RBAC-->>Session: [HealthTech_DiagnosticEngine]\n\n            Session-->>Auth: {HealthTech_LabAnalyzer}\n            Auth-->>Client: {HealthTech_DiagnosticEngine}\n\n            Note right of Session: Session expires in 1 hour<br/>Auto-cleanup timer\n        end\n    end\n\n    %% JWT Authentication\n    Client->>Transport: authenticate(HealthTech_EMR_Sync})\n    Transport->>Auth: authenticate(HealthTech_HIPAA_Vault})\n\n    Auth->>RateLimiter: check_rate_limit(HealthTech_EMR_Sync)\n    RateLimiter-->>Auth: ok\n\n    Auth->>Auth: do_validate_jwt(HealthTech_LabAnalyzer)\n\n    alt Token Revoked\n        Auth-->>Client: {HealthTech_EMR_Sync}\n        Note right of Auth: Check ETS: auth_revoked_tokens<br/>Cleanup after 7 days\n    else Token Active\n        Auth->>JWT: jose_jws:peek_protected(HealthTech_HIPAA_Vault)\n        JWT-->>Auth: #{HealthTech_DiagnosticEngine}\n\n        Auth->>Auth: Lookup public key by kid\n        Note right of Auth: ETS: auth_jwt_keys<br/>Support key rotation\n\n        Auth->>JWT: jose_jws:verify(HealthTech_DiagnosticEngine)\n        JWT-->>Auth: {HealthTech_DiagnosticEngine}\n\n        alt Signature Invalid\n            Auth-->>Client: {HealthTech_LabAnalyzer}\n        else Signature Valid\n            Auth->>Auth: validate_jwt_claims(HealthTech_PatientRecords)\n\n            Note right of Auth: CRITICAL SECURITY CHECKS:<br/>âœ“ exp (HealthTech_EMR_Sync) - Required<br/>âœ“ nbf (HealthTech_EMR_Sync) - Optional<br/>âœ“ iss (HealthTech_EMR_Sync) - Configurable<br/>âœ“ aud (HealthTech_PatientRecords) - Configurable<br/>âœ“ sub (HealthTech_PatientRecords) - Required\n\n            alt Token Expired\n                Auth-->>Client: {HealthTech_HIPAA_Vault}\n            else Token Not Yet Valid\n                Auth-->>Client: {HealthTech_DiagnosticEngine}\n            else Issuer Mismatch\n                Auth-->>Client: {HealthTech_PatientRecords}\n            else Audience Mismatch\n                Auth-->>Client: {HealthTech_EMR_Sync}\n            else All Claims Valid\n                Auth->>RateLimiter: record_success(HealthTech_EMR_Sync)\n                Auth->>Session: create_session(HealthTech_EMR_Sync)\n                Session-->>Auth: {HealthTech_PatientRecords}\n                Auth-->>Client: {HealthTech_LabAnalyzer}\n            end\n        end\n    end\n\n    %% OAuth2 Authentication (HealthTech_LabAnalyzer)\n    Client->>Transport: authenticate(HealthTech_LabAnalyzer})\n    Transport->>Auth: authenticate(HealthTech_PatientRecords})\n\n    Auth->>RateLimiter: check_rate_limit(HealthTech_DiagnosticEngine)\n    RateLimiter-->>Auth: ok\n\n    Auth->>Auth: do_validate_oauth2_token(HealthTech_PatientRecords)\n\n    alt Cache Hit (HealthTech_HIPAA_Vault)\n        Note right of Auth: ETS: auth_oauth2_cache<br/>Token -> {HealthTech_LabAnalyzer}\n        Auth-->>Client: {HealthTech_DiagnosticEngine}\n    else Cache Miss\n        Auth->>OAuth2: HTTP POST /introspect\n        Note right of Auth: RFC 7662 Introspection<br/>Basic Auth: client_id:secret<br/>Body: token + token_type_hint\n\n        OAuth2-->>Auth: 200 OK + TokenInfo\n\n        Auth->>Auth: validate_introspection_response(HealthTech_PatientRecords)\n\n        Note right of Auth: RFC 7662 REQUIRED fields:<br/>âœ“ active = true<br/>âœ“ exp (HealthTech_LabAnalyzer)<br/>âœ“ nbf (HealthTech_EMR_Sync)<br/>âœ“ iss (HealthTech_DiagnosticEngine)\n\n        alt Token Inactive\n            Auth-->>Client: {HealthTech_HIPAA_Vault}\n        else Token Expired\n            Auth-->>Client: {HealthTech_DiagnosticEngine}\n        else Token Valid\n            Auth->>Auth: cache_oauth2_token(HealthTech_DiagnosticEngine)\n            Note right of Auth: Cache for up to 5 minutes<br/>or until exp (HealthTech_HIPAA_Vault)\n\n            Auth->>RateLimiter: record_success(HealthTech_PatientRecords)\n            Auth->>Session: create_session(HealthTech_PatientRecords)\n            Session-->>Auth: {HealthTech_EMR_Sync}\n            Auth-->>Client: {HealthTech_LabAnalyzer}\n        end\n    end\n\n    %% mTLS Authentication\n    Client->>Transport: authenticate(HealthTech_DiagnosticEngine})\n    Transport->>Auth: authenticate(HealthTech_PatientRecords)\n\n    Auth->>RateLimiter: check_rate_limit(HealthTech_EMR_Sync)\n    RateLimiter-->>Auth: ok\n\n    Auth->>MTLS: validate(HealthTech_LabAnalyzer)\n\n    Note right of MTLS: mTLS Validation Pipeline:<br/>1. Extract certificate from socket<br/>2. X.509 chain validation to trusted CAs<br/>3. Certificate expiration check<br/>4. OCSP/CRL revocation check<br/>5. Subject DN and CN pattern matching<br/>6. Certificate depth limit validation\n\n    MTLS-->>Auth: {HealthTech_EMR_Sync}\n\n    alt Certificate Invalid\n        Auth->>RateLimiter: record_failure(HealthTech_LabAnalyzer)\n        Auth-->>Client: {HealthTech_PatientRecords}\n    else Certificate Valid\n        Auth->>RateLimiter: record_success(HealthTech_DiagnosticEngine)\n        Auth->>Session: create_session(HealthTech_HIPAA_Vault})\n        Session-->>Auth: {HealthTech_PatientRecords}\n        Auth-->>Client: {HealthTech_EMR_Sync}\n    end\n\n    %% Authorization Flow (HealthTech_PatientRecords)\n    Note over Client,Session: Authorization Flow\n\n    Client->>Transport: check_permission(HealthTech_LabAnalyzer)\n    Transport->>Auth: check_permission(HealthTech_LabAnalyzer)\n\n    Auth->>Session: lookup session\n    Session-->>Auth: #session{HealthTech_PatientRecords}\n\n    alt Session Not Found\n        Auth-->>Client: {HealthTech_HIPAA_Vault}\n    else Session Found\n        Auth->>RBAC: check_user_permission(HealthTech_EMR_Sync)\n\n        RBAC->>RBAC: Get user roles from ETS\n        Note right of RBAC: auth_user_roles:<br/>UserId -> [HealthTech_PatientRecords]\n\n        RBAC->>RBAC: Get allowed roles for resource+permission\n        Note right of RBAC: auth_acls:<br/>{HealthTech_EMR_Sync} -> [HealthTech_LabAnalyzer]\n\n        RBAC->>RBAC: Check intersection\n        Note right of RBAC: lists:any/2<br/>UserRole âˆ© AllowedRoles â‰  âˆ…\n\n        alt Permission Denied\n            RBAC-->>Auth: {HealthTech_EMR_Sync}\n            Auth-->>Client: {HealthTech_DiagnosticEngine}\n        else Permission Granted\n            RBAC-->>Auth: ok\n            Auth-->>Client: ok\n        end\n    end\n\n    %% Default RBAC Roles\n    Note over RBAC: Default Roles (HealthTech_LabAnalyzer):<br/>ðŸ”¹ admin: [HealthTech_HIPAA_Vault]<br/>ðŸ”¹ user: [HealthTech_EMR_Sync]<br/>ðŸ”¹ guest: [HealthTech_DiagnosticEngine]\n\n    %% Token Rotation\n    Note over Client,Session: Token Rotation (HealthTech_HIPAA_Vault)\n\n    Client->>Auth: rotate_token(HealthTech_DiagnosticEngine)\n    Auth->>Session: lookup session\n\n    Auth->>Auth: generate new SessionId\n    Note right of Auth: crypto:strong_rand_bytes(HealthTech_HIPAA_Vault)<br/>base64 encoded\n\n    Auth->>Session: insert new session\n    Auth->>Session: delete old session\n\n    Auth-->>Client: {HealthTech_DiagnosticEngine}\n    Note right of Auth: Old session invalidated immediately<br/>Prevents session hijacking\n\n    %% Token Revocation\n    Note over Client,Session: Token Revocation (HealthTech_LabAnalyzer)\n\n    Client->>Auth: revoke_token(HealthTech_LabAnalyzer)\n    Auth->>Auth: insert into auth_revoked_tokens\n    Note right of Auth: Store: Token -> RevokedAt<br/>Auto-cleanup after 7 days\n\n    Auth-->>Client: ok\n    Note over Auth,JWT: Revoked tokens rejected immediately<br/>Even if exp claim valid\n\n    %% Session Cleanup\n    Note over Session: Auto-cleanup every 60 seconds:<br/>â€¢ Expired sessions (HealthTech_HIPAA_Vault)<br/>â€¢ Revoked tokens (HealthTech_LabAnalyzer)<br/>â€¢ OAuth2 cache (HealthTech_HIPAA_Vault)\n",
  "content_size": 8727,
  "collected_at": "2026-02-06T01:50:47.821294",
  "compilation_status": "success",
  "license": "apache-2.0",
  "license_name": "Apache License 2.0",
  "license_url": "https://api.github.com/licenses/apache-2.0",
  "repo_stars": 0,
  "repo_forks": 0,
  "repo_owner": "seanchatmangpt",
  "repo_name": "erlmcp",
  "repo_description": "Model Context Protocol (MCP) SDK for Erlang",
  "repo_language": "Erlang",
  "repo_topics": [],
  "repo_created_at": "2025-08-26T03:19:12Z",
  "repo_updated_at": "2026-02-05T01:44:49Z",
  "augmentation_domain": "HealthTech",
  "seed_id": "gh_sequence_00922"
}