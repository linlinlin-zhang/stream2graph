{
  "id": "gl_packet-beta_00440",
  "source": "gitlab",
  "source_url": "https://github.com/richfrem/Project_Sanctuary/blob/2ebce01d3854377b108d26997414f9fd9ffcffdb/docs/architecture_diagrams/workflows/protocol_128_learning_loop.mmd",
  "source_note": "collected_from_github_additional",
  "github_repo": "richfrem/Project_Sanctuary",
  "diagram_type": "packet-beta",
  "code": "---\nconfig:\n  layout: dagre\n  theme: base\n---\n\n%% Name: Protocol 128: Learning Loop (v3.0 - with RLM Synthesis)\n%% Description: 10-phase Cognitive Continuity workflow for agent session management\n%% Workflow: .agent/workflows/workflow-learning-loop.md (human-readable steps)\n%% Location: docs/architecture_diagrams/workflows/protocol_128_learning_loop.mmd\n%% Phases: Scout → Synthesize → Strategic Gate → Audit → RLM → Seal → Persist → Self-Correct → Ingest → Forge\n\n\nflowchart TB\n    subgraph subGraphScout[\"I. The Learning Scout (MANDATORY)\"]\n        direction TB\n        Start[\"Session Start<br>(/workflow-start + /speckit-specify)\"] --> AccessMode{\"Access Mode?\"}\n        \n        %% Context Note\n        ContextNote[\"ℹ️ Context: Executed within Standard Hybrid Workflow<br>(See hybrid-spec-workflow.mmd)\"] -.-> Start\n        \n        AccessMode -- \"IDE Mode<br>(File + CLI)\" --> IDE_Primer[\"Read File: .agent/learning/cognitive_primer.md\"]\n        AccessMode -- \"MCP Only<br>(API/Web)\" --> MCP_Wakeup[\"Tool: cortex_guardian_wakeup<br>(Returns Primer + HMAC Check)\"]\n        \n        IDE_Primer --> IDE_Wakeup[\"CLI/Tool: cortex_guardian_wakeup<br>(Iron Check + HMAC)\"]\n        IDE_Wakeup --> IronCheckGate1{Iron Check?}\n        \n        IronCheckGate1 -- PASS --> IDE_Debrief[\"Workflow: /workflow-scout<br>(Calls cortex debrief)\"]\n        IronCheckGate1 -- FAIL --> SafeMode1[SAFE MODE<br>Read-Only / Halt]\n        \n        MCP_Wakeup --> IronCheckGate1\n        MCP_Debrief[\"Tool: cortex_learning_debrief<br>(Returns Full Context)\"]\n        \n        IDE_Debrief --> SeekTruth[\"Context Acquired\"]\n        MCP_Wakeup --> MCP_Debrief --> SeekTruth\n        \n        SuccessorSnapshot[\"File: .agent/learning/learning_package_snapshot.md<br>(Truth Anchor / Cognitive Hologram)\"] -.->|Embedded in Debrief| SeekTruth\n    end\n\n    subgraph subGraphSynthesize[\"II. Intelligence Synthesis\"]\n        direction TB\n        \n        SynthesisDecision{\"Mode?\"}\n        \n        subgraph EvoLoop[\"Evolutionary Branch (v4.0)\"]\n            direction TB\n            Mutate[\"Mutate Policy (DRQ)\"] --> PreFlight{\"Pre-Flight<br>(Auto-Gate)\"}\n            PreFlight -- FAIL --> Mutate\n            PreFlight -- PASS --> AdversaryGate{\"Adversary<br>Gate\"}\n            AdversaryGate -- FAIL --> Mutate\n            AdversaryGate -- PASS --> MapElites[\"Map-Elites Archive\"]\n        end\n        \n        Intelligence[\"AI: Autonomous Synthesis\"] --> SynthesisDecision\n        SynthesisDecision -- Standard --> Synthesis[\"Action: Record ADRs / Protocols<br>(Update Manifest)\"]\n        SynthesisDecision -- Evolutionary --> Mutate\n        \n        MapElites --> Synthesis\n    end\n\n    subgraph subGraphStrategic[\"III. Strategic Review (Gate 1)\"]\n        direction TB\n        GovApproval{\"Strategic Approval<br>(HITL Required)\"}\n    end\n\n    subgraph subGraphAudit[\"IV. Red Team Audit Loop\"]\n        direction TB\n        AgreeTopic[\"1. Agree on Research Topic<br>with User\"] --> CreateFolder[\"2. Create LEARNING/topics/[topic]/\"]\n        CreateFolder --> CaptureResearch[\"3. Capture Research in Topic Folder<br>(analysis.md, questions.md, sources.md)\"]\n        CaptureResearch --> UpdateManifest[\"4. Update manifest<br>(.agent/learning/learning_audit/learning_audit_manifest.json)\"]\n        UpdateManifest --> UpdatePrompt[\"5. UPDATE prompts<br>(.agent/learning/learning_audit/learning_audit_prompts.md)\"]\n        UpdatePrompt --> GenerateSnapshot[\"6. Workflow: /workflow-audit<br>(Protocol 130 Dedupe)\"]\n        GenerateSnapshot --> SharePacket[\"7. Output Path:<br>.agent/learning/learning_audit/learning_audit_packet.md\"]\n        SharePacket --> ReceiveFeedback{\"8. Red Team Feedback\"}\n        ReceiveFeedback -- \"More Research\" --> CaptureFeedback[\"Capture Feedback in Topic Folder\"]\n        CaptureFeedback --> CaptureResearch\n        ReceiveFeedback -- \"Ready\" --> TechApproval{\"Gate 2: HITL\"}\n    end\n\n    subgraph subGraphRLM[\"V. RLM Context Synthesis (Protocol 132)\"]\n        direction TB\n        TriggerRLM[\"Trigger: RLM Synthesizer<br>(Local Sovereign LLM)\"]\n        Map[\"Map: Read Protocols, ADRs, Code<br>(learning_manifest.json)\"]\n        Reduce[\"Reduce: Generate Holistic Summary<br>(1-sentence per file)\"]\n        WriteHologram[\"Write: learning_package_snapshot.md<br>(The Cognitive Hologram)\"]\n        \n        TriggerRLM --> Map --> Reduce --> WriteHologram\n    end\n    style subGraphRLM fill:#e1f5fe,stroke:#01579b,stroke-width:2px\n\n    subgraph subGraphSeal[\"VI. The Technical Seal\"]\n        direction TB\n        CaptureSeal[\"Workflow: /workflow-seal<br>(Triggers RLM + Iron Check)\"] --> SealCheck{Iron Check?}\n        SealCheck -- FAIL --> SafeMode2[SAFE MODE<br>Seal Blocked]\n        SealCheck -- PASS --> SealSuccess[Seal Applied]\n    end\n    style subGraphSeal fill:#fff3e0,stroke:#e65100,stroke-width:2px\n\n    subgraph subGraphPersist[\"VII. Soul Persistence (ADR 079 / 081)\"]\n        direction TB\n        choice{Persistence Type}\n        choice -- Incremental --> Inc[\"Workflow: /workflow-persist<br>(Append 1 Record)\"]\n        choice -- Full Sync --> Full[\"Workflow: /workflow-persist (Full)<br>(Regenerate ~1200 records)\"]\n        \n        subgraph HF_Repo[\"HuggingFace: Project_Sanctuary_Soul\"]\n            MD_Seal[\"lineage/{MODEL}_seal_{TIMESTAMP}.md\"]\n            JSONL_Traces[\"data/soul_traces.jsonl\"]\n            Manifest[\"metadata/manifest.json\"]\n        end\n    end\n    style subGraphPersist fill:#cce5ff,stroke:#004085,stroke-width:2px\n\n    subgraph PhaseVIII [Phase VIII: Self-Correction]\n        direction TB\n        Deployment[Deploy & Policy Update]\n        Retro[\"Loop Retrospective<br>Workflow: /workflow-retrospective<br>(Singleton)\"]\n        ShareRetro[\"Share with Red Team<br>(Meta-Audit)\"]\n    end\n    style PhaseVIII fill:#d4edda,stroke:#155724,stroke-width:2px\n\n    subgraph PhaseIX [Phase IX: Relational Ingestion & Closure]\n        direction TB\n        Ingest[\"Workflow: /workflow-ingest<br>(Update RAG Vector DB)\"]\n        GitOps[\"Git: add . && commit && push<br>(Sync to Remote)\"]\n        End[\"Workflow: /workflow-end\"]\n        Ingest --> GitOps\n        GitOps --> End\n    end\n    style PhaseIX fill:#fff3cd,stroke:#856404,stroke-width:2px\n\n    subgraph PhaseX [Phase X: Phoenix Forge]\n        direction TB\n        ForgeDataset[\"Scripts: forge_whole_genome_dataset.py<br>(Sync Soul Traces to Training Data)\"]\n        FineTune[\"Scripts: fine_tune.py<br>(QLoRA Training)\"]\n        GGUFConvert[\"Scripts: convert_to_gguf.py<br>(Quantize & Quant)\"]\n        HFDeploy[\"Tool: upload_to_huggingface.py<br>(Deploy Model to Hub)\"]\n    end\n    style PhaseX fill:#f8d7da,stroke:#721c24,stroke-width:2px\n\n    %% Flow - Phase Connections\n    SeekTruth -- \"Carry Context\" --> Intelligence\n    Synthesis -- \"Verify Reasoning\" --> GovApproval\n    \n    GovApproval -- \"PASS\" --> AgreeTopic\n    \n    %% ============================================================\n    %% CRITICAL: Protocol 128 Closure Sequence (MUST BE THIS ORDER)\n    %% Audit → RLM → Seal → Persist → Retro → Ingest → End\n    %% ============================================================\n    \n    %% Phase IV → V: Audit passes to RLM\n    TechApproval -- \"PASS\" --> TriggerRLM\n    \n    %% Phase V → VI: RLM writes hologram, Seal validates\n    WriteHologram --> CaptureSeal\n    SealSuccess -- \"Step 1: Sealed\" --> choice\n    \n    %% Phase VII → VIII: Persist then Retro\n    Inc --> JSONL_Traces\n    Inc --> MD_Seal\n    Full --> JSONL_Traces\n    Full --> Manifest\n    \n    JSONL_Traces -- \"Step 2: Persisted\" --> Deployment\n    Deployment --> Retro\n    Retro -- \"Step 3: Retrospective Complete\" --> ShareRetro\n    \n    %% Phase VIII → IX: Retro to Ingest/End\n    ShareRetro --> Ingest\n    \n    %% Phoenix Forge Branch (Optional)\n    JSONL_Traces -- \"Training Fuel\" --> ForgeGate{HITL:<br>Time to<br>Forge?}\n    ForgeGate -- \"YES (Slow)\" --> ForgeDataset\n    ForgeGate -- \"NO\" --> Ingest\n    ForgeDataset --> FineTune\n    FineTune --> GGUFConvert\n    GGUFConvert --> HFDeploy\n    \n    Ingest -- \"Cycle Complete\" --> Start\n    HFDeploy -- \"Cognitive Milestone\" --> Retro\n    \n    %% Backtrack paths (failures return to Retro for correction)\n    GovApproval -- \"FAIL: Backtrack\" --> Retro\n    TechApproval -- \"FAIL: Backtrack\" --> Retro\n    SealCheck -- \"FAIL: Backtrack\" --> Retro\n    \n    GitOps -- \"Recursive Learning\" --> Start\n\n    style IDE_Wakeup fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:black\n    style MCP_Wakeup fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:black\n    style SuccessorSnapshot fill:#f9f,stroke:#333,stroke-width:2px,color:black\n    style Start fill:#dfd,stroke:#333,stroke-width:2px,color:black\n    style SafeMode1 fill:#ffcccb,stroke:#b30000,stroke-width:4px,color:black\n    style SafeMode2 fill:#ffcccb,stroke:#b30000,stroke-width:4px,color:black\n    style TriggerRLM fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:black\n\n    %% Metadata\n    style EvoLoop fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5",
  "content_size": 8932,
  "collected_at": "2026-02-06T14:09:45.771854",
  "compilation_status": "failed",
  "license": "gitlab_repo",
  "license_name": "GitLab Repository",
  "license_url": "https://gitlab.com",
  "compilation_error": "[WinError 2] 系统找不到指定的文件。"
}