{
  "id": "gh_ind_93cb06225a",
  "source": "github_industrial",
  "repo": "TotallyInformation/node-red-contrib-uibuilder",
  "license": "apache-2.0",
  "code": "sequenceDiagram\n    %% https://mermaid-js.github.io/mermaid-live-editor/edit\n    %% https://mermaid-js.github.io/mermaid/#/sequenceDiagram?id=syntax\n\n    title: uibuilder Security Sequence\n\n    participant client as Client <br> Browser\n    participant NR as Node-RED <br> uibuilder node\n    participant u as uib <br> Internals\n    participant js as Custom Code <br>(<uibRoot>/<br>.config/<br>security.js)\n\n    autonumber\n\n    Note over client,js: This sequence picks up from the uib-connect-sequence diagram<br>Assumes that security is ON. Dotted lines are websocket msg's<br>**Every msg in both directions MUST now contain msg._auth**\n\n    NR-->>+client: uibuilderCtrl: \"client connect\", incl. security flag\n\n    Note over client: Client checks<br>localstore for auth\n\n    client-->>-NR: uibuilderCtrl: \"auth\"<br> incl _auth (dummy or real)\n\n    loop Continue until authorised\n\n        Note over NR,u: Validate JWT\n        Note over u: Checks signature, expiry and IP address (optional)\n\n        Note over NR,js: Validate Auth\n        Note over u,js: Uses fns in the custom security.js file\n        Note over js: Updates session and user DBs\n\n        opt Client is not auth\n            Note over client,NR: Client must have sent no JWT<br> or session expired or something else invalid\n            rect rgba(255, 0, 255, 0.1)\n                js->>u: client marked as unauth\n                u->>NR: JWT invalidated (removed)\n                NR--)client: uibuilderCtrl: \"request for logon\"\n                Note over client: front-end must<br> ask user for logon\n                Note over client,NR: NOTE: Non-logon msgs can flow ONLY if<br> uibuilder instance is set to allow unauth\n                client-->>NR: uibuilderCtrl: \"logon\"\n                Note over client,js: (Loop)\n            end\n        end\n\n    end\n    opt Client has valid JWT & is auth\n        Note over client,NR: Client must have sent valid auth<br> and JWT from a pre-existing session\n        activate NR\n        u->>NR: _auth JWT is updated\n        rect rgba(0, 255, 0, 0.1)\n            NR-->>+client: uibuilderCtrl: \"authorised\"\n            deactivate NR\n            client--)-NR: uibuilderCtrl: \"ready for content\"<br> cacheControl: \"REPLAY\"\n        end\n    end\n\n    Note over client,js: For all standard messages from client once client is auth\n\n    client-->>NR: Some data sent to Node-RED\n    \n    Note over NR,u: Validate JWT\n\n    alt If JWT invalid\n        rect rgba(100, 100, 100, 0.1)\n            NR->>u: Validate Auth\n            u->>js: Validate Auth\n            js->>NR: Updated _auth\n            u->>NR: Updated JWT\n            rect rgba(255, 255, 255, 1)\n                alt If Auth is valid\n                    Note over NR,u: Update JWT\n                    NR-->>client: uibuilderCtrl: \"authorised\" with updated _auth\n                else If Auth not valid\n                    Note over NR,u: Invalidate JWT\n                    NR-->>client: uibuilderCtrl: \"request for logon\"\n                    Note over client: Return to auth loop\n                end\n            end\n        end\n    else If JWT Valid\n        rect rgba(100, 100, 100, 0.1)\n            NR-->>client: uibuilderCtrl: \"authorised\" with updated _auth<br>If JWT expiry is auto-updating\n        end\n        Note over NR: pass msg to port 1<br> and on to rest of flow\n    end\n",
  "diagram_type": "loop size:>1500",
  "collected_at": "2026-02-27T04:02:57.675497"
}