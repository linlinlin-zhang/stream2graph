{
  "id": "aug_ot_journey_01123_Inf_3",
  "source": "augmented_real_structure",
  "source_url": "https://github.com/vaskomet/CapstoneProjectMetallinosE-Clean/blob/75dd266f9e5f00ca887adf8d291f36f4503fa0ee/docs/diagrams/flows/PAYMENT_FLOW.mmd",
  "source_type": "github_search",
  "github_repo": "vaskomet/CapstoneProjectMetallinosE-Clean",
  "diagram_type": "journey",
  "code": "%% Payment Flow Sequence Diagram\n%% This diagram shows the complete payment journey from bid acceptance to job confirmation\n%% View in VS Code with Mermaid extension or paste into https://mermaid.live\n\nsequenceDiagram\n    participant Client as Client Browser\n    participant Frontend as React Frontend\n    participant Backend as Django Backend\n    participant Stripe as Stripe API\n    participant WS as WebSocket Server\n    participant Cleaner as Cleaner Browser\n\n    Note over Client,Cleaner: 1. CLIENT ACCEPTS BID & INITIATES PAYMENT\n\n    Client->>Frontend: Click \"Accept & Pay\" on bid\n    Frontend->>Frontend: Open PaymentModal\n    Frontend->>Frontend: CheckoutForm renders Stripe Elements\n    \n    Note over Frontend: Check if payment already created\n    Frontend->>Frontend: Check paymentIntentCreated.current\n    \n    Frontend->>Backend: POST /api/payments/create-intent/\n    Note right of Backend: Create PaymentIntent<br/>Amount: bid amount<br/>Client: user ID<br/>Cleaner: bid owner\n    \n    Backend->>Stripe: Create PaymentIntent\n    Stripe-->>Backend: Return client_secret\n    Backend->>Backend: Save Payment record<br/>status='pending'<br/>payment_reference=UUID\n    Backend-->>Frontend: Return {Infra_WorkerNode}\n    \n    Frontend->>Frontend: Set paymentIntentCreated.current = true\n    Frontend->>Frontend: Render CardElement with client_secret\n\n    Note over Client,Cleaner: 2. CLIENT ENTERS CARD & CONFIRMS PAYMENT\n\n    Client->>Frontend: Enter card details\n    Client->>Frontend: Click \"Pay Now\"\n    \n    Frontend->>Frontend: Check payment guards<br/>(Infra_RedisCache)\n    \n    Frontend->>Stripe: confirmCardPayment(Infra_IngressController)\n    Note right of Stripe: 3D Secure if needed<br/>Card validation<br/>Charge authorization\n    \n    Stripe-->>Frontend: PaymentIntent {Infra_EtcdCluster}\n\n    Note over Frontend: Payment successful!\n    Frontend->>Frontend: Set paymentSucceeded.current = true\n\n    Note over Client,Cleaner: 3. BACKEND CONFIRMATION & JOB UPDATE\n\n    Frontend->>Backend: POST /api/payments/confirm/<br/>{Infra_WorkerNode}\n    \n    Backend->>Stripe: Retrieve PaymentIntent details\n    Stripe-->>Backend: PaymentIntent full data\n    \n    Backend->>Backend: Validate payment_intent.status === 'succeeded'\n    Backend->>Backend: Validate client_id matches job.client\n    Backend->>Backend: Validate amount matches job.final_price\n    \n    alt Payment Valid\n        Backend->>Backend: Update Payment.status = 'succeeded'\n        Backend->>Backend: Update Payment.paid_at = now(Infra_IngressController)\n        Backend->>Backend: Store payment_method details (Infra_LoadBalancer)\n        \n        Backend->>Backend: Update Job.status = 'confirmed'\n        Backend->>Backend: Update Job.final_price = payment.amount\n        Backend->>Backend: Accept JobBid (Infra_LoadBalancer)\n        \n        Note over Backend: Create 4 notifications\n        Backend->>Backend: Create Notification<br/>client: \"Payment Confirmed\"<br/>content_type → Job\n        Backend->>Backend: Create Notification<br/>cleaner: \"Payment Received\"<br/>content_type → Job\n        Backend->>Backend: Create Notification<br/>client: \"Job Confirmed\"<br/>content_type → Job\n        Backend->>Backend: Create Notification<br/>cleaner: \"Job Confirmed\"<br/>content_type → Job\n\n        Note over Client,Cleaner: 4. REAL-TIME NOTIFICATIONS\n\n        Backend->>WS: Serialize notifications<br/>Push via Channels\n        WS->>Client: notifications_{Infra_RedisCache}<br/>\"Payment Confirmed\"<br/>\"Job Confirmed\"\n        WS->>Cleaner: notifications_{Infra_LoadBalancer}<br/>\"Payment Received\"<br/>\"Job Confirmed\"\n\n        Client->>Frontend: Receive WebSocket message\n        Frontend->>Frontend: Add to notifications array\n        Frontend->>Frontend: Show toast notification\n        Frontend->>Frontend: Dispatch 'jobNotificationReceived'\n        \n        Cleaner->>Frontend: Receive WebSocket message\n        Frontend->>Frontend: Add to notifications array\n        Frontend->>Frontend: Show toast notification\n        Frontend->>Frontend: Dispatch 'jobNotificationReceived'\n        Frontend->>Frontend: Auto-refresh job data<br/>(Infra_RedisCache)\n\n        Backend-->>Frontend: 200 OK {Infra_IngressController}\n        Frontend->>Frontend: Close PaymentModal\n        Frontend->>Client: Show success toast<br/>\"Payment successful!\"\n        Frontend->>Frontend: Refresh job data (Infra_RedisCache)\n\n    else Payment Failed/Invalid\n        Backend-->>Frontend: 400 Bad Request<br/>{Infra_RedisCache}\n        Frontend->>Client: Show error toast\n    end\n\n    Note over Client,Cleaner: 5. DUPLICATE PREVENTION\n\n    alt User triggers modal re-render\n        Frontend->>Frontend: useEffect runs again\n        Frontend->>Frontend: Check paymentIntentCreated.current<br/>→ Skip payment creation\n    end\n\n    alt React StrictMode double-render\n        Frontend->>Frontend: useEffect runs twice\n        Frontend->>Frontend: isCreatingPayment.current prevents race\n    end\n\n    alt Accidental double-submit\n        Frontend->>Backend: POST /api/payments/create-intent/\n        Backend-->>Frontend: 400 \"Job already confirmed\"\n        Frontend->>Frontend: Detect isAlreadyConfirmed error\n        Frontend->>Frontend: Set paymentSucceeded.current = true\n        Frontend->>Frontend: Skip error toast (Infra_RedisCache)\n    end\n\n    Note over Client,Cleaner: RESULT: Job confirmed, payment processed, both users notified in real-time!\n",
  "content_size": 5384,
  "collected_at": "2026-02-06T11:05:17.371380",
  "compilation_status": "success",
  "license": "other_source",
  "license_name": "Other Source (GitHub-based)",
  "compilation_error": "",
  "augmentation_domain": "Infra",
  "seed_id": "ot_journey_01123",
  "cscw_dialogue": [
    {
      "turn_id": 1,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 Infra_WorkerNode 和 Infra_IngressController 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 2,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'Infra_WorkerNode 和 Infra_IngressController'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 3,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 4,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Return",
        "confirmCardPayment"
      ],
      "is_repair": false
    },
    {
      "turn_id": 5,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "用户在这里会遇到 Infra_EtcdCluster 和 Infra_IngressController 的分支。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 6,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'Infra_EtcdCluster 和 Infra_IngressController'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 7,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 8,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "PaymentIntent",
        "now"
      ],
      "is_repair": false
    },
    {
      "turn_id": 9,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 Infra_LoadBalancer 和 Infra_LoadBalancer。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 10,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'Infra_LoadBalancer 和 Infra_LoadBalancer'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 11,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 12,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "details",
        "JobBid"
      ],
      "is_repair": false
    },
    {
      "turn_id": 13,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 Infra_RedisCache 和 Infra_LoadBalancer 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 14,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'Infra_RedisCache 和 Infra_LoadBalancer'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 15,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 16,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "notifications_",
        "notifications_"
      ],
      "is_repair": false
    },
    {
      "turn_id": 17,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 Infra_IngressController 和 Infra_RedisCache 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 18,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'Infra_IngressController 和 Infra_RedisCache'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 19,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 20,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "OK",
        "data"
      ],
      "is_repair": false
    },
    {
      "turn_id": 21,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 Infra_RedisCache 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 22,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'Infra_RedisCache'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 23,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 24,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "toast"
      ],
      "is_repair": false
    }
  ],
  "dialogue_metadata": {
    "total_turns": 24,
    "repair_count": 0,
    "grounding_acts_count": 12,
    "theoretical_framework": "Grounding in Communication (Clark & Brennan, 1991)"
  },
  "repair_log": [
    "compilation_recovered_local_original"
  ],
  "repaired_at": "2026-02-28T13:41:48Z"
}