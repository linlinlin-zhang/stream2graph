{
  "id": "gl_block-beta_00324",
  "source": "gitlab",
  "source_url": "https://github.com/quantizor/markdown-to-jsx/blob/5c76b18bb5102b00ca77c8a4480da6e93d4765f4/lib/src/parser-spec.mmd",
  "source_note": "collected_from_github_additional",
  "github_repo": "quantizor/markdown-to-jsx",
  "diagram_type": "block-beta",
  "code": "sequenceDiagram\n    participant Input as Markdown Input\n    participant Phase1 as Phase 1: Block Structure\n    participant LineProcessor as Process Line\n    participant BlockChecker as Check Open Blocks\n    participant BlockParser as Block Parser\n    participant Phase2 as Phase 2: Inline Structure\n    participant TreeWalker as Walk Tree\n    participant InlineParser as Parse Inline\n    participant AST as Final AST\n\n    Input->>Phase1: Markdown text\n\n    loop For Each Line\n        Phase1->>LineProcessor: Process line sequentially\n\n        LineProcessor->>BlockChecker: Step 1: Check open blocks\n        Note over BlockChecker: Iterate from root to last open block<br/>Each block imposes continuation condition\n\n        BlockChecker->>BlockChecker: Match all or some open blocks\n        Note over BlockChecker: Cannot close unmatched yet<br/>May have lazy continuation\n\n        BlockChecker->>BlockParser: Step 2: Consume continuation markers\n        Note over BlockParser: >, list markers, indentation\n\n        BlockParser->>BlockParser: Look for new block starts\n\n        alt First non-space char\n            BlockParser->>BlockParser: Space/Tab: Indented path\n            Note over BlockParser: 1. Thematic Break 0-3 spaces<br/>2. Lists/Blockquote<br/>3. Code Block 4+ spaces\n        else >\n            BlockParser->>BlockParser: Block Quote (container)\n        else #\n            BlockParser->>BlockParser: ATX Heading (0-3 spaces indent)\n        else - * _\n            BlockParser->>BlockParser: Thematic Break (0-3 spaces, 3+ chars)<br/>(Note: setext > thematic when content exists)\n        else ` ~\n            BlockParser->>BlockParser: Fenced Code Block (0-3 spaces)\n        else - * + 0-9\n            BlockParser->>BlockParser: Unordered/Ordered List (container)\n        else <\n            BlockParser->>BlockParser: HTML Block (0-3 spaces, Type 1-7)\n        else |\n            BlockParser->>BlockParser: Table (GFM extension)<br/>Requires header row + delimiter row<br/>Delimiter row must match header cell count\n        else = -\n            BlockParser->>BlockParser: Setext Heading<br/>(PRECEDENCE: setext > thematic break)\n        else default\n            BlockParser->>BlockParser: Paragraph (leaf block)\n        end\n\n        BlockParser->>BlockParser: Close unmatched blocks from Step 1\n        BlockParser->>BlockParser: Create new block as child of last matched container\n\n        BlockParser->>BlockParser: Step 3: Process remainder\n        Note over BlockParser: Add text to last open block<br/>(Paragraph, Code Block, Heading, Raw HTML)<br/>or Table (GFM extension)\n\n        alt Paragraph + Setext underline?\n            BlockParser->>BlockParser: Convert paragraph to setext heading\n        else No\n            BlockParser->>BlockParser: Accumulate text in current block\n        end\n\n        BlockParser-->>LineProcessor: Block node created\n    end\n\n    Phase1->>Phase1: Close all open blocks\n    Phase1->>Phase1: For each list item:<br/>Check if first block is paragraph with task marker (GFM extension)<br/>[ ] or [x] or [X] at start of paragraph\n    Phase1->>Phase1: For each closed paragraph:<br/>Parse accumulated text lines\n    Phase1->>Phase1: Extract link reference definitions from start of text\n    Phase1->>Phase1: Remaining text becomes normal paragraph\n\n    Phase1->>Phase2: Block tree structure\n\n    Phase2->>TreeWalker: Walk the tree\n\n    loop Visit every node\n        TreeWalker->>TreeWalker: Check if node has inline content\n        Note over TreeWalker: Paragraph, Heading<br/>or Table Cell (GFM extension)\n\n        alt Has inline content?\n            TreeWalker->>InlineParser: Parse inline content (left to right)\n\n            loop Character-by-character\n                InlineParser->>InlineParser: Switch on character\n\n                alt backslash\n                    InlineParser->>InlineParser: Backslash escape\n                else `\n                    InlineParser->>InlineParser: Code span<br/>(Higher precedence than emphasis/links)\n                else <\n                    InlineParser->>InlineParser: Check angle bracket\n                    alt autolink (angle brackets)\n                        InlineParser->>InlineParser: Autolink (email or URL)<br/>Standard CommonMark autolinks<br/>(Same precedence as code spans and HTML tags)\n                    else HTML tag\n                        InlineParser->>InlineParser: HTML tag<br/>GFM extension: Disallowed Raw HTML<br/>(Same precedence as code spans and autolinks)\n                    else comment\n                        InlineParser->>InlineParser: HTML comment\n                    end\n                else www. or http:// or https:// or ftp:// or email\n                    InlineParser->>InlineParser: Extended autolink (GFM extension)<br/>www. URLs, http/https/ftp URLs, emails<br/>Only after start of line, whitespace, or * _ ~ (<br/>(Same precedence as code spans and HTML tags)\n                else * _\n                    InlineParser->>InlineParser: Emphasis delimiter<br/>Add to delimiter stack\n                    InlineParser->>InlineParser: Check left-flanking\n                    InlineParser->>InlineParser: Check right-flanking\n                    InlineParser->>InlineParser: Apply delimiter rules (9/10/11/12/13)\n                    InlineParser->>InlineParser: Parse nested content recursively\n                else ~\n                    InlineParser->>InlineParser: Strikethrough delimiter (GFM extension)<br/>Add to delimiter stack<br/>Requires exactly ~~ (two tildes) for strikethrough<br/>Similar parsing rules to emphasis\n                else !bracket\n                    InlineParser->>InlineParser: Image (add to delimiter stack)\n                else bracket\n                    InlineParser->>InlineParser: Link (add to delimiter stack)\n                else closing bracket\n                    InlineParser->>InlineParser: Look for link/image<br/>Process delimiter stack\n                    alt Reference link?\n                        InlineParser->>InlineParser: Resolve reference<br/>(All link refs available from Phase 1)\n                    else Inline link\n                        InlineParser->>InlineParser: Inline link\n                    end\n                else newline\n                    InlineParser->>InlineParser: Soft line break\n                else entity\n                    InlineParser->>InlineParser: HTML entity reference<br/>(decodeEntityReferences)\n                else default\n                    InlineParser->>InlineParser: Accumulate as text\n                end\n            end\n\n            InlineParser-->>TreeWalker: Inline AST nodes\n        end\n\n        TreeWalker->>TreeWalker: Next node\n    end\n\n    TreeWalker-->>Phase2: Complete tree with inline nodes\n    Phase2->>AST: Final AST document tree\n\n",
  "content_size": 6767,
  "collected_at": "2026-02-06T14:07:19.076963",
  "compilation_status": "success",
  "license": "gitlab_repo",
  "license_name": "GitLab Repository",
  "license_url": "https://gitlab.com",
  "compilation_error": "",
  "cscw_dialogue": [
    {
      "turn_id": 1,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 container 和 0-3 spaces indent 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 2,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'container 和 0-3 spaces indent'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 3,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 4,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Quote",
        "Heading"
      ],
      "is_repair": false
    },
    {
      "turn_id": 5,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 0-3 spaces, 3+ chars 和 0-3 spaces 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 6,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 '0-3 spaces, 3+ chars 和 0-3 spaces'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 7,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "没问题。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 8,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Break",
        "Block"
      ],
      "is_repair": false
    },
    {
      "turn_id": 9,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 container 和 0-3 spaces, Type 1-7。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 10,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'container 和 0-3 spaces, Type 1-7'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 11,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 12,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "List",
        "Block"
      ],
      "is_repair": false
    },
    {
      "turn_id": 13,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 GFM extension 和 leaf block 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 14,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "等等，我重新想了一下，应该是 GFM extension处理 才对。",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 15,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'GFM extension处理'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 16,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 17,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Table",
        "Paragraph"
      ],
      "is_repair": false
    },
    {
      "turn_id": 18,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 GFM extension 和 GFM extension 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 19,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'GFM extension 和 GFM extension'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 20,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 21,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Table",
        "marker"
      ],
      "is_repair": false
    },
    {
      "turn_id": 22,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 x 和 X。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 23,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'x 和 X'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 24,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 25,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "or",
        "or"
      ],
      "is_repair": false
    },
    {
      "turn_id": 26,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 GFM extension 和 left to right。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 27,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "收到。这是不是一个判断条件？我暂时写成 'GFM extension 和 left to right'。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 28,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 29,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Cell",
        "content"
      ],
      "is_repair": false
    },
    {
      "turn_id": 30,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "我们需要加一个处理 angle brackets 和 email or URL 的环节。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 31,
      "role": "Domain_Expert",
      "action_type": "repair",
      "utterance": "抱歉，稍微改一下，把刚才那个改成 angle brackets处理。",
      "elements_involved": [],
      "is_repair": true
    },
    {
      "turn_id": 32,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'angle brackets处理'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 33,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 34,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "autolink",
        "Autolink"
      ],
      "is_repair": false
    },
    {
      "turn_id": 35,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "然后，流程会走到 GFM extension 和 9/10/11/12/13。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 36,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "明白，所以它是承接上一步的，内容是 'GFM extension 和 9/10/11/12/13'？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 37,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "可以，继续吧。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 38,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "autolink",
        "rules"
      ],
      "is_repair": false
    },
    {
      "turn_id": 39,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "这里必须包含 GFM extension 和 add to delimiter stack 这一块。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 40,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "我把它加进去了，标签显示为 'GFM extension 和 add to delimiter stack'，你看看合适吗？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 41,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "对的，就这样。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 42,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "delimiter",
        "Image"
      ],
      "is_repair": false
    },
    {
      "turn_id": 43,
      "role": "Domain_Expert",
      "action_type": "propose",
      "utterance": "接下来是关于 add to delimiter stack 的逻辑。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 44,
      "role": "Diagram_Editor",
      "action_type": "clarify",
      "utterance": "好的，我把它画成一个矩形框，名字叫 'add to delimiter stack'，对吧？",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 45,
      "role": "Domain_Expert",
      "action_type": "confirm",
      "utterance": "嗯，这样看起来很清晰。",
      "elements_involved": [],
      "is_repair": false
    },
    {
      "turn_id": 46,
      "role": "Diagram_Editor",
      "action_type": "execute",
      "utterance": "[系统日志: Editor 更新了图表代码以反映上述结构]",
      "elements_involved": [
        "Link"
      ],
      "is_repair": false
    }
  ],
  "dialogue_metadata": {
    "total_turns": 46,
    "repair_count": 2,
    "grounding_acts_count": 22,
    "theoretical_framework": "Grounding in Communication (Clark & Brennan, 1991)"
  },
  "repair_log": [
    "compilation_recovered_local_original"
  ],
  "repaired_at": "2026-02-28T13:41:37Z"
}