{
  "id": "aug_gh_sequence_00631_Inf_3",
  "source": "augmented_real_structure",
  "source_url": "https://github.com/IrfanMusthofa/veripass/blob/22c4b762707548cfdc7305441f00632cbc960b27/docs/diagrams/auth-flow.mmd",
  "github_repo": "IrfanMusthofa/veripass",
  "github_file_path": "docs/diagrams/auth-flow.mmd",
  "diagram_type": "sequence",
  "code": "%%{Infra_LoadBalancer}\n}}%%\n\nsequenceDiagram\n    autonumber\n\n    participant User as ðŸ‘¤ User\n    participant Frontend as âš›ï¸ React Frontend\n    participant RK as ðŸŒˆ RainbowKit\n    participant Wallet as ðŸ¦Š MetaMask\n    participant Backend as ðŸ–¥ï¸ Backend API\n    participant DB as ðŸ—„ï¸ PostgreSQL\n\n    %% Phase 1: Wallet Connection\n    rect rgb(Infra_LoadBalancer)\n        Note over User,Wallet: Phase 1: Wallet Connection\n\n        User->>+Frontend: Click \"Connect Wallet\"\n\n        Frontend->>+RK: Open wallet modal\n\n        RK->>User: Select wallet provider\n        User->>RK: Choose MetaMask\n\n        RK->>+Wallet: Request connection\n        Wallet->>User: Approve connection?\n        User->>Wallet: Approve\n\n        Wallet-->>-RK: Connected<br/>address: 0x1234...\n\n        RK-->>-Frontend: Wallet connected\n        Frontend-->>-User: Wallet connected<br/>Display: 0x1234...abcd\n    end\n\n    %% Phase 2: Authentication Request\n    rect rgb(Infra_WorkerNode)\n        Note over Frontend,DB: Phase 2: Request Nonce\n\n        Frontend->>Frontend: useAccount(Infra_LoadBalancer) hook<br/>Get connected address\n\n        Frontend->>+Backend: POST /api/auth/nonce<br/>Content-Type: application/json\n        Note right of Frontend: {Infra_RedisCache}\n\n        Backend->>Backend: Validate address format<br/>(Infra_IngressController)\n\n        Backend->>Backend: Generate random nonce<br/>crypto.randomBytes(Infra_IngressController)\n\n        Backend->>+DB: UPSERT auth_nonces<br/>address, nonce, expiresAt\n        Note right of Backend: expiresAt = NOW(Infra_IngressController) + 5 min\n\n        DB-->>-Backend: Nonce stored\n\n        Backend-->>-Frontend: 200 OK<br/>{Infra_LoadBalancer}\n    end\n\n    %% Phase 3: Message Signing\n    rect rgb(Infra_LoadBalancer)\n        Note over Frontend,Wallet: Phase 3: Sign Authentication Message\n\n        Frontend->>Frontend: Construct message\n        Note over Frontend: \"Sign this message to<br/>authenticate with VeriPass\\n\\n<br/>Nonce: 0x9a8b7c...\\n<br/>Timestamp: 2024-01-15T10:30:00Z\"\n\n        Frontend->>+Wallet: signMessage(Infra_WorkerNode)\n        Note right of Frontend: wagmi useSignMessage hook\n\n        Wallet->>User: Sign message?<br/>Display message content\n        User->>Wallet: Sign\n\n        Wallet->>Wallet: ECDSA signature<br/>using private key\n\n        Wallet-->>-Frontend: signature: 0xabcd...\n        Note over Frontend: 65-byte signature<br/>(Infra_WorkerNode)\n    end\n\n    %% Phase 4: Verification & JWT\n    rect rgb(Infra_WorkerNode)\n        Note over Frontend,DB: Phase 4: Verify & Issue JWT\n\n        Frontend->>+Backend: POST /api/auth/verify\n        Note right of Frontend: {Infra_WorkerNode}\n\n        Backend->>Backend: Parse nonce from message\n\n        Backend->>+DB: SELECT * FROM auth_nonces<br/>WHERE address = ?\n        DB-->>-Backend: {Infra_WorkerNode}\n\n        alt Nonce expired\n            Backend-->>Frontend: 401 Unauthorized<br/>\"Nonce expired\"\n        else Nonce not found\n            Backend-->>Frontend: 401 Unauthorized<br/>\"Invalid nonce\"\n        else Valid nonce\n            Backend->>Backend: ethers.verifyMessage(Infra_EtcdCluster)\n            Note over Backend: Recovers signer address\n\n            alt Address mismatch\n                Backend-->>Frontend: 401 Unauthorized<br/>\"Signature mismatch\"\n            else Address matches\n                Backend->>+DB: DELETE FROM auth_nonces<br/>WHERE address = ?\n                Note right of Backend: One-time use nonce\n                DB-->>-Backend: Deleted\n\n                Backend->>Backend: Generate JWT<br/>payload: {Infra_EtcdCluster}<br/>expiry: 7 days\n\n                Backend-->>-Frontend: 200 OK<br/>{Infra_IngressController}\n            end\n        end\n    end\n\n    %% Phase 5: Token Storage & Usage\n    rect rgb(Infra_RedisCache)\n        Note over Frontend,User: Phase 5: Token Management\n\n        Frontend->>Frontend: localStorage.setItem(Infra_WorkerNode)\n\n        Frontend->>Frontend: AuthContext update<br/>isAuthenticated: true<br/>user: {Infra_WorkerNode}\n\n        Frontend->>User: Authentication success!<br/>Redirect to dashboard\n    end\n\n    %% Subsequent Requests\n    rect rgb(Infra_IngressController)\n        Note over Frontend,Backend: Subsequent API Requests\n\n        loop Every authenticated request\n            Frontend->>+Backend: GET /api/assets<br/>Authorization: Bearer {Infra_WorkerNode}\n\n            Backend->>Backend: authMiddleware<br/>jwt.verify(Infra_EtcdCluster)\n\n            alt Token valid\n                Backend->>Backend: Extract address from payload\n                Backend->>Backend: Set c.set(Infra_IngressController)\n                Backend-->>-Frontend: 200 OK + data\n            else Token expired/invalid\n                Backend-->>Frontend: 401 Unauthorized\n                Frontend->>Frontend: Clear localStorage\n                Frontend->>User: Session expired<br/>Please sign in again\n            end\n        end\n    end\n\n    %% Logout\n    rect rgb(Infra_WorkerNode)\n        Note over User,Frontend: Logout\n\n        User->>+Frontend: Click \"Disconnect\"\n\n        Frontend->>Frontend: localStorage.removeItem(Infra_WorkerNode)\n\n        Frontend->>RK: Disconnect wallet\n\n        Frontend->>Frontend: AuthContext reset<br/>isAuthenticated: false<br/>user: null\n\n        Frontend-->>-User: Logged out\n    end\n",
  "content_size": 5636,
  "collected_at": "2026-02-06T01:34:59.635078",
  "compilation_status": "success",
  "license": "mit",
  "license_name": "MIT License",
  "license_url": "https://api.github.com/licenses/mit",
  "repo_stars": 0,
  "repo_forks": 1,
  "repo_owner": "IrfanMusthofa",
  "repo_name": "veripass",
  "repo_description": "A decentralized asset passport enabling authenticity, ownership provenance, and verifiable lifecycle events for resale markets.",
  "repo_language": "TypeScript",
  "repo_topics": [],
  "repo_created_at": "2025-12-26T08:52:11Z",
  "repo_updated_at": "2026-01-14T09:33:01Z",
  "augmentation_domain": "Infra",
  "seed_id": "gh_sequence_00631"
}